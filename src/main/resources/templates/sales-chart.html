<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒë§¤ì‹¤ì ì¶”ì´ ê·¸ë˜í”„ | ì¿ íŒ¡ì…€ëŸ¬ íŒë§¤ ë°ì´í„° ë¶„ì„</title>
    <link rel="canonical" th:href="@{/sales-chart}">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Flatpickr (ë‚ ì§œ ì„ íƒ ë¼ì´ë¸ŒëŸ¬ë¦¬) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: hsl(330, 80%, 55%);
            --primary-foreground: hsl(0, 0%, 100%);
            --secondary: hsl(330, 100%, 97%);
            --secondary-foreground: hsl(330, 80%, 40%);
            --background: hsl(0, 0%, 100%);
            --foreground: hsl(220, 15%, 20%);
            --card: hsl(0, 0%, 100%);
            --muted: hsl(220, 15%, 96%);
            --muted-foreground: hsl(220, 10%, 50%);
            --border: hsl(220, 15%, 90%);
            --success: hsl(140, 60%, 50%);
            --radius: 0.75rem;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background);
            color: var(--foreground);
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background-color: var(--card);
            border-right: 1px solid var(--border);
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 1.5rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background-color: var(--primary);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg {
            width: 24px;
            height: 24px;
            stroke: var(--primary-foreground);
        }

        .logo-text h2 {
            font-weight: bold;
            font-size: 1rem;
            color: var(--foreground);
        }

        .logo-text p {
            font-size: 0.75rem;
            color: var(--muted-foreground);
        }

        .nav {
            padding: 0 1.5rem 1.5rem;
        }

        .nav-section {
            margin-bottom: 0.5rem;
        }

        .nav-item {
            padding: 0.75rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            color: var(--foreground);
            text-decoration: none;
            display: block;
            transition: background-color 0.2s;
        }

        .nav-item:hover {
            background-color: var(--muted);
        }

        .nav-item.active {
            background-color: var(--secondary);
            color: var(--secondary-foreground);
            font-weight: 600;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
        }

        .content-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-header h1 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: var(--foreground);
        }

        .section {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .section h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: var(--foreground);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--foreground);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .data-paste-area {
            min-height: 300px;
            font-family: monospace;
            font-size: 0.875rem;
            resize: vertical;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            font-size: 0.875rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: var(--primary-foreground);
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            opacity: 0.9;
        }

        .form-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        /* Filter Section */
        .filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            flex: 0 0 auto;
            min-width: 150px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--foreground);
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-family: inherit;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .input-mode-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: var(--muted);
            border-radius: var(--radius);
        }

        .input-mode-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background-color: var(--card);
            color: var(--foreground);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .input-mode-btn.active {
            background-color: var(--primary);
            color: var(--primary-foreground);
            border-color: var(--primary);
        }

        .input-mode-btn:hover {
            background-color: var(--secondary);
        }

        .radio-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            user-select: none;
        }

        .radio-label input[type="radio"] {
            width: auto;
            margin: 0;
            cursor: pointer;
        }

        .radio-label span {
            color: var(--foreground);
        }

        .radio-label:hover span {
            color: var(--primary);
        }

        .checkbox-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            user-select: none;
        }

        .checkbox-label input[type="checkbox"] {
            width: auto;
            margin: 0;
            cursor: pointer;
        }

        .checkbox-label span {
            color: var(--foreground);
        }

        .checkbox-label:hover span {
            color: var(--primary);
        }

        .checkbox-label input[type="checkbox"]:disabled + span {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .direct-input-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .direct-input-table th,
        .direct-input-table td {
            padding: 0.5rem;
            border: 1px solid var(--border);
            text-align: left;
            font-size: 0.875rem;
        }

        .direct-input-table th {
            background-color: var(--muted);
            font-weight: 600;
        }

        .direct-input-table input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: calc(var(--radius) / 2);
            font-size: 0.875rem;
        }

        .direct-input-table input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .direct-input-table input[readonly] {
            background-color: var(--muted);
            cursor: not-allowed;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 2rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background-color: var(--secondary);
            border-radius: var(--radius);
            margin-bottom: 2rem;
        }

        .user-info span {
            font-size: 0.875rem;
            color: var(--secondary-foreground);
            font-weight: 600;
        }

        .logout-btn {
            padding: 0.5rem 1rem;
            background-color: var(--primary);
            color: var(--primary-foreground);
            border: none;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .logout-btn:hover {
            opacity: 0.9;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }

            .content-wrapper {
                padding: 1rem;
            }

            .filter-section {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
                min-width: auto;
            }

            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="/" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 0.75rem;">
                <div class="logo">
                    <div class="logo-icon">
                        <svg fill="none" stroke-width="2" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                        </svg>
                    </div>
                    <div class="logo-text">
                        <h2>ì¿ íŒ¡ ë°ì´í„°</h2>
                        <p>íŒë§¤ ê¸°ë¡ ë¶„ì„</p>
                    </div>
                </div>
            </a>

            <nav class="nav">
                <div class="nav-section">
                    <a href="/dropshipping-guide" class="nav-item">ğŸ“¦ ìœ„íƒíŒë§¤ ê°€ì´ë“œ</a>
                </div>
                <div class="nav-section">
                    <a href="/sales-chart" class="nav-item active">ğŸ“Š íŒë§¤ì‹¤ì ì¶”ì´ ê·¸ë˜í”„</a>
                </div>
            </nav>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-wrapper">
            <div class="page-header">
                <h1>íŒë§¤ì‹¤ì ì¶”ì´ ê·¸ë˜í”„</h1>
            </div>

            <!-- User Info -->
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="userInfoText">ì‚¬ìš©ì: </span>
                <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <!-- Data Input Section -->
            <div class="section" id="dataInputSection" style="display: none;">
                <h2>ë°ì´í„° ì…ë ¥</h2>
                
                <!-- ì…ë ¥ ë°©ì‹ ì„ íƒ -->
                <div class="input-mode-toggle">
                    <button class="input-mode-btn active" id="pasteModeBtn" onclick="switchInputMode('paste')">ë¶™ì—¬ë„£ê¸°</button>
                    <button class="input-mode-btn" id="directModeBtn" onclick="switchInputMode('direct')">ì§ì ‘ì…ë ¥</button>
                </div>

                <!-- ë¶™ì—¬ë„£ê¸° ëª¨ë“œ -->
                <div id="pasteMode" class="input-mode-content">
                    <div class="form-group">
                        <label for="dataPaste">ì‹œê°„ë³„ íŒë§¤ ë°ì´í„° (ë¶™ì—¬ë„£ê¸°)</label>
                        <textarea id="dataPaste" class="data-paste-area" placeholder="ë°ì´í„° ì¶”ì¶œì¼ì : 1ì›”18ì¼ (ì¼) | ìƒí’ˆë²ˆí˜¸ : 15915369884
ì‹œê°„   íŒë§¤ëŸ‰(ì¶”ì •)   ë§¤ì¶œ KRW(ì¶”ì •)
00h   0.00   0
02h   0.00   0
04h   0.00   0
06h   0.00   0
08h   0.00   0
10h   1.00   10900
12h   0.00   0
14h   1.00   10900
16h   0.00   0
18h   0.00   0
20h   2.00   19800
22h   0.00   0"></textarea>
                        <small style="color: var(--muted-foreground); font-size: 0.75rem; margin-top: 0.5rem; display: block;">
                            í—¤ë”(ë°ì´í„° ì¶”ì¶œì¼ì, ìƒí’ˆë²ˆí˜¸)ë¥¼ í¬í•¨í•œ ì „ì²´ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
                        </small>
                    </div>
                </div>

                <!-- ì§ì ‘ì…ë ¥ ëª¨ë“œ -->
                <div id="directMode" class="input-mode-content" style="display: none;">
                    <div class="form-group">
                        <label for="directExtractDate">ë°ì´í„° ì¶”ì¶œì¼ì</label>
                        <input type="text" id="directExtractDate" placeholder="ì˜ˆ: 1ì›”18ì¼ (ì¼)">
                    </div>
                    <div class="form-group">
                        <label for="directProductNumber">ìƒí’ˆë²ˆí˜¸</label>
                        <input type="text" id="directProductNumber" placeholder="ì˜ˆ: 15915369884">
                    </div>
                    <table class="direct-input-table">
                        <thead>
                            <tr>
                                <th style="width: 100px;">ì‹œê°„</th>
                                <th>íŒë§¤ëŸ‰(ì¶”ì •)</th>
                                <th>ë§¤ì¶œ KRW(ì¶”ì •)</th>
                            </tr>
                        </thead>
                        <tbody id="directInputTableBody">
                            <tr>
                                <td><input type="text" value="00h" readonly></td>
                                <td><input type="number" step="0.01" class="direct-sales" placeholder="0.00"></td>
                                <td><input type="number" class="direct-revenue" placeholder="0"></td>
                            </tr>
                            <tr>
                                <td><input type="text" value="02h" readonly></td>
                                <td><input type="number" step="0.01" class="direct-sales" placeholder="0.00"></td>
                                <td><input type="number" class="direct-revenue" placeholder="0"></td>
                            </tr>
                            <tr>
                                <td><input type="text" value="04h" readonly></td>
                                <td><input type="number" step="0.01" class="direct-sales" placeholder="0.00"></td>
                                <td><input type="number" class="direct-revenue" placeholder="0"></td>
                            </tr>
                            <tr>
                                <td><input type="text" value="06h" readonly></td>
                                <td><input type="number" step="0.01" class="direct-sales" placeholder="0.00"></td>
                                <td><input type="number" class="direct-revenue" placeholder="0"></td>
                            </tr>
                            <tr>
                                <td><input type="text" value="08h" readonly></td>
                                <td><input type="number" step="0.01" class="direct-sales" placeholder="0.00"></td>
                                <td><input type="number" class="direct-revenue" placeholder="0"></td>
                            </tr>
                            <tr>
                                <td><input type="text" value="10h" readonly></td>
                                <td><input type="number" step="0.01" class="direct-sales" placeholder="0.00"></td>
                                <td><input type="number" class="direct-revenue" placeholder="0"></td>
                            </tr>
                            <tr>
                                <td><input type="text" value="12h" readonly></td>
                                <td><input type="number" step="0.01" class="direct-sales" placeholder="0.00"></td>
                                <td><input type="number" class="direct-revenue" placeholder="0"></td>
                            </tr>
                            <tr>
                                <td><input type="text" value="14h" readonly></td>
                                <td><input type="number" step="0.01" class="direct-sales" placeholder="0.00"></td>
                                <td><input type="number" class="direct-revenue" placeholder="0"></td>
                            </tr>
                            <tr>
                                <td><input type="text" value="16h" readonly></td>
                                <td><input type="number" step="0.01" class="direct-sales" placeholder="0.00"></td>
                                <td><input type="number" class="direct-revenue" placeholder="0"></td>
                            </tr>
                            <tr>
                                <td><input type="text" value="18h" readonly></td>
                                <td><input type="number" step="0.01" class="direct-sales" placeholder="0.00"></td>
                                <td><input type="number" class="direct-revenue" placeholder="0"></td>
                            </tr>
                            <tr>
                                <td><input type="text" value="20h" readonly></td>
                                <td><input type="number" step="0.01" class="direct-sales" placeholder="0.00"></td>
                                <td><input type="number" class="direct-revenue" placeholder="0"></td>
                            </tr>
                            <tr>
                                <td><input type="text" value="22h" readonly></td>
                                <td><input type="number" step="0.01" class="direct-sales" placeholder="0.00"></td>
                                <td><input type="number" class="direct-revenue" placeholder="0"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="form-actions">
                    <button class="btn btn-success" onclick="saveData()">ì €ì¥í•˜ê¸°</button>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="section" id="chartSection" style="display: none;">
                <h2>íŒë§¤ ë°ì´í„° ë¶„ì„</h2>
                
                <!-- Filter -->
                <div class="filter-section">
                    <div class="filter-group">
                        <label for="filterType">ì¡°íšŒ ë°©ì‹</label>
                        <select id="filterType" onchange="changeFilterType()">
                            <option value="range">ê¸°ê°„ë³„</option>
                            <option value="date">ë‚ ì§œë³„</option>
                        </select>
                    </div>
                    <div class="filter-group" id="dateFilter" style="display: none;">
                        <label for="filterDate">ì¶”ì¶œì¼ì</label>
                        <input type="text" id="filterDate" placeholder="ë‚ ì§œ ì„ íƒ">
                    </div>
                    <div class="filter-group" id="rangeFilter">
                        <label for="startDate">ì‹œì‘ì¼</label>
                        <input type="text" id="startDate" placeholder="ë‚ ì§œ ì„ íƒ">
                    </div>
                    <div class="filter-group" id="endDateFilter">
                        <label for="endDate">ì¢…ë£Œì¼</label>
                        <input type="text" id="endDate" placeholder="ë‚ ì§œ ì„ íƒ">
                    </div>
                    <div class="filter-group">
                        <label for="filterProduct">ìƒí’ˆë²ˆí˜¸</label>
                        <select id="filterProduct">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                    <div class="filter-group" style="flex: 0 0 auto;">
                        <button class="btn btn-primary" onclick="loadChartData()" style="padding: 0.75rem 1.5rem; margin-top: 0;">ì¡°íšŒ</button>
                    </div>
                </div>
                
                <!-- Day Filter (ê¸°ê°„ë³„ ì¡°íšŒì¼ ë•Œë§Œ í‘œì‹œ) -->
                <div id="dayFilterSection" style="margin-top: 1rem; padding: 1rem; background-color: var(--muted); border-radius: var(--radius);">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ìš”ì¼ í•„í„° (ì—¬ëŸ¬ ìš”ì¼ ì„ íƒ ê°€ëŠ¥)</label>
                        <div class="checkbox-group" style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                            <label class="checkbox-label">
                                <input type="checkbox" name="dayFilter" value="ì›”" onchange="updateDayFilter()">
                                <span>ì›”ìš”ì¼</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="dayFilter" value="í™”" onchange="updateDayFilter()">
                                <span>í™”ìš”ì¼</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="dayFilter" value="ìˆ˜" onchange="updateDayFilter()">
                                <span>ìˆ˜ìš”ì¼</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="dayFilter" value="ëª©" onchange="updateDayFilter()">
                                <span>ëª©ìš”ì¼</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="dayFilter" value="ê¸ˆ" onchange="updateDayFilter()">
                                <span>ê¸ˆìš”ì¼</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="dayFilter" value="í† " onchange="updateDayFilter()">
                                <span>í† ìš”ì¼</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="dayFilter" value="ì¼" onchange="updateDayFilter()">
                                <span>ì¼ìš”ì¼</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Chart -->
                <div class="chart-container">
                    <canvas id="salesChart"></canvas>
                </div>
                
                <!-- Revenue Summary -->
                <div id="revenueSummary" style="margin-top: 1.5rem; padding: 1rem; background-color: var(--muted); border-radius: var(--radius); display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; font-size: 1rem;">ë§¤ì¶œ í•©ê³„:</span>
                        <span id="totalRevenue" style="font-weight: bold; font-size: 1.25rem; color: var(--primary);">0ì›</span>
                    </div>
                </div>
            </div>

            <!-- Login Section -->
            <div class="section" id="loginSection">
                <h2>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
                <p>íŒë§¤ì‹¤ì ì¶”ì´ ê·¸ë˜í”„ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                <button class="btn btn-primary" onclick="window.location.href='/'">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            </div>
        </div>
    </main>
</div>

<script>
    let chart = null;
    const userId = localStorage.getItem('salesChart_userId');

    // í˜ì´ì§€ ë¡œë“œ ì‹œ
    window.addEventListener('load', function() {
        if (userId) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dataInputSection').style.display = 'block';
            document.getElementById('chartSection').style.display = 'block';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('userInfoText').textContent = 'ì‚¬ìš©ì: ' + userId;
            
            loadExtractDates();
            loadProductNumbers();
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ë°ì´í„° ë¡œë“œí•˜ì§€ ì•ŠìŒ
            
            // ë‚ ì§œ ì„ íƒ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ˆê¸°í™”
            initDatePickers();
            
            // í•„í„° íƒ€ì…ì— ë”°ë¼ ìš”ì¼ í•„í„° í‘œì‹œ/ìˆ¨ê¹€
            changeFilterType();
        } else {
            // ë¡œê·¸ì¸ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ í™ˆìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
            window.location.href = '/';
        }
    });

    // ì…ë ¥ ë°©ì‹ ì „í™˜
    function switchInputMode(mode) {
        const pasteMode = document.getElementById('pasteMode');
        const directMode = document.getElementById('directMode');
        const pasteModeBtn = document.getElementById('pasteModeBtn');
        const directModeBtn = document.getElementById('directModeBtn');
        
        if (mode === 'paste') {
            pasteMode.style.display = 'block';
            directMode.style.display = 'none';
            pasteModeBtn.classList.add('active');
            directModeBtn.classList.remove('active');
        } else {
            pasteMode.style.display = 'none';
            directMode.style.display = 'block';
            pasteModeBtn.classList.remove('active');
            directModeBtn.classList.add('active');
        }
    }

    // ë‚ ì§œ ì„ íƒ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ˆê¸°í™”
    function initDatePickers() {
        // ë‚ ì§œë³„ ì¡°íšŒìš© ë‚ ì§œ ì„ íƒê¸° (ìˆ˜ë™ ì…ë ¥ í—ˆìš©)
        if (document.getElementById('filterDate')) {
            flatpickr("#filterDate", {
                locale: "ko",
                allowInput: true,
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "Yë…„ mì›” dì¼"
            });
        }

        // ê¸°ê°„ë³„ ì¡°íšŒìš© ë‚ ì§œ ì„ íƒê¸°
        if (document.getElementById('startDate')) {
            flatpickr("#startDate", {
                locale: "ko",
                allowInput: true,
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "Yë…„ mì›” dì¼"
            });
        }

        if (document.getElementById('endDate')) {
            flatpickr("#endDate", {
                locale: "ko",
                allowInput: true,
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "Yë…„ mì›” dì¼"
            });
        }
    }

    // SQL ì¸ì ì…˜ ë° XSS ê²€ì‚¬ í•¨ìˆ˜
    function containsSqlInjection(input) {
        if (!input) return false;
        const sqlPattern = /(\b(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER|EXEC|EXECUTE|UNION|SCRIPT|--|\/\*|\*\/|;|'|"|`|\*|%|_|\||&|\^|~|\[|\]|\{|\}|<|>)\b)/gi;
        return sqlPattern.test(input);
    }
    
    function containsXss(input) {
        if (!input) return false;
        const xssPattern = /(<script|<\/script>|<iframe|<\/iframe>|<object|<\/object>|<embed|<\/embed>|javascript:|onerror=|onclick=|onload=|onmouseover=|onfocus=|onblur=)/gi;
        return xssPattern.test(input);
    }
    
    function sanitizeInput(input) {
        if (!input) return input;
        return input.replace(/[<>"'`;\\]/g, '');
    }
    
    function isValidProductNumber(productNumber) {
        if (!productNumber) return false;
        return /^[0-9]{1,20}$/.test(productNumber);
    }
    
    function isValidExtractDate(date) {
        if (!date) return false;
        return /^\d{1,2}ì›”\d{1,2}ì¼(\s*\([ì›”í™”ìˆ˜ëª©ê¸ˆí† ì¼]\))?$/.test(date);
    }
    
    function isValidTime(time) {
        if (!time) return false;
        return /^(0[02468]|1[02468]|2[02])h$/.test(time);
    }

    // ë°ì´í„° ì €ì¥
    async function saveData() {
        const pasteMode = document.getElementById('pasteMode').style.display !== 'none';
        let extractDate, productNumber, dataList;

        if (pasteMode) {
            // ë¶™ì—¬ë„£ê¸° ëª¨ë“œ
            const dataPaste = document.getElementById('dataPaste').value.trim();
            if (!dataPaste) {
                alert('ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // SQL ì¸ì ì…˜ ë° XSS ê²€ì‚¬
            if (containsSqlInjection(dataPaste) || containsXss(dataPaste)) {
                alert('ì…ë ¥ê°’ì— í—ˆìš©ë˜ì§€ ì•Šì€ ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            // í—¤ë”ì—ì„œ ì¶”ì¶œì¼ìì™€ ìƒí’ˆë²ˆí˜¸ íŒŒì‹±
            const lines = dataPaste.split('\n').filter(line => line.trim());
            if (lines.length === 0) {
                alert('ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì²« ë²ˆì§¸ ì¤„ì—ì„œ ì¶”ì¶œì¼ìì™€ ìƒí’ˆë²ˆí˜¸ ì¶”ì¶œ
            const headerLine = lines[0];
            const extractDateMatch = headerLine.match(/ë°ì´í„° ì¶”ì¶œì¼ì\s*:\s*([^|]+)/);
            const productNumberMatch = headerLine.match(/ìƒí’ˆë²ˆí˜¸\s*:\s*(\d+)/);

            if (!extractDateMatch || !productNumberMatch) {
                alert('í—¤ë” í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\nì˜ˆ: ë°ì´í„° ì¶”ì¶œì¼ì : 1ì›”18ì¼ (ì¼) | ìƒí’ˆë²ˆí˜¸ : 15915369884');
                return;
            }

            extractDate = extractDateMatch[1].trim();
            productNumber = productNumberMatch[1].trim();
            
            // ì…ë ¥ê°’ ê²€ì¦
            if (containsSqlInjection(extractDate) || containsXss(extractDate)) {
                alert('ë‚ ì§œì— í—ˆìš©ë˜ì§€ ì•Šì€ ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!isValidExtractDate(extractDate)) {
                alert('ë‚ ì§œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì˜ˆ: 1ì›”26ì¼ (ì¼))');
                return;
            }
            
            if (containsSqlInjection(productNumber) || containsXss(productNumber)) {
                alert('ìƒí’ˆë²ˆí˜¸ì— í—ˆìš©ë˜ì§€ ì•Šì€ ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!isValidProductNumber(productNumber)) {
                alert('ìƒí’ˆë²ˆí˜¸ëŠ” ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            // ë°ì´í„° íŒŒì‹± (í—¤ë” ì œì™¸)
            dataList = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                // í—¤ë” ë¼ì¸ ìŠ¤í‚µ
                if (line.includes('ì‹œê°„') || line.includes('íŒë§¤ëŸ‰') || line.includes('ë§¤ì¶œ')) {
                    continue;
                }
                
                // SQL ì¸ì ì…˜ ë° XSS ê²€ì‚¬
                if (containsSqlInjection(line) || containsXss(line)) {
                    alert('ë°ì´í„°ì— í—ˆìš©ë˜ì§€ ì•Šì€ ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const parts = line.split(/\s+/);
                if (parts.length >= 3) {
                    const time = parts[0].trim();
                    const sales = parts[1].trim();
                    const revenue = parts[2].trim();
                    
                    // ì‹œê°„ í˜•ì‹ ê²€ì¦
                    if (!isValidTime(time)) {
                        alert(`ì‹œê°„ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: ${time}`);
                        return;
                    }
                    
                    if (time && !isNaN(parseFloat(sales)) && !isNaN(parseFloat(revenue))) {
                        dataList.push({
                            time: sanitizeInput(time),
                            sales: parseFloat(sales),
                            revenue: parseInt(revenue)
                        });
                    }
                }
            }
        } else {
            // ì§ì ‘ì…ë ¥ ëª¨ë“œ
            extractDate = document.getElementById('directExtractDate').value.trim();
            productNumber = document.getElementById('directProductNumber').value.trim();

            if (!extractDate || !productNumber) {
                alert('ë°ì´í„° ì¶”ì¶œì¼ìì™€ ìƒí’ˆë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì…ë ¥ê°’ ê²€ì¦
            if (containsSqlInjection(extractDate) || containsXss(extractDate)) {
                alert('ë‚ ì§œì— í—ˆìš©ë˜ì§€ ì•Šì€ ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!isValidExtractDate(extractDate)) {
                alert('ë‚ ì§œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì˜ˆ: 1ì›”26ì¼ (ì¼))');
                return;
            }
            
            if (containsSqlInjection(productNumber) || containsXss(productNumber)) {
                alert('ìƒí’ˆë²ˆí˜¸ì— í—ˆìš©ë˜ì§€ ì•Šì€ ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!isValidProductNumber(productNumber)) {
                alert('ìƒí’ˆë²ˆí˜¸ëŠ” ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            // í…Œì´ë¸”ì—ì„œ ë°ì´í„° ìˆ˜ì§‘
            dataList = [];
            const rows = document.querySelectorAll('#directInputTableBody tr');
            rows.forEach(row => {
                const timeInput = row.querySelector('td:first-child input');
                const salesInput = row.querySelector('.direct-sales');
                const revenueInput = row.querySelector('.direct-revenue');
                
                const time = timeInput.value.trim();
                const sales = parseFloat(salesInput.value) || 0;
                const revenue = parseInt(revenueInput.value) || 0;
                
                // ì‹œê°„ í˜•ì‹ ê²€ì¦
                if (time && !isValidTime(time)) {
                    alert(`ì‹œê°„ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: ${time}`);
                    return;
                }

                if (time) {
                    dataList.push({
                        time: sanitizeInput(time),
                        sales: sales,
                        revenue: revenue
                    });
                }
            });
        }

        if (dataList.length === 0) {
            alert('íŒë§¤ ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        try {
            const response = await fetch('/api/sales-chart/data/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId: userId,
                    extractDate: extractDate,
                    productNumber: productNumber,
                    dataList: dataList
                })
            });

            const result = await response.json();
            
            if (result.success) {
                alert('ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                if (pasteMode) {
                    document.getElementById('dataPaste').value = '';
                } else {
                    document.getElementById('directExtractDate').value = '';
                    document.getElementById('directProductNumber').value = '';
                    document.querySelectorAll('.direct-sales, .direct-revenue').forEach(input => {
                        input.value = '';
                    });
                }
                
                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadExtractDates();
                loadProductNumbers();
                loadChartData();
            } else {
                alert(result.message || 'ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:', error);
            alert('ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ì¶”ì¶œì¼ì ëª©ë¡ ë¡œë“œ
    async function loadExtractDates() {
        try {
            const response = await fetch(`/api/sales-chart/data/dates?userId=${userId}`);
            const result = await response.json();
            
            if (result.success && result.dates) {
                // ë‚ ì§œ ì„ íƒê¸°ì— ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì²˜ë¦¬
                // í•„ìš”ì‹œ ë“œë¡­ë‹¤ìš´ì—ë„ ì¶”ê°€ ê°€ëŠ¥
            }
        } catch (error) {
            console.error('ì¶”ì¶œì¼ì ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
        }
    }

    // ìƒí’ˆë²ˆí˜¸ ëª©ë¡ ë¡œë“œ
    async function loadProductNumbers() {
        try {
            const response = await fetch(`/api/sales-chart/data/products?userId=${userId}`);
            const result = await response.json();
            
            if (result.success) {
                const select = document.getElementById('filterProduct');
                select.innerHTML = '<option value="">ì „ì²´</option>';
                if (result.products && result.products.length > 0) {
                    result.products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product;
                        option.textContent = product;
                        select.appendChild(option);
                    });
                }
            }
        } catch (error) {
            console.error('ìƒí’ˆë²ˆí˜¸ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
        }
    }

    // í•„í„° íƒ€ì… ë³€ê²½
    function changeFilterType() {
        const filterType = document.getElementById('filterType').value;
        document.getElementById('dateFilter').style.display = filterType === 'date' ? 'block' : 'none';
        document.getElementById('rangeFilter').style.display = filterType === 'range' ? 'block' : 'none';
        document.getElementById('endDateFilter').style.display = filterType === 'range' ? 'block' : 'none';
        // ê¸°ê°„ë³„ ì¡°íšŒì¼ ë•Œë§Œ ìš”ì¼ í•„í„° í‘œì‹œ
        document.getElementById('dayFilterSection').style.display = filterType === 'range' ? 'block' : 'none';
    }
    
    // ìš”ì¼ í•„í„° ì—…ë°ì´íŠ¸ (ì²´í¬ë°•ìŠ¤ ê¸°ë°˜)
    function updateDayFilter() {
        // ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ìë™ìœ¼ë¡œ ì°¨íŠ¸ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œí•˜ì§€ ì•ŠìŒ
        // ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ë°ì´í„° ë¡œë“œ
    }

    // ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ
    async function loadChartData() {
        const filterType = document.getElementById('filterType').value;
        const productNumber = document.getElementById('filterProduct').value;
        let url = `/api/sales-chart/data?userId=${userId}`;

        // ìƒí’ˆë²ˆí˜¸ í•„í„° ì¶”ê°€
        if (productNumber && productNumber !== 'ì „ì²´') {
            url += `&productNumber=${encodeURIComponent(productNumber)}`;
        }

        if (filterType === 'date') {
            const dateInput = document.getElementById('filterDate');
            let date = '';
            if (dateInput) {
                // Flatpickrì˜ ì‹¤ì œ ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸° (Y-m-d í˜•ì‹)
                if (dateInput._flatpickr) {
                    date = dateInput._flatpickr.input.value || '';
                } else {
                    date = dateInput.value || '';
                }
            }
            if (date) {
                // Y-m-d í˜•ì‹ì„ "mì›”dì¼" í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                const convertDate = (dateStr) => {
                    if (!dateStr) return dateStr;
                    // "2026-01-26" í˜•ì‹ íŒŒì‹±
                    const parts = dateStr.split('-');
                    if (parts.length === 3) {
                        const year = parseInt(parts[0]);
                        const month = parseInt(parts[1]);
                        const day = parseInt(parts[2]);
                        return `${month}ì›”${day}ì¼`;
                    }
                    return dateStr;
                };
                
                const convertedDate = convertDate(date);
                url += `&extractDate=${encodeURIComponent(convertedDate)}`;
            }
        } else if (filterType === 'range') {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            let startDate = '';
            let endDate = '';
            
            if (startDateInput) {
                // Flatpickrì˜ ì‹¤ì œ ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸° (Y-m-d í˜•ì‹)
                if (startDateInput._flatpickr) {
                    startDate = startDateInput._flatpickr.input.value || '';
                } else {
                    startDate = startDateInput.value || '';
                }
            }
            
            if (endDateInput) {
                // Flatpickrì˜ ì‹¤ì œ ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸° (Y-m-d í˜•ì‹)
                if (endDateInput._flatpickr) {
                    endDate = endDateInput._flatpickr.input.value || '';
                } else {
                    endDate = endDateInput.value || '';
                }
            }
            
            if (startDate && endDate) {
                // Y-m-d í˜•ì‹ì„ "mì›”dì¼" í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                const convertDate = (dateStr) => {
                    if (!dateStr) return dateStr;
                    // "2026-01-26" í˜•ì‹ íŒŒì‹±
                    const parts = dateStr.split('-');
                    if (parts.length === 3) {
                        const year = parseInt(parts[0]);
                        const month = parseInt(parts[1]);
                        const day = parseInt(parts[2]);
                        return `${month}ì›”${day}ì¼`;
                    }
                    // "2026ë…„ 01ì›” 26ì¼" í˜•ì‹ë„ ì²˜ë¦¬
                    const match = dateStr.match(/(\d+)ë…„\s*(\d+)ì›”\s*(\d+)ì¼/);
                    if (match) {
                        const year = parseInt(match[1]);
                        const month = parseInt(match[2]);
                        const day = parseInt(match[3]);
                        return `${month}ì›”${day}ì¼`;
                    }
                    return dateStr;
                };
                
                const convertedStartDate = convertDate(startDate);
                const convertedEndDate = convertDate(endDate);
                url += `&startDate=${encodeURIComponent(convertedStartDate)}&endDate=${encodeURIComponent(convertedEndDate)}`;
            }
            
            // ìš”ì¼ í•„í„° ì¶”ê°€ (ì²´í¬ë°•ìŠ¤ ê¸°ë°˜ - ì—¬ëŸ¬ ìš”ì¼ ì„ íƒ ê°€ëŠ¥)
            const checkedDays = Array.from(document.querySelectorAll('input[name="dayFilter"]:checked'))
                .map(checkbox => checkbox.value);
            
            if (checkedDays.length > 0) {
                // ì—¬ëŸ¬ ìš”ì¼ì„ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì „ì†¡
                url += `&dayFilter=${encodeURIComponent(checkedDays.join(','))}`;
            }
        }

        try {
            const response = await fetch(url);
            const result = await response.json();
            
            if (result.success && result.data) {
                drawChart(result.data);
            } else {
                alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            alert('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
    function drawChart(data) {
        const ctx = document.getElementById('salesChart').getContext('2d');
        
        if (!data || data.length === 0) {
            if (chart) {
                chart.destroy();
            }
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.font = '16px Arial';
            ctx.fillStyle = '#666';
            ctx.textAlign = 'center';
            ctx.fillText('í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }

        // ëª¨ë“  ì‹œê°„ ì¶”ì¶œ (00h, 02h, 04h, ... 22h)
        const allTimes = ['00h', '02h', '04h', '06h', '08h', '10h', '12h', '14h', '16h', '18h', '20h', '22h'];
        
        // ë‚ ì§œë³„ë¡œ ë°ì´í„° ê·¸ë£¹í™” (ìš”ì¼ ì •ë³´ í¬í•¨)
        const dateMap = new Map();
        data.forEach(item => {
            const date = item.extractDate || 'ê¸°íƒ€';
            const dayOfWeek = item.dayOfWeek || '';
            if (!dateMap.has(date)) {
                dateMap.set(date, {
                    dayOfWeek: dayOfWeek,
                    timeMap: new Map()
                });
            }
            const timeMap = dateMap.get(date).timeMap;
            const time = item.time;
            if (!timeMap.has(time)) {
                timeMap.set(time, []);
            }
            timeMap.get(time).push(item);
        });

        // Xì¶• ë ˆì´ë¸”ì„ ì‹œê°„ ë²”ìœ„ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (00h-02h, 02h-04h, ...)
        const labels = allTimes.map((time, index) => {
            const currentHour = parseInt(time.replace('h', ''));
            const nextHour = currentHour + 2;
            if (nextHour >= 24) {
                return `${time}-22h`;
            }
            const nextTime = nextHour.toString().padStart(2, '0') + 'h';
            return `${time}-${nextTime}`;
        });

        // ë‚ ì§œë³„ ìƒ‰ìƒ ì •ì˜
        const colors = [
            'rgb(229, 36, 117)',   // í•‘í¬
            'rgb(59, 130, 246)',   // íŒŒë‘
            'rgb(34, 197, 94)',    // ì´ˆë¡
            'rgb(251, 146, 60)',   // ì£¼í™©
            'rgb(168, 85, 247)',   // ë³´ë¼
            'rgb(236, 72, 153)',   // ë¡œì¦ˆ
            'rgb(14, 165, 233)',   // ìŠ¤ì¹´ì´
            'rgb(20, 184, 166)'    // í‹¸
        ];

        // ë‚ ì§œ ì •ë ¬ í•¨ìˆ˜ (ì›”ê³¼ ì¼ì„ ìˆ«ìë¡œ ë³€í™˜í•˜ì—¬ ì •ë ¬)
        function sortDates(date1, date2) {
            // "1ì›”26ì¼" í˜•ì‹ì—ì„œ ì›”ê³¼ ì¼ ì¶”ì¶œ
            function parseDate(dateStr) {
                const monthMatch = dateStr.match(/(\d+)ì›”/);
                const dayMatch = dateStr.match(/(\d+)ì¼/);
                const month = monthMatch ? parseInt(monthMatch[1]) : 0;
                const day = dayMatch ? parseInt(dayMatch[1]) : 0;
                return month * 100 + day; // ì›”*100 + ì¼ë¡œ ì •ë ¬ (ì˜ˆ: 1ì›”26ì¼ = 126)
            }
            
            return parseDate(date1) - parseDate(date2);
        }
        
        // ë‚ ì§œë³„ ë°ì´í„°ì…‹ ìƒì„±
        const datasets = [];
        let colorIndex = 0;
        const sortedDates = Array.from(dateMap.keys()).sort(sortDates);
        
        sortedDates.forEach(date => {
            const dateData = dateMap.get(date);
            const timeMap = dateData.timeMap;
            const dayOfWeek = dateData.dayOfWeek;
            
            const salesData = allTimes.map(time => {
                const items = timeMap.get(time) || [];
                return items.reduce((sum, item) => {
                    const sales = typeof item.salesEstimate === 'number' 
                        ? item.salesEstimate 
                        : parseFloat(item.salesEstimate) || 0;
                    return sum + sales;
                }, 0);
            });

            // ë ˆì´ë¸”ì— ìš”ì¼ ì •ë³´ ì¶”ê°€ (ì˜ˆ: "1ì›”26ì¼ (ì›”)")
            const label = dayOfWeek ? `${date} (${dayOfWeek})` : date;
            
            const color = colors[colorIndex % colors.length];
            datasets.push({
                label: label,
                data: salesData,
                borderColor: color,
                backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.1)'),
                tension: 0.4,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6
            });
            colorIndex++;
        });

        // ëª¨ë“  ë°ì´í„°ì…‹ì—ì„œ ìµœëŒ€ê°’ ì°¾ê¸°
        let maxSales = 0;
        datasets.forEach(dataset => {
            const datasetMax = Math.max(...dataset.data, 0);
            if (datasetMax > maxSales) {
                maxSales = datasetMax;
            }
        });

        // Yì¶• ìµœëŒ€ê°’ ê³„ì‚° (ë°ì´í„° ìµœëŒ€ê°’ + ì—¬ë°±)
        let yAxisMax;
        if (maxSales === 0) {
            yAxisMax = 1;
        } else if (maxSales <= 10) {
            // ì‘ì€ ê°’ì¼ ë•ŒëŠ” 10% ì—¬ë°±
            yAxisMax = Math.ceil(maxSales * 1.1);
        } else if (maxSales <= 100) {
            // ì¤‘ê°„ ê°’ì¼ ë•ŒëŠ” 5% ì—¬ë°±
            yAxisMax = Math.ceil(maxSales * 1.05);
        } else {
            // í° ê°’ì¼ ë•ŒëŠ” ì ì ˆí•œ ê°„ê²©ìœ¼ë¡œ ë°˜ì˜¬ë¦¼
            const magnitude = Math.pow(10, Math.floor(Math.log10(maxSales)));
            yAxisMax = Math.ceil(maxSales / magnitude) * magnitude;
            // ìµœì†Œ 5% ì—¬ë°± í™•ë³´
            if (yAxisMax < maxSales * 1.05) {
                yAxisMax = Math.ceil(maxSales * 1.05);
            }
        }

        // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë©”ì‹œì§€ í‘œì‹œ
        if (datasets.length === 0 || maxSales === 0) {
            if (chart) {
                chart.destroy();
            }
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.font = '16px Arial';
            ctx.fillStyle = '#666';
            ctx.textAlign = 'center';
            ctx.fillText('í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', ctx.canvas.width / 2, ctx.canvas.height / 2);
            
            // ë§¤ì¶œ í•©ê³„ ìˆ¨ê¸°ê¸°
            document.getElementById('revenueSummary').style.display = 'none';
            return;
        }
        
        // ë§¤ì¶œ í•©ê³„ ê³„ì‚°
        let totalRevenue = 0;
        data.forEach(item => {
            const revenue = typeof item.revenueEstimate === 'number' 
                ? item.revenueEstimate 
                : parseInt(item.revenueEstimate) || 0;
            totalRevenue += revenue;
        });
        
        // ë§¤ì¶œ í•©ê³„ í‘œì‹œ
        const revenueSummary = document.getElementById('revenueSummary');
        const totalRevenueElement = document.getElementById('totalRevenue');
        if (totalRevenue > 0) {
            totalRevenueElement.textContent = totalRevenue.toLocaleString('ko-KR') + 'ì›';
            revenueSummary.style.display = 'block';
        } else {
            revenueSummary.style.display = 'none';
        }

        // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
        if (chart) {
            chart.destroy();
        }

        // ìƒˆ ì°¨íŠ¸ ìƒì„±
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        min: 0,
                        max: yAxisMax,
                        ticks: {
                            stepSize: 1,
                            precision: 0
                        },
                        title: {
                            display: true,
                            text: 'íŒë§¤ëŸ‰'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'ì‹œê°„'
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 0
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return 'íŒë§¤ëŸ‰: ' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }

    // ë¡œê·¸ì•„ì›ƒ
    function handleLogout() {
        if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            localStorage.removeItem('salesChart_userId');
            window.location.href = '/';
        }
    }
</script>
</body>
</html>

