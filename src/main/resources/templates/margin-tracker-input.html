<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒë§¤ ë°ì´í„° ì…ë ¥ - í—¬ì¿  ë§¤ì¶œ ì¼ì§€</title>
    
    <!-- Flatpickr (ë‚ ì§œ ì„ íƒ ë¼ì´ë¸ŒëŸ¬ë¦¬) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4285F4;
            --primary-dark: #3367D6;
            --background: #F5F5F5;
            --card: #FFFFFF;
            --text-primary: #202124;
            --text-secondary: #5F6368;
            --text-disabled: #9AA0A6;
            --border: #E8EAED;
            --success: #34A853;
            --error: #EA4335;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        .input-header {
            background-color: var(--card);
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .back-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-primary);
            cursor: pointer;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            min-width: 44px;
            min-height: 44px;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }

        .back-button:hover {
            background-color: var(--background);
            border-radius: 50%;
        }

        .input-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            text-align: center;
        }

        .progress-info {
            font-size: 0.875rem;
            color: var(--text-secondary);
            min-width: 50px;
            text-align: right;
        }

        .progress-bar {
            height: 3px;
            background-color: var(--border);
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary);
            transition: width 0.3s ease;
        }

        /* Input Fields */
        .input-fields {
            padding: 1.5rem 2rem;
            padding-bottom: 2rem;
        }

        .input-field {
            margin-bottom: 1rem;
            opacity: 0.4;
            transition: opacity 0.3s;
        }

        .input-field.active {
            opacity: 1;
        }

        .input-field.completed {
            opacity: 0.6;
        }

        .field-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: var(--border);
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }

        .input-field.active .field-number {
            background-color: var(--primary);
            color: white;
        }

        .field-container {
            background-color: var(--card);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 72px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
        }

        .input-field.active .field-container {
            box-shadow: 0 2px 8px rgba(66, 133, 244, 0.2);
            border: 2px solid var(--primary) !important;
            outline: none;
        }
        
        .input-field.active .field-input {
            color: var(--primary) !important;
        }

        .field-label {
            flex: 1;
            font-size: 1.0625rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .field-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 1.25rem;
            color: var(--text-primary);
            background: transparent;
            text-align: right;
            width: 100%;
            min-height: 24px;
            padding: 0.25rem 0;
        }

        .field-input::placeholder {
            color: var(--text-disabled);
        }

        .field-input:focus {
            color: var(--primary);
        }

        .field-icon {
            margin-left: 0.75rem;
            color: var(--text-secondary);
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        /* ë‚ ì§œ í•„ë“œ: ë‹¤ë¥¸ í•„ë“œì™€ ë™ì¼í•œ íŒŒë€ ì›Â·í°íŠ¸ ìœ ì§€ */
        .date-field-container .field-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: var(--border);
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }
        .input-field.active[data-field="date"] .date-field-container .field-number {
            background-color: var(--primary);
            color: white;
        }
        .date-field-container .field-input,
        #field-date {
            font-family: inherit;
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--text-primary);
            text-align: right;
        }
        .date-field-container .field-label {
            font-size: 1.0625rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .field-value {
            font-size: 1.25rem;
            color: var(--text-primary);
            margin-left: auto;
            font-weight: 500;
            text-align: right;
        }

        .calculated-field {
            background-color: #F0F7FF;
        }

        .calculated-field .field-value {
            color: var(--primary);
            font-weight: 600;
        }
        
        .sold-out-checkbox-wrap {
            border-top: 1px solid var(--border);
            padding: 1rem 0;
            margin-top: 0.5rem;
        }
        
        .sold-out-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            user-select: none;
        }
        
        .sold-out-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #9C27B0;
        }
        
        .sold-out-checkbox span {
            font-size: 1.0625rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* Save Button */
        .save-button-container {
            display: flex;
            flex-direction: row;
            gap: 0.5rem;
            padding: 1.5rem 2rem;
            padding-top: 0;
            position: sticky;
            bottom: 0;
            background-color: var(--background);
            border-top: 1px solid var(--border);
        }

        .save-button {
            flex: 1;
            min-width: 0;
            padding: 1.25rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            opacity: 1;
            transition: opacity 0.2s, transform 0.1s;
            min-height: 56px;
            -webkit-tap-highlight-color: transparent;
        }

        .save-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .save-button:active {
            transform: translateY(0);
        }

        .save-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Flatpickr Calendar Positioning */
        .flatpickr-calendar {
            z-index: 3000 !important;
        }

        .flatpickr-calendar.open {
            position: fixed !important;
            left: 50% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important;
            margin: 0 !important;
        }

        .flatpickr-calendar:not(.open) {
            display: none !important;
        }

        /* PC ì „ìš© ìŠ¤íƒ€ì¼ */
        body {
            max-width: 900px;
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .input-header {
            padding: 1.25rem 2rem;
        }

        .input-fields {
            padding: 1.5rem 2rem;
        }

        .field-container {
            padding: 1.5rem;
            min-height: 72px;
        }

        .field-label {
            font-size: 1.0625rem;
        }

        .field-input,
        .date-field-container .field-input,
        #field-date {
            font-size: 1.25rem;
        }

        .field-value {
            font-size: 1.25rem;
        }

        .save-button-container {
            padding: 1.5rem 2rem;
        }

        .save-button {
            padding: 1.25rem;
            font-size: 1.125rem;
        }
    </style>
</head>
<body>
    <!-- Input Screen -->
    <div class="input-screen">
        <div class="input-header">
            <a href="/margin-tracker" class="back-button" id="backButton">â†</a>
            <div class="input-title">íŒë§¤ ë°ì´í„° ì…ë ¥</div>
            <div class="progress-info" id="progressInfo">1/17</div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 5.88%"></div>
        </div>

        <div class="input-fields" id="inputFields">
            <!-- ìƒí’ˆ ì •ë³´ í‘œì‹œ ì˜ì—­ -->
            <div id="productInfoSection" style="display: none; margin-bottom: 1rem; padding: 1rem; background: var(--card); border-radius: 12px;">
                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">ìƒí’ˆ ì •ë³´</div>
                <div id="productInfoDisplay" style="font-size: 1rem; font-weight: 600; color: var(--text-primary);"></div>
            </div>

            <!-- Field 1: ìƒí’ˆë²ˆí˜¸/ìƒí’ˆëª… (ì˜µì…˜ì´ ì—†ì„ ë•Œë§Œ í‘œì‹œ) -->
            <div class="input-field active" data-field="productNumber" id="productNumberField">
                <div class="field-container">
                    <span class="field-number">1</span>
                    <span class="field-label">ìƒí’ˆë²ˆí˜¸ / ìƒí’ˆëª…</span>
                    <input type="text" class="field-input" id="field-productNumber" placeholder="ìƒí’ˆë²ˆí˜¸ë‚˜ ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”" list="productList" autocomplete="off">
                    <datalist id="productList"></datalist>
                </div>
            </div>

            <!-- Field 2: ë‚ ì§œ -->
            <div class="input-field" data-field="date">
                <div class="field-container date-field-container">
                    <span class="field-number">2</span>
                    <span class="field-label">ë‚ ì§œ : ìë™/ìˆ˜ì •ê°€ëŠ¥</span>
                    <input type="text" class="field-input" id="field-date" placeholder="ë‚ ì§œ ì„ íƒ">
                    <span class="field-icon">ğŸ“…</span>
                </div>
            </div>

            <!-- ì˜µì…˜ íƒ­ ì˜ì—­ -->
            <div id="optionTabsSection" style="display: none; margin: 1rem 0; border-top: 2px solid var(--border); padding-top: 1rem;">
                <div id="optionTabs" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;"></div>
            </div>

            <!-- ì˜µì…˜ë³„ ì…ë ¥ í•„ë“œ ì˜ì—­ -->
            <div id="optionFieldsSection" style="display: none;"></div>

            <!-- ê¸°ì¡´ í•„ë“œë“¤ (ì˜µì…˜ì´ ì—†ì„ ë•Œ ì‚¬ìš©) -->
            <div id="legacyFields" style="display: none;">
                <!-- Field 3: íŒë§¤ê°€ -->
                <div class="input-field" data-field="sellingPrice">
                    <div class="field-container">
                        <span class="field-number">3</span>
                        <span class="field-label">íŒë§¤ê°€</span>
                        <input type="number" class="field-input" id="field-sellingPrice" placeholder="0">
                    </div>
                </div>

                <!-- Field 4: í• ì¸ì¿ í° -->
                <div class="input-field" data-field="discountCoupon">
                    <div class="field-container">
                        <span class="field-number">4</span>
                        <span class="field-label">í• ì¸ì¿ í°</span>
                        <input type="number" class="field-input" id="field-discountCoupon" placeholder="0">
                    </div>
                </div>

                <!-- Field 5: ìµœì¢… íŒë§¤ê°€ -->
                <div class="input-field calculated-field" data-field="finalSellingPrice">
                    <div class="field-container">
                        <span class="field-number">5</span>
                        <span class="field-label">ìµœì¢… íŒë§¤ê°€</span>
                        <div class="field-value" id="value-finalSellingPrice">-</div>
                        <input type="number" class="field-input" id="field-finalSellingPrice" placeholder="0" style="display: none;">
                    </div>
                </div>

                <!-- Field 6: ê°€ê²© ë³€ë™ -->
                <div class="input-field" data-field="priceFluctuation">
                    <div class="field-container">
                        <span class="field-number">6</span>
                        <span class="field-label">ê°€ê²© ë³€ë™</span>
                        <input type="number" class="field-input" id="field-priceFluctuation" placeholder="0">
                    </div>
                </div>

                <!-- Field 7: íŒë§¤ìˆ˜ëŸ‰ -->
                <div class="input-field" data-field="salesQuantity">
                    <div class="field-container">
                        <span class="field-number">7</span>
                        <span class="field-label">íŒë§¤ìˆ˜ëŸ‰</span>
                        <input type="number" class="field-input" id="field-salesQuantity" placeholder="0">
                    </div>
                </div>

                <!-- Field 8: ì‹¤ì œ íŒë§¤ ë§¤ì¶œ -->
                <div class="input-field calculated-field" data-field="actualSalesRevenue">
                    <div class="field-container">
                        <span class="field-number">8</span>
                        <span class="field-label">ì‹¤ì œ íŒë§¤ ë§¤ì¶œ</span>
                        <div class="field-value" id="value-actualSalesRevenue">-</div>
                        <input type="number" class="field-input" id="field-actualSalesRevenue" placeholder="0" style="display: none;">
                    </div>
                </div>

                <!-- Field 9: ê°œë‹¹ ë§ˆì§„ -->
                <div class="input-field" data-field="marginPerUnit">
                    <div class="field-container">
                        <span class="field-number">9</span>
                        <span class="field-label">ê°œë‹¹ ë§ˆì§„</span>
                        <input type="number" class="field-input" id="field-marginPerUnit" placeholder="0">
                    </div>
                </div>

                <!-- Field 10: ì´ ë§ˆì§„ -->
                <div class="input-field calculated-field" data-field="totalMargin">
                    <div class="field-container">
                        <span class="field-number">10</span>
                        <span class="field-label">ì´ ë§ˆì§„</span>
                        <div class="field-value" id="value-totalMargin">-</div>
                        <input type="number" class="field-input" id="field-totalMargin" placeholder="0" style="display: none;">
                    </div>
                </div>

                <!-- Field 11: ê´‘ê³ ë¹„ -->
                <div class="input-field" data-field="advertisingCost">
                    <div class="field-container">
                        <span class="field-number">11</span>
                        <span class="field-label">ê´‘ê³ ë¹„</span>
                        <input type="number" class="field-input" id="field-advertisingCost" placeholder="0">
                    </div>
                </div>

                <!-- Field 12: ìˆœìˆ˜ìµ -->
                <div class="input-field calculated-field" data-field="netProfit">
                    <div class="field-container">
                        <span class="field-number">12</span>
                        <span class="field-label">ìˆœìˆ˜ìµ</span>
                        <div class="field-value" id="value-netProfit">-</div>
                        <input type="number" class="field-input" id="field-netProfit" placeholder="0" style="display: none;">
                    </div>
                </div>

                <!-- Field 13: ë§ˆì§„ìœ¨ -->
                <div class="input-field calculated-field" data-field="marginRate">
                    <div class="field-container">
                        <span class="field-number">13</span>
                        <span class="field-label">ë§ˆì§„ìœ¨ (%)</span>
                        <div class="field-value" id="value-marginRate">-</div>
                        <input type="number" class="field-input" id="field-marginRate" placeholder="0" style="display: none;">
                    </div>
                </div>

                <!-- Field 14: ê´‘ê³ íŒë§¤ -->
                <div class="input-field" data-field="adSales">
                    <div class="field-container">
                        <span class="field-number">14</span>
                        <span class="field-label">ê´‘ê³ íŒë§¤</span>
                        <input type="number" class="field-input" id="field-adSales" placeholder="0">
                    </div>
                </div>

                <!-- Field 15: ìì—°íŒë§¤ -->
                <div class="input-field" data-field="organicSales">
                    <div class="field-container">
                        <span class="field-number">15</span>
                        <span class="field-label">ìì—°íŒë§¤</span>
                        <input type="number" class="field-input" id="field-organicSales" placeholder="0">
                    </div>
                </div>

                <!-- Field 16: ìì—°íŒë§¤ë¹„ìœ¨ -->
                <div class="input-field calculated-field" data-field="organicSalesRatio">
                    <div class="field-container">
                        <span class="field-number">16</span>
                        <span class="field-label">ìì—°íŒë§¤ë¹„ìœ¨ (%)</span>
                        <div class="field-value" id="value-organicSalesRatio">-</div>
                        <input type="number" class="field-input" id="field-organicSalesRatio" placeholder="0" style="display: none;">
                    </div>
                </div>

                <!-- Field 17: ROAS -->
                <div class="input-field calculated-field" data-field="roas">
                    <div class="field-container">
                        <span class="field-number">17</span>
                        <span class="field-label">ROAS</span>
                        <div class="field-value" id="value-roas">-</div>
                        <input type="number" class="field-input" id="field-roas" placeholder="0" style="display: none;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <div class="save-button-container">
            <button id="saveButton" class="save-button">ë“±ë¡</button>
            <button id="deleteButton" class="save-button" style="background: #EA4335; color: #fff; display: none;">ì‚­ì œ</button>
            <button id="nextProductButton" class="save-button save-button-next" style="background: var(--border); color: var(--text-primary); display: none;">ë‹¤ìŒìƒí’ˆ</button>
            <button id="backToTrackerButton" class="save-button save-button-back" style="background: var(--background); color: var(--text-primary); border: 1px solid var(--border);">ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <script>
        // State
        let currentStep = 0;
        let formData = {
            productNumber: '',
            date: '',
            sellingPrice: '',
            discountCoupon: '',
            finalSellingPrice: '',
            priceFluctuation: '',
            salesQuantity: '',
            actualSalesRevenue: '',
            marginPerUnit: '',
            totalMargin: '',
            advertisingCost: '',
            netProfit: '',
            marginRate: '',
            adSales: '',
            organicSales: '',
            organicSalesRatio: '',
            roas: ''
        };

        const fields = [
            'productNumber', 'date', 'sellingPrice', 'discountCoupon', 'finalSellingPrice',
            'priceFluctuation', 'salesQuantity', 'actualSalesRevenue', 'marginPerUnit',
            'totalMargin', 'advertisingCost', 'netProfit', 'marginRate',
            'adSales', 'organicSales', 'organicSalesRatio', 'roas'
        ];

        const calculatedFields = [
            'finalSellingPrice', 'actualSalesRevenue', 'totalMargin', 
            'netProfit', 'marginRate', 'organicSalesRatio', 'roas'
        ];

        let editId = null;
        let currentProductOptions = [];
        /** ìƒí’ˆ ë“±ë¡ ì‹œ ìˆ˜ìˆ˜ë£Œ 1.1ë°° ì ìš©ê³¼ ë™ì¼í•˜ê²Œ, ì €ì¥ëœ ê°œë‹¹ ë§ˆì§„ì´ ìˆ˜ìˆ˜ë£Œ 1.0ë°° ê¸°ì¤€ì´ë©´ 1.1ë°° ë³´ì •í•˜ì—¬ ì‚¬ìš© */
        let currentProductCommissionRate = null;
        function getEffectiveMarginPerUnit(marginPerUnit, finalPrice) {
            var m = parseFloat(marginPerUnit) || 0;
            if (finalPrice == null || finalPrice <= 0) return m;
            if (currentProductCommissionRate == null || currentProductCommissionRate === '' || isNaN(parseFloat(currentProductCommissionRate))) return m;
            var rate = parseFloat(String(currentProductCommissionRate).replace(/,/g, '')) || 0;
            if (rate <= 0) return m;
            var correction = finalPrice * rate * 0.1 / 100;
            return m - correction;
        }
        let currentProductInfo = null;
        let currentOptionIndex = 0;
        let optionDataSets = [];
        let allRegisteredProducts = [];
        let currentProductIndex = -1;
        let updateNextProductButtonFn = null;
        /** ë™ì¼ ìƒí’ˆ ì…ë ¥ ì‹œ íŒë§¤ê°€ ë³€ë™ ìë™ ì„¤ì •ìš© - í•´ë‹¹ ìƒí’ˆì˜ ìµœê·¼ ì…ë ¥ê°’ (ë ˆê±°ì‹œ ë‹¨ì¼ ìƒí’ˆìš©) */
        let lastPriceFluctuationForProduct = null;
        /** ì˜µì…˜ë³„ ìµœê·¼ íŒë§¤ê°€ ë³€ë™ - key: optionId|optionAlias */
        let lastPfByOption = {};

        document.addEventListener('DOMContentLoaded', function() {
            const uid = localStorage.getItem('salesChart_userId');
            if (!uid) {
                window.location.href = '/margin-tracker';
                return;
            }
            const params = new URLSearchParams(window.location.search);
            editId = params.get('id');
            const productParam = params.get('product');
            const dateParam = params.get('date');
            initEventListeners();
            initDatePicker();
            loadProductList();
            if (editId) {
                loadRecordForEdit(editId);
            } else {
                updateSaveButtonText();
                if (productParam) {
                    handleProductSelect(productParam, dateParam);
                } else {
                    setCurrentStep(0);
                }
            }
        });

        async function loadProductList() {
            const uid = localStorage.getItem('salesChart_userId');
            if (!uid) return;
            try {
                const res = await fetch('/api/margin-tracker/registered-products?userId=' + encodeURIComponent(uid));
                const data = await res.json();
                allRegisteredProducts = (data.success && data.products) ? data.products : [];
                const list = document.getElementById('productList');
                list.innerHTML = '';
                if (allRegisteredProducts.length > 0) {
                    allRegisteredProducts.forEach(function(p) {
                        const num = p.productNumber || '';
                        const name = p.productName || '';
                        const label = name ? (num + ' / ' + name) : num;
                        if (label) {
                            const opt = document.createElement('option');
                            opt.value = label;
                            list.appendChild(opt);
                        }
                    });
                }
                const res2 = await fetch('/api/margin-tracker/products?userId=' + encodeURIComponent(uid));
                const data2 = await res2.json();
                if (data2.success && data2.products && data2.products.length) {
                    data2.products.forEach(function(p) {
                        const num = p.productNumber || '';
                        const name = p.productName || '';
                        const label = name ? (num + ' / ' + name) : num;
                        if (label && !Array.from(list.options).some(o => o.value === label)) {
                            const opt = document.createElement('option');
                            opt.value = label;
                            list.appendChild(opt);
                        }
                    });
                }
            } catch (e) {}
        }

        async function handleProductSelect(productNumber, dateParam) {
            const uid = localStorage.getItem('salesChart_userId');
            if (!uid) return;
            try {
                lastPriceFluctuationForProduct = null;
                lastPfByOption = {};
                const res = await fetch('/api/margin-tracker/product-options?userId=' + encodeURIComponent(uid) + '&productNumber=' + encodeURIComponent(productNumber));
                const data = await res.json();
                if (data.success && data.options && data.options.length > 0) {
                    currentProductOptions = data.options;
                    currentProductCommissionRate = (data.commissionRate != null && data.commissionRate !== '') ? data.commissionRate : null;
                    try {
                        const pfRes = await fetch('/api/margin-tracker/latest-price-fluctuation-by-option?userId=' + encodeURIComponent(uid) + '&productNumber=' + encodeURIComponent(productNumber));
                        const pfData = await pfRes.json();
                        if (pfData.success && pfData.options && Array.isArray(pfData.options)) {
                            pfData.options.forEach(function(o) {
                                var k = (o.optionId != null ? o.optionId : '') + '|' + (o.optionAlias != null ? o.optionAlias : '');
                                if (o.priceFluctuation != null && o.priceFluctuation !== '') lastPfByOption[k] = o.priceFluctuation;
                            });
                        }
                    } catch (e) { /* ë¬´ì‹œ */ }
                    optionDataSets = [];
                    currentProductOptions.forEach(function(opt, idx) {
                        var k = (opt.optionId != null ? opt.optionId : '') + '|' + (opt.optionAlias != null ? opt.optionAlias : '');
                        var pf = lastPfByOption[k] != null ? lastPfByOption[k] : '';
                        optionDataSets[idx] = {
                            sellingPrice: opt.sellingPrice || 0,
                            priceFluctuation: pf,
                            finalSellingPrice: opt.sellingPrice || 0,
                            salesQuantity: '',
                            advertisingCost: '',
                            adSales: '',
                            organicSales: 0,
                            netProfit: 0,
                            marginRate: 0,
                            roas: 0,
                            isSoldOut: false,
                            lastValues: null
                        };
                    });
                    currentProductInfo = allRegisteredProducts.find(p => p.productNumber === productNumber) || { productNumber: productNumber, productName: '' };
                    document.getElementById('productInfoSection').style.display = 'block';
                    document.getElementById('productInfoDisplay').textContent = (currentProductInfo.productNumber || '') + ' / ' + (currentProductInfo.productName || '');
                    document.getElementById('productNumberField').style.display = 'none';
                    document.getElementById('optionTabsSection').style.display = 'block';
                    document.getElementById('optionFieldsSection').style.display = 'block';
                    document.getElementById('legacyFields').style.display = 'none';
                    currentProductIndex = allRegisteredProducts.findIndex(p => p.productNumber === productNumber);
                    // ìˆ˜ì • ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ë‹¤ìŒìƒí’ˆ ë²„íŠ¼ ì—…ë°ì´íŠ¸
                    const isEditModeForHandleProduct = editId !== null;
                    if (!isEditModeForHandleProduct && updateNextProductButtonFn) {
                        updateNextProductButtonFn();
                    } else {
                        const nextProductBtn = document.getElementById('nextProductButton');
                        if (nextProductBtn) nextProductBtn.style.display = 'none';
                    }
                    renderOptionTabs();
                    renderOptionFields(0);
                    if (dateParam) {
                        const dateInput = document.getElementById('field-date');
                        if (dateInput && dateInput._flatpickr) {
                            const d = new Date(dateParam);
                            dateInput._flatpickr.setDate(d, false);
                            formData.date = dateInput.value;
                        }
                    }
                } else {
                    currentProductCommissionRate = (data.commissionRate != null && data.commissionRate !== '') ? data.commissionRate : null;
                    try {
                        const latestRes = await fetch('/api/margin-tracker/latest-record?userId=' + encodeURIComponent(uid) + '&productNumber=' + encodeURIComponent(productNumber));
                        const latestData = await latestRes.json();
                        if (latestData.success && latestData.priceFluctuation != null && latestData.priceFluctuation !== '') {
                            lastPriceFluctuationForProduct = latestData.priceFluctuation;
                        }
                    } catch (e) { /* ë¬´ì‹œ */ }
                    document.getElementById('productInfoSection').style.display = 'none';
                    document.getElementById('productNumberField').style.display = 'block';
                    document.getElementById('optionTabsSection').style.display = 'none';
                    document.getElementById('optionFieldsSection').style.display = 'none';
                    document.getElementById('legacyFields').style.display = 'block';
                    const productInput = document.getElementById('field-productNumber');
                    if (productInput) {
                        const p = allRegisteredProducts.find(p => p.productNumber === productNumber);
                        if (p) {
                            productInput.value = (p.productNumber || '') + ' / ' + (p.productName || '');
                            formData.productNumber = productInput.value;
                            if (lastPriceFluctuationForProduct != null && lastPriceFluctuationForProduct !== '') {
                                const v = String(lastPriceFluctuationForProduct);
                                formData.priceFluctuation = v;
                                const pfInput = document.getElementById('field-priceFluctuation');
                                if (pfInput) pfInput.value = v;
                                calculateDerivedFields();
                            }
                            // ìƒí’ˆ ë“±ë¡ ì‹œ ì €ì¥ëœ ì˜µì…˜ ì •ë³´ê°€ ìˆìœ¼ë©´ ì²« ë²ˆì§¸ ì˜µì…˜ì˜ ê°œë‹¹ ë§ˆì§„ì„ ìë™ ì„¤ì •
                            if (data.options && data.options.length > 0) {
                                const firstOption = data.options[0];
                                if (firstOption.marginPerUnit) {
                                    formData.marginPerUnit = firstOption.marginPerUnit;
                                    const marginInput = document.getElementById('field-marginPerUnit');
                                    if (marginInput) {
                                        marginInput.value = firstOption.marginPerUnit;
                                    }
                                    calculateDerivedFields();
                                }
                            } else {
                                // ì˜µì…˜ì´ ì—†ì–´ë„ ìƒí’ˆì´ ë“±ë¡ë˜ì–´ ìˆìœ¼ë©´, ì˜µì…˜ ì •ë³´ë¥¼ ë‹¤ì‹œ í™•ì¸
                                // (ì˜µì…˜ì´ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•´ì•¼ í•¨)
                                console.log('ë“±ë¡ëœ ìƒí’ˆì´ì§€ë§Œ ì˜µì…˜ì´ ì—†ìŠµë‹ˆë‹¤. ê°œë‹¹ ë§ˆì§„ì„ ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                            }
                        }
                    }
                }
            } catch (e) {
                console.error('ì˜µì…˜ ë¡œë“œ ì‹¤íŒ¨', e);
            }
        }

        let optionTabsCurrentPage = 0;
        const optionTabsPerPage = 3;

        function renderOptionTabs() {
            const container = document.getElementById('optionTabs');
            container.innerHTML = '';
            const startIdx = optionTabsCurrentPage * optionTabsPerPage;
            const endIdx = Math.min(startIdx + optionTabsPerPage, currentProductOptions.length);
            const visibleOptions = currentProductOptions.slice(startIdx, endIdx);
            visibleOptions.forEach(function(opt, localIdx) {
                const idx = startIdx + localIdx;
                const tab = document.createElement('button');
                tab.type = 'button';
                tab.className = 'option-tab' + (idx === currentOptionIndex ? ' active' : '');
                tab.textContent = opt.optionAlias || opt.optionId || ('ì˜µì…˜' + String.fromCharCode(65 + idx));
                tab.style.cssText = 'padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: 8px; background: var(--background); color: var(--text-primary); font-size: 0.875rem; cursor: pointer; flex: 1; min-width: 0;';
                if (idx === currentOptionIndex) {
                    tab.style.background = 'var(--primary)';
                    tab.style.color = '#fff';
                    tab.style.borderColor = 'var(--primary)';
                }
                tab.addEventListener('click', function() {
                    currentOptionIndex = idx;
                    optionTabsCurrentPage = Math.floor(idx / optionTabsPerPage);
                    renderOptionTabs();
                    renderOptionFields(idx);
                    // í¬ì»¤ìŠ¤ ì„¤ì •ì„ renderOptionFields ì™„ë£Œ í›„ ì‹¤í–‰
                    setTimeout(function() {
                        const fieldsSection = document.getElementById('optionFieldsSection');
                        if (fieldsSection) {
                            fieldsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            setTimeout(function() {
                                const priceFluctuationField = document.getElementById('optionPriceFluctuationField');
                                const priceFluctuationInput = fieldsSection.querySelector('.opt-price-fluctuation');
                                if (priceFluctuationInput && priceFluctuationField) {
                                    // input-fieldì— active í´ë˜ìŠ¤ ìœ ì§€
                                    priceFluctuationField.classList.add('active');
                                    // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
                                    priceFluctuationInput.focus();
                                    priceFluctuationInput.select();
                                    // í¬ì»¤ìŠ¤ ì´ë²¤íŠ¸ ê°•ì œ ë°œìƒ
                                    priceFluctuationInput.dispatchEvent(new Event('focus', { bubbles: true }));
                                }
                            }, 500);
                        }
                    }, 150);
                });
                container.appendChild(tab);
            });
            if (currentProductOptions.length > optionTabsPerPage) {
                const navContainer = document.createElement('div');
                navContainer.style.cssText = 'display: flex; gap: 0.5rem; margin-top: 0.5rem; justify-content: center;';
                if (optionTabsCurrentPage > 0) {
                    const prevBtn = document.createElement('button');
                    prevBtn.textContent = 'â† ì´ì „';
                    prevBtn.style.cssText = 'padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--background); cursor: pointer; font-size: 0.875rem;';
                    prevBtn.addEventListener('click', function() {
                        optionTabsCurrentPage--;
                        renderOptionTabs();
                    });
                    navContainer.appendChild(prevBtn);
                }
                if (endIdx < currentProductOptions.length) {
                    const nextBtn = document.createElement('button');
                    nextBtn.textContent = 'ë‹¤ìŒ â†’';
                    nextBtn.style.cssText = 'padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--background); cursor: pointer; font-size: 0.875rem;';
                    nextBtn.addEventListener('click', function() {
                        optionTabsCurrentPage++;
                        renderOptionTabs();
                    });
                    navContainer.appendChild(nextBtn);
                }
                container.appendChild(navContainer);
            }
        }

        function renderOptionFields(optionIdx) {
            const container = document.getElementById('optionFieldsSection');
            container.innerHTML = '';
            const opt = currentProductOptions[optionIdx];
            if (!opt) return;
            if (!optionDataSets[optionIdx]) {
                var k = (opt.optionId != null ? opt.optionId : '') + '|' + (opt.optionAlias != null ? opt.optionAlias : '');
                var initPriceFluctuation = (lastPfByOption[k] != null && lastPfByOption[k] !== '') ? lastPfByOption[k] : '';
                optionDataSets[optionIdx] = {
                    sellingPrice: opt.sellingPrice || 0,
                    priceFluctuation: initPriceFluctuation,
                    finalSellingPrice: opt.sellingPrice || 0,
                    salesQuantity: '',
                    advertisingCost: '',
                    adSales: '',
                    organicSales: 0,
                    netProfit: 0,
                    marginRate: 0,
                    roas: 0,
                    isSoldOut: false,
                    lastValues: null
                };
            }
            const data = optionDataSets[optionIdx];
            const isSoldOut = data.isSoldOut === true;
            const sellingPrice = parseFloat(data.sellingPrice) || 0;
            const priceFluctuation = parseFloat(data.priceFluctuation) || 0;
            const finalPrice = sellingPrice + priceFluctuation;
            // í’ˆì ˆì¸ ê²½ìš° íŒë§¤ê°œìˆ˜ëŠ” 0ìœ¼ë¡œ ì²˜ë¦¬í•˜ë˜, ë¼ìŠ¤íŠ¸ê°’ì€ ìœ ì§€
            const salesQty = isSoldOut ? 0 : (parseFloat(data.salesQuantity) || 0);
            const adCost = isSoldOut ? 0 : (parseFloat(data.advertisingCost) || 0);
            const adSalesQty = isSoldOut ? 0 : (parseFloat(data.adSales) || 0);
            const organicSalesQty = Math.max(0, salesQty - adSalesQty);
            const actualRevenue = finalPrice * salesQty;
            // ìˆœì´ìµ ê³„ì‚°: (ê°œë‹¹ ë§ˆì§„ * íŒë§¤ ìˆ˜ëŸ‰) + (íŒë§¤ê°€ ë³€ë™ * íŒë§¤ ìˆ˜ëŸ‰) - ê´‘ê³ ë¹„
            // ìˆ˜ìˆ˜ë£Œ 1.1ë°° ë³´ì •: ìƒí’ˆ ë“±ë¡ í˜ì´ì§€ì™€ ë™ì¼í•˜ê²Œ ì ìš©
            let baseMarginPerUnit = 0;
            if (opt.marginPerUnit != null && opt.marginPerUnit !== undefined && opt.marginPerUnit !== '') {
                baseMarginPerUnit = getEffectiveMarginPerUnit(opt.marginPerUnit, finalPrice);
            }
            console.log('renderOptionFields - ì˜µì…˜ ê°œë‹¹ ë§ˆì§„:', {
                optionAlias: opt.optionAlias,
                marginPerUnit: opt.marginPerUnit,
                parsedMarginPerUnit: baseMarginPerUnit,
                salesQty: salesQty,
                priceFluctuation: priceFluctuation,
                adCost: adCost
            });
            const marginFromBase = baseMarginPerUnit * salesQty;  // ê°œë‹¹ ë§ˆì§„ * íŒë§¤ ìˆ˜ëŸ‰
            const marginFromFluctuation = priceFluctuation * salesQty;  // íŒë§¤ê°€ ë³€ë™ * íŒë§¤ ìˆ˜ëŸ‰
            const netProfit = marginFromBase + marginFromFluctuation - adCost;
            console.log('renderOptionFields - ìˆœì´ìµ ê³„ì‚°:', {
                marginFromBase: marginFromBase,
                marginFromFluctuation: marginFromFluctuation,
                adCost: adCost,
                netProfit: netProfit
            });
            const roas = adCost > 0 ? actualRevenue / adCost : 0;
            // ë§ˆì§„ìœ¨ ê³„ì‚°: ì¡°ì •ëœ ê°œë‹¹ ë§ˆì§„ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
            const adjustedMarginPerUnit = baseMarginPerUnit + priceFluctuation;
            let marginRate = 0;
            if (adjustedMarginPerUnit > 0 && finalPrice > 0) {
                marginRate = (adjustedMarginPerUnit / finalPrice) * 100;
            } else if (actualRevenue > 0) {
                marginRate = (netProfit / actualRevenue) * 100;
            }
            container.innerHTML = '<div style="border-top: 2px solid var(--border); padding-top: 1rem; margin-top: 1rem;">' +
                '<div class="input-field"><div class="field-container"><span class="field-number">1</span><span class="field-label">íŒë§¤ê°€ : ìë™ (ìˆ˜ì •ë¶ˆê°€)</span><div class="field-value" style="color: var(--text-secondary);">' + Math.round(sellingPrice).toLocaleString('ko-KR') + 'ì›</div></div></div>' +
                '<div class="input-field" id="optionPriceFluctuationField"><div class="field-container"><span class="field-number">2</span><span class="field-label">íŒë§¤ê°€ ë³€ë™ : ìˆ˜ë™ (í•„ìˆ˜ì•„ë‹˜)</span><input type="number" class="field-input opt-price-fluctuation" placeholder="ì˜ˆ: +1000, -1000" value="' + (priceFluctuation !== 0 ? priceFluctuation : '') + '"></div></div>' +
                '<div class="input-field" id="optionSalesQtyField"><div class="field-container"><span class="field-number">3</span><span class="field-label">íŒë§¤ ê°œìˆ˜ : ìˆ˜ë™(í•„ìˆ˜)</span><input type="number" class="field-input opt-sales-qty" placeholder="0" value="' + (salesQty > 0 ? salesQty : '') + '" required></div></div>' +
                '<div class="input-field" id="optionAdCostField"><div class="field-container"><span class="field-number">4</span><span class="field-label">ê´‘ê³ ë¹„ : ìˆ˜ë™(í•„ìˆ˜)</span><input type="number" class="field-input opt-ad-cost" placeholder="0" value="' + (adCost > 0 ? adCost : '') + '" required></div></div>' +
                '<div class="input-field" id="optionAdSalesField"><div class="field-container"><span class="field-number">5</span><span class="field-label">ê´‘ê³  íŒë§¤ ê°œìˆ˜ : ìˆ˜ë™(í•„ìˆ˜)</span><input type="number" class="field-input opt-ad-sales" placeholder="0" value="' + (adSalesQty > 0 ? adSalesQty : '') + '" required></div></div>' +
                '<div style="border-top: 2px solid var(--border); margin: 1rem 0; padding-top: 1rem;"></div>' +
                '<div class="input-field calculated-field"><div class="field-container"><span class="field-number">6</span><span class="field-label">ìµœì¢… íŒë§¤ê°€ : ìë™ (ìˆ˜ì •ë¶ˆê°€)</span><div class="field-value opt-final-price">' + Math.round(finalPrice).toLocaleString('ko-KR') + 'ì›</div></div></div>' +
                '<div class="input-field calculated-field"><div class="field-container"><span class="field-number">7</span><span class="field-label">ìì—°íŒë§¤ê°œìˆ˜ : ìë™ (ìˆ˜ì • ë¶ˆê°€)</span><div class="field-value opt-organic-sales">' + Math.max(0, Math.round(organicSalesQty)) + '</div></div></div>' +
                '<div class="input-field calculated-field"><div class="field-container"><span class="field-number">8</span><span class="field-label">ìˆœì´ìµ (ì…ë ¥ê°’ ì•„ë‹˜)</span><div class="field-value opt-net-profit">' + Math.round(netProfit).toLocaleString('ko-KR') + 'ì›</div></div></div>' +
                '<div class="input-field calculated-field"><div class="field-container"><span class="field-number">9</span><span class="field-label">ROAS (ì…ë ¥ê°’ì•„ë‹˜)</span><div class="field-value opt-roas">' + (roas > 0 ? roas.toFixed(2) : '-') + '</div></div></div>' +
                '<div class="sold-out-checkbox-wrap">' +
                '<label class="sold-out-checkbox">' +
                '<input type="checkbox" class="opt-sold-out" ' + (isSoldOut ? 'checked' : '') + '>' +
                '<span>í’ˆì ˆ</span>' +
                '</label>' +
                '</div>' +
                '</div>';
            const priceFluctuationInput = container.querySelector('.opt-price-fluctuation');
            const salesQtyInput = container.querySelector('.opt-sales-qty');
            const adCostInput = container.querySelector('.opt-ad-cost');
            const adSalesInput = container.querySelector('.opt-ad-sales');
            
            // í¬ì»¤ì‹± íš¨ê³¼ë¥¼ ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            function addFocusBlurListeners(inputElement, fieldElement) {
                if (!inputElement || !fieldElement) return;
                inputElement.addEventListener('focus', function() {
                    fieldElement.classList.add('active');
                });
                inputElement.addEventListener('blur', function() {
                    fieldElement.classList.remove('active');
                });
            }
            
            if (priceFluctuationInput) {
                priceFluctuationInput.addEventListener('input', function() {
                    updateOptionCalculations(optionIdx);
                });
                addFocusBlurListeners(priceFluctuationInput, document.getElementById('optionPriceFluctuationField'));
            }
            if (salesQtyInput) {
                salesQtyInput.addEventListener('input', function() {
                    updateOptionCalculations(optionIdx);
                });
                addFocusBlurListeners(salesQtyInput, document.getElementById('optionSalesQtyField'));
            }
            if (adCostInput) {
                adCostInput.addEventListener('input', function() {
                    updateOptionCalculations(optionIdx);
                });
                addFocusBlurListeners(adCostInput, document.getElementById('optionAdCostField'));
            }
            if (adSalesInput) {
                adSalesInput.addEventListener('input', function() {
                    updateOptionCalculations(optionIdx);
                });
                addFocusBlurListeners(adSalesInput, document.getElementById('optionAdSalesField'));
            }
            
            // í’ˆì ˆ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
            const soldOutCheckbox = container.querySelector('.opt-sold-out');
            if (soldOutCheckbox) {
                soldOutCheckbox.addEventListener('change', function() {
                    const isChecked = this.checked;
                    optionDataSets[optionIdx].isSoldOut = isChecked;
                    
                    if (isChecked) {
                        // í’ˆì ˆ ì²´í¬ ì‹œ: í˜„ì¬ ì…ë ¥ê°’ì„ ë¼ìŠ¤íŠ¸ê°’ìœ¼ë¡œ ì €ì¥í•˜ê³  í•„ë“œ ë¹„í™œì„±í™”
                        optionDataSets[optionIdx].lastValues = {
                            priceFluctuation: priceFluctuationInput ? priceFluctuationInput.value : '',
                            salesQuantity: salesQtyInput ? salesQtyInput.value : '',
                            advertisingCost: adCostInput ? adCostInput.value : '',
                            adSales: adSalesInput ? adSalesInput.value : ''
                        };
                        
                        // ëª¨ë“  ì…ë ¥ í•„ë“œ ë¹„í™œì„±í™”
                        if (priceFluctuationInput) priceFluctuationInput.disabled = true;
                        if (salesQtyInput) salesQtyInput.disabled = true;
                        if (adCostInput) adCostInput.disabled = true;
                        if (adSalesInput) adSalesInput.disabled = true;
                        
                        // ê°’ë“¤ì„ 0ìœ¼ë¡œ ì„¤ì • (í‘œì‹œìš©)
                        if (salesQtyInput) salesQtyInput.value = '';
                        if (adCostInput) adCostInput.value = '';
                        if (adSalesInput) adSalesInput.value = '';
                        
                        // ê³„ì‚° ì—…ë°ì´íŠ¸ (í’ˆì ˆ ìƒíƒœë¡œ)
                        updateOptionCalculations(optionIdx);
                    } else {
                        // í’ˆì ˆ í•´ì œ ì‹œ: ë¼ìŠ¤íŠ¸ê°’ ë³µì›í•˜ê³  í•„ë“œ í™œì„±í™”
                        const lastValues = optionDataSets[optionIdx].lastValues;
                        if (lastValues) {
                            if (priceFluctuationInput) priceFluctuationInput.value = lastValues.priceFluctuation || '';
                            if (salesQtyInput) salesQtyInput.value = lastValues.salesQuantity || '';
                            if (adCostInput) adCostInput.value = lastValues.advertisingCost || '';
                            if (adSalesInput) adSalesInput.value = lastValues.adSales || '';
                            
                            // optionDataSetsì—ë„ ë³µì›
                            optionDataSets[optionIdx].priceFluctuation = lastValues.priceFluctuation || '';
                            optionDataSets[optionIdx].salesQuantity = lastValues.salesQuantity || '';
                            optionDataSets[optionIdx].advertisingCost = lastValues.advertisingCost || '';
                            optionDataSets[optionIdx].adSales = lastValues.adSales || '';
                        }
                        
                        // ëª¨ë“  ì…ë ¥ í•„ë“œ í™œì„±í™”
                        if (priceFluctuationInput) priceFluctuationInput.disabled = false;
                        if (salesQtyInput) salesQtyInput.disabled = false;
                        if (adCostInput) adCostInput.disabled = false;
                        if (adSalesInput) adSalesInput.disabled = false;
                        
                        // ê³„ì‚° ì—…ë°ì´íŠ¸
                        updateOptionCalculations(optionIdx);
                    }
                });
                
                // ì´ˆê¸° ìƒíƒœ ì„¤ì • (í’ˆì ˆì¸ ê²½ìš° í•„ë“œ ë¹„í™œì„±í™”)
                if (isSoldOut) {
                    if (priceFluctuationInput) priceFluctuationInput.disabled = true;
                    if (salesQtyInput) salesQtyInput.disabled = true;
                    if (adCostInput) adCostInput.disabled = true;
                    if (adSalesInput) adSalesInput.disabled = true;
                }
            }
            
            // ì²« ë²ˆì§¸ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ (ì˜µì…˜ íƒ­ í´ë¦­ ì‹œ í˜¸ì¶œë˜ì§€ ì•Šë„ë¡ ì—¬ê¸°ì„œëŠ” ì œê±°)
        }

        function updateOptionCalculations(optionIdx) {
            const container = document.getElementById('optionFieldsSection');
            const opt = currentProductOptions[optionIdx];
            if (!opt || !optionDataSets[optionIdx]) return;
            const data = optionDataSets[optionIdx];
            const isSoldOut = data.isSoldOut === true;
            var pfEl = container ? container.querySelector('.opt-price-fluctuation') : null;
            var sqEl = container ? container.querySelector('.opt-sales-qty') : null;
            var adEl = container ? container.querySelector('.opt-ad-cost') : null;
            var adSalesEl = container ? container.querySelector('.opt-ad-sales') : null;
            if (!pfEl || !sqEl || !adEl || !adSalesEl) return;
            const sellingPrice = parseFloat(opt.sellingPrice) || 0;
            const priceFluctuation = parseFloat(pfEl.value) || 0;
            const finalPrice = sellingPrice + priceFluctuation;
            // í’ˆì ˆì¸ ê²½ìš° íŒë§¤ê°œìˆ˜ëŠ” 0ìœ¼ë¡œ ì²˜ë¦¬
            const salesQty = isSoldOut ? 0 : (parseFloat(sqEl.value) || 0);
            const adCost = isSoldOut ? 0 : (parseFloat(adEl.value) || 0);
            const adSalesQty = isSoldOut ? 0 : (parseFloat(adSalesEl.value) || 0);
            const organicSalesQty = Math.max(0, salesQty - adSalesQty);
            const actualRevenue = finalPrice * salesQty;
            // ìˆœì´ìµ ê³„ì‚°: (ê°œë‹¹ ë§ˆì§„ * íŒë§¤ ìˆ˜ëŸ‰) + (íŒë§¤ê°€ ë³€ë™ * íŒë§¤ ìˆ˜ëŸ‰) - ê´‘ê³ ë¹„
            // ìˆ˜ìˆ˜ë£Œ 1.1ë°° ë³´ì •: ìƒí’ˆ ë“±ë¡ í˜ì´ì§€ì™€ ë™ì¼í•˜ê²Œ ì ìš©
            let baseMarginPerUnit = 0;
            if (opt.marginPerUnit != null && opt.marginPerUnit !== undefined && opt.marginPerUnit !== '') {
                baseMarginPerUnit = getEffectiveMarginPerUnit(opt.marginPerUnit, finalPrice);
            }
            console.log('updateOptionCalculations - ì˜µì…˜ ê°œë‹¹ ë§ˆì§„:', {
                optionIdx: optionIdx,
                optionAlias: opt.optionAlias,
                marginPerUnit: opt.marginPerUnit,
                parsedMarginPerUnit: baseMarginPerUnit,
                salesQty: salesQty,
                priceFluctuation: priceFluctuation,
                adCost: adCost
            });
            const marginFromBase = baseMarginPerUnit * salesQty;  // ê°œë‹¹ ë§ˆì§„ * íŒë§¤ ìˆ˜ëŸ‰
            const marginFromFluctuation = priceFluctuation * salesQty;  // íŒë§¤ê°€ ë³€ë™ * íŒë§¤ ìˆ˜ëŸ‰
            const netProfit = marginFromBase + marginFromFluctuation - adCost;
            console.log('updateOptionCalculations - ìˆœì´ìµ ê³„ì‚°:', {
                marginFromBase: marginFromBase,
                marginFromFluctuation: marginFromFluctuation,
                adCost: adCost,
                netProfit: netProfit
            });
            const roas = adCost > 0 ? actualRevenue / adCost : 0;
            // ë§ˆì§„ìœ¨ ê³„ì‚°: ì¡°ì •ëœ ê°œë‹¹ ë§ˆì§„ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
            const adjustedMarginPerUnit = baseMarginPerUnit + priceFluctuation;
            let marginRate = 0;
            if (adjustedMarginPerUnit > 0 && finalPrice > 0) {
                marginRate = (adjustedMarginPerUnit / finalPrice) * 100;
            } else if (actualRevenue > 0) {
                marginRate = (netProfit / actualRevenue) * 100;
            }
            // ê¸°ì¡´ dataSeq ë° í’ˆì ˆ ìƒíƒœ ìœ ì§€ (ìˆ˜ì • ëª¨ë“œì¼ ë•Œ)
            const existingDataSeq = optionDataSets[optionIdx] ? optionDataSets[optionIdx].dataSeq : null;
            const existingIsSoldOut = optionDataSets[optionIdx] ? optionDataSets[optionIdx].isSoldOut : false;
            const existingLastValues = optionDataSets[optionIdx] ? optionDataSets[optionIdx].lastValues : null;
            optionDataSets[optionIdx] = {
                sellingPrice: sellingPrice,
                priceFluctuation: priceFluctuation,
                finalSellingPrice: finalPrice,
                salesQuantity: isSoldOut ? (existingLastValues ? existingLastValues.salesQuantity : '') : salesQty,
                actualSalesRevenue: actualRevenue,
                advertisingCost: isSoldOut ? (existingLastValues ? existingLastValues.advertisingCost : '') : adCost,
                adSales: isSoldOut ? (existingLastValues ? existingLastValues.adSales : '') : adSalesQty,
                organicSales: organicSalesQty,
                netProfit: netProfit,
                marginRate: marginRate,
                roas: roas,
                dataSeq: existingDataSeq || null,
                isSoldOut: existingIsSoldOut,
                lastValues: existingLastValues
            };
            const finalPriceEl = container.querySelector('.opt-final-price');
            const organicSalesEl = container.querySelector('.opt-organic-sales');
            const netProfitEl = container.querySelector('.opt-net-profit');
            const roasEl = container.querySelector('.opt-roas');
            if (finalPriceEl) finalPriceEl.textContent = Math.round(finalPrice).toLocaleString('ko-KR') + 'ì›';
            if (organicSalesEl) organicSalesEl.textContent = Math.max(0, Math.round(organicSalesQty));
            if (netProfitEl) netProfitEl.textContent = Math.round(netProfit).toLocaleString('ko-KR') + 'ì›';
            if (roasEl) roasEl.textContent = roas > 0 ? roas.toFixed(2) : '-';
            checkCanSave();
            updateSaveButtonText();
        }

        /** ì˜µì…˜ ëª¨ë“œ: íŒë§¤ê°œìˆ˜ ë¯¸ì…ë ¥ì¸ ì˜µì…˜ ì¸ë±ìŠ¤(0-based) ë°°ì—´ ë°˜í™˜ */
        function getZeroQuantityOptionIndices() {
            if (currentProductOptions.length === 0 || optionDataSets.length === 0) return [];
            var indices = [];
            for (var i = 0; i < currentProductOptions.length; i++) {
                var d = optionDataSets[i];
                if (!d) { indices.push(i); continue; }
                var sqVal = d.salesQuantity;
                var hasQty = sqVal !== undefined && sqVal !== null && sqVal !== '' && String(sqVal).trim() !== '';
                if (!hasQty || isNaN(parseFloat(sqVal))) indices.push(i);
            }
            return indices;
        }
        /** ì˜µì…˜(1), ì˜µì…˜(2), ... í˜•ì‹ ë¬¸ìì—´ (1-based) */
        function formatOptionZeroConfirmMessage(zeroIndices) {
            if (zeroIndices.length === 0) return '';
            var labels = zeroIndices.map(function(i) { return 'ì˜µì…˜(' + (i + 1) + ')'; });
            return labels.join(', ') + ' íŒë§¤ê°œìˆ˜ 0ìœ¼ë¡œ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
        }
        /** ì§€ì •í•œ ì˜µì…˜ ì¸ë±ìŠ¤ë“¤ì„ íŒë§¤ 0ìœ¼ë¡œ ì±„ì›€ (ê´‘ê³ ë¹„ëŠ” ê¸°ì…ê°’ ìœ ì§€ â†’ ìˆœì´ìµ - ê°€ëŠ¥). DOMì„ ì½ì§€ ì•ŠìŒ(ë‹¤ë¥¸ íƒ­ ê°’ìœ¼ë¡œ ë®ì–´ì“°ê¸° ë°©ì§€). */
        function fillOptionDataWithZero(indices) {
            indices.forEach(function(idx) {
                var opt = currentProductOptions[idx];
                if (!opt) return;
                var sellingPrice = (opt.sellingPrice != null && opt.sellingPrice !== '') ? parseFloat(opt.sellingPrice) : 0;
                if (!optionDataSets[idx]) optionDataSets[idx] = {};
                var ds = optionDataSets[idx];
                ds.sellingPrice = sellingPrice;
                ds.priceFluctuation = ds.priceFluctuation != null ? ds.priceFluctuation : 0;
                ds.finalSellingPrice = sellingPrice + (parseFloat(ds.priceFluctuation) || 0);
                ds.salesQuantity = 0;
                ds.adSales = 0;
                ds.organicSales = 0;
                ds.actualSalesRevenue = 0;
                if (ds.advertisingCost === undefined || ds.advertisingCost === null || ds.advertisingCost === '') ds.advertisingCost = 0;
                else ds.advertisingCost = parseFloat(ds.advertisingCost) || 0;
                ds.netProfit = -(ds.advertisingCost || 0);
                ds.marginRate = 0;
                ds.roas = 0;
            });
        }

        function checkCanSave() {
            const saveBtn = document.getElementById('saveButton');
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.style.opacity = '1';
                saveBtn.style.cursor = 'pointer';
            }
        }
        
        function updateSaveButtonText() {
            const saveBtn = document.getElementById('saveButton');
            const deleteBtn = document.getElementById('deleteButton');
            const nextProductBtn = document.getElementById('nextProductButton');
            if (!saveBtn) return;
            // ìˆ˜ì • ëª¨ë“œ ê°ì§€: editIdê°€ ìˆê±°ë‚˜ optionDataSetsì— dataSeqê°€ ìˆëŠ” ê²½ìš°
            const isEditMode = editId !== null || (optionDataSets.length > 0 && optionDataSets.some(d => d && d.dataSeq));
            if (isEditMode) {
                saveBtn.textContent = 'ìˆ˜ì •';
                if (deleteBtn) deleteBtn.style.display = 'block';
                if (nextProductBtn) nextProductBtn.style.display = 'none';
            } else {
                saveBtn.textContent = 'ë“±ë¡';
                if (deleteBtn) deleteBtn.style.display = 'none';
            }
        }

        async function loadRecordForEdit(id) {
            const uid = localStorage.getItem('salesChart_userId');
            if (!uid) return;
            try {
                const res = await fetch('/api/margin-tracker/record/' + id + '?userId=' + encodeURIComponent(uid));
                const data = await res.json();
                if (!data.success || !data.record) {
                    console.warn('ìˆ˜ì • ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', data);
                    return;
                }
                const r = data.record;
                const productNumber = r.productNumber;
                const saleDate = r.date;
                
                // ìƒí’ˆë²ˆí˜¸ê°€ ìˆê³  ì˜µì…˜ ê¸°ë°˜ ì…ë ¥ì´ ê°€ëŠ¥í•œ ê²½ìš°
                if (productNumber) {
                    // í•´ë‹¹ ìƒí’ˆì˜ ì˜µì…˜ ëª©ë¡ ì¡°íšŒ
                    const optRes = await fetch('/api/margin-tracker/product-options?userId=' + encodeURIComponent(uid) + '&productNumber=' + encodeURIComponent(productNumber));
                    const optData = await optRes.json();
                    
                    if (optData.success && optData.options && optData.options.length > 0) {
                        // ì˜µì…˜ ê¸°ë°˜ ì…ë ¥ ëª¨ë“œë¡œ ì „í™˜
                        currentProductOptions = optData.options;
                        currentProductCommissionRate = (optData.commissionRate != null && optData.commissionRate !== '') ? optData.commissionRate : null;
                        currentProductInfo = allRegisteredProducts.find(p => p.productNumber === productNumber) || { productNumber: productNumber, productName: r.productName || '' };
                        document.getElementById('productInfoSection').style.display = 'block';
                        document.getElementById('productInfoDisplay').textContent = (currentProductInfo.productNumber || '') + ' / ' + (currentProductInfo.productName || '');
                        document.getElementById('productNumberField').style.display = 'none';
                        document.getElementById('optionTabsSection').style.display = 'block';
                        document.getElementById('optionFieldsSection').style.display = 'block';
                        document.getElementById('legacyFields').style.display = 'none';
                        // ìˆ˜ì • ëª¨ë“œì¼ ë•ŒëŠ” ë‹¤ìŒìƒí’ˆ ë²„íŠ¼ ìˆ¨ê¹€
                        const isEditMode = editId !== null;
                        if (!isEditMode && allRegisteredProducts.length > 1) {
                            document.getElementById('nextProductButton').style.display = 'block';
                            currentProductIndex = allRegisteredProducts.findIndex(p => p.productNumber === productNumber);
                        } else {
                            document.getElementById('nextProductButton').style.display = 'none';
                        }
                        
                        // ë‚ ì§œ ì„¤ì • (ìˆ˜ì • ëª¨ë“œ: readonly)
                        if (saleDate) {
                            formData.date = saleDate;
                            const dateInput = document.getElementById('field-date');
                            const dateLabel = document.querySelector('[data-field="date"] .field-label');
                            if (dateInput) {
                                dateInput.value = saleDate;
                                dateInput.readOnly = true;
                                // flatpickr ì¸ìŠ¤í„´ìŠ¤ ì™„ì „íˆ ì œê±°
                                if (dateInput._flatpickr) {
                                    try {
                                        dateInput._flatpickr.destroy();
                                    } catch (e) {}
                                    dateInput._flatpickr = null;
                                }
                                if (datePickerInstance) {
                                    try {
                                        datePickerInstance.destroy();
                                    } catch (e) {}
                                    datePickerInstance = null;
                                }
                                // flatpickr í´ë˜ìŠ¤ ì œê±°
                                dateInput.classList.remove('flatpickr-input');
                                // readonly ì†ì„± ê°•ì œ ì„¤ì •
                                dateInput.setAttribute('readonly', 'readonly');
                                if (dateLabel) {
                                    dateLabel.textContent = 'ë‚ ì§œ : DATA';
                                }
                            }
                        }
                        
                        // ê°™ì€ ë‚ ì§œì˜ ëª¨ë“  ì˜µì…˜ ë°ì´í„° ë¡œë“œ (í•œ ë ˆì½”ë“œëŠ” í•œ ì˜µì…˜ì—ë§Œ ë§¤ì¹­)
                        const allRecordsForDate = data.allRecordsForDate || [];
                        optionDataSets = [];
                        lastPfByOption = {};
                        try {
                            const pfRes = await fetch('/api/margin-tracker/latest-price-fluctuation-by-option?userId=' + encodeURIComponent(uid) + '&productNumber=' + encodeURIComponent(productNumber));
                            const pfData = await pfRes.json();
                            if (pfData.success && pfData.options && Array.isArray(pfData.options)) {
                                pfData.options.forEach(function(o) {
                                    var k = (o.optionId != null ? o.optionId : '') + '|' + (o.optionAlias != null ? o.optionAlias : '');
                                    if (o.priceFluctuation != null && o.priceFluctuation !== '') lastPfByOption[k] = o.priceFluctuation;
                                });
                            }
                        } catch (e) { /* ë¬´ì‹œ */ }

                        const usedRecordIds = new Set();
                        currentProductOptions.forEach(function(opt, idx) {
                            const existingRecord = allRecordsForDate.find(function(rec) {
                                if (usedRecordIds.has(rec.id)) return false;
                                if (opt.optionId && rec.optionId && String(opt.optionId) === String(rec.optionId)) return true;
                                if (opt.optionAlias && rec.optionAlias && String(opt.optionAlias) === String(rec.optionAlias)) return true;
                                if (!opt.optionId && !opt.optionAlias && !rec.optionId && !rec.optionAlias && idx === 0) return true;
                                return false;
                            });
                            if (existingRecord) usedRecordIds.add(existingRecord.id);
                            
                            if (existingRecord) {
                                const isSoldOut = existingRecord.isSoldOut === true || existingRecord.isSoldOut === 1;
                                const sellingPrice = parseFloat(existingRecord.sellingPrice) || opt.sellingPrice || 0;
                                const priceFluctuation = (existingRecord.priceFluctuation !== undefined && existingRecord.priceFluctuation !== null && existingRecord.priceFluctuation !== '') ? parseFloat(existingRecord.priceFluctuation) : 0;
                                const finalPrice = sellingPrice + priceFluctuation;
                                // í’ˆì ˆì¸ ê²½ìš°ì—ë„ ë¼ìŠ¤íŠ¸ê°’ì€ ìœ ì§€ (ë‚˜ì¤‘ì— í’ˆì ˆ í•´ì œ ì‹œ ë³µì›ìš©)
                                const salesQty = parseFloat(existingRecord.salesQuantity) || 0;
                                const adCost = parseFloat(existingRecord.advertisingCost) || 0;
                                const adSalesQty = parseFloat(existingRecord.adSales) || 0;
                                const organicSalesQty = Math.max(0, salesQty - adSalesQty);
                                const actualRevenue = finalPrice * (isSoldOut ? 0 : salesQty);
                                // ìˆœì´ìµ ê³„ì‚°: (ê°œë‹¹ ë§ˆì§„ * íŒë§¤ ìˆ˜ëŸ‰) + (íŒë§¤ê°€ ë³€ë™ * íŒë§¤ ìˆ˜ëŸ‰) - ê´‘ê³ ë¹„
                                // ìˆ˜ìˆ˜ë£Œ 1.1ë°° ë³´ì •: ìƒí’ˆ ë“±ë¡ í˜ì´ì§€ì™€ ë™ì¼í•˜ê²Œ ì ìš©
                                let baseMarginPerUnit = 0;
                                if (opt.marginPerUnit != null && opt.marginPerUnit !== undefined && opt.marginPerUnit !== '') {
                                    baseMarginPerUnit = getEffectiveMarginPerUnit(opt.marginPerUnit, finalPrice);
                                }
                                const marginFromBase = baseMarginPerUnit * (isSoldOut ? 0 : salesQty);
                                const marginFromFluctuation = priceFluctuation * (isSoldOut ? 0 : salesQty);
                                const netProfit = marginFromBase + marginFromFluctuation - (isSoldOut ? 0 : adCost);
                                const roas = (isSoldOut ? 0 : adCost) > 0 ? actualRevenue / (isSoldOut ? 1 : adCost) : 0;
                                // ë§ˆì§„ìœ¨ ê³„ì‚°
                                const adjustedMarginPerUnit = baseMarginPerUnit + priceFluctuation;
                                let marginRate = parseFloat(existingRecord.marginRate) || 0;
                                if (marginRate <= 0) {
                                    if (adjustedMarginPerUnit > 0 && finalPrice > 0) {
                                        marginRate = (adjustedMarginPerUnit / finalPrice) * 100;
                                    } else if (actualRevenue > 0) {
                                        marginRate = (netProfit / actualRevenue) * 100;
                                    }
                                }
                                
                                optionDataSets[idx] = {
                                    sellingPrice: sellingPrice,
                                    priceFluctuation: priceFluctuation,
                                    finalSellingPrice: finalPrice,
                                    salesQuantity: salesQty, // ë¼ìŠ¤íŠ¸ê°’ ìœ ì§€
                                    actualSalesRevenue: actualRevenue,
                                    advertisingCost: adCost, // ë¼ìŠ¤íŠ¸ê°’ ìœ ì§€
                                    adSales: adSalesQty, // ë¼ìŠ¤íŠ¸ê°’ ìœ ì§€
                                    organicSales: organicSalesQty,
                                    netProfit: netProfit,
                                    marginRate: marginRate,
                                    roas: roas,
                                    dataSeq: existingRecord.id,
                                    isSoldOut: isSoldOut,
                                    lastValues: isSoldOut ? {
                                        priceFluctuation: priceFluctuation.toString(),
                                        salesQuantity: salesQty.toString(),
                                        advertisingCost: adCost.toString(),
                                        adSales: adSalesQty.toString()
                                    } : null
                                };
                            } else {
                                var k = (opt.optionId != null ? opt.optionId : '') + '|' + (opt.optionAlias != null ? opt.optionAlias : '');
                                var prevPriceFluctuation = (lastPfByOption[k] != null && lastPfByOption[k] !== '') ? lastPfByOption[k] : '';
                                optionDataSets[idx] = {
                                    sellingPrice: opt.sellingPrice || 0,
                                    priceFluctuation: prevPriceFluctuation,
                                    finalSellingPrice: opt.sellingPrice || 0,
                                    salesQuantity: '',
                                    advertisingCost: '',
                                    adSales: '',
                                    organicSales: 0,
                                    netProfit: 0,
                                    marginRate: 0,
                                    roas: 0,
                                    dataSeq: null,
                                    isSoldOut: false,
                                    lastValues: null
                                };
                            }
                        });
                        
                        // ì²« ë²ˆì§¸ ì˜µì…˜ í‘œì‹œ
                        currentOptionIndex = 0;
                        renderOptionTabs();
                        renderOptionFields(0);
                        
                        // ìˆ˜ì • ëª¨ë“œì¸ ê²½ìš° ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½ ë° í™œì„±í™” ìƒíƒœ í™•ì¸
                        updateSaveButtonText();
                        checkCanSave();
                        
                        // ìˆ˜ì • ëª¨ë“œì¼ ë•ŒëŠ” ë‹¤ìŒìƒí’ˆ ë²„íŠ¼ ìˆ¨ê¹€
                        const isEditModeForOption = editId !== null || (optionDataSets.length > 0 && optionDataSets.some(d => d && d.dataSeq));
                        if (!isEditModeForOption && updateNextProductButtonFn) {
                            updateNextProductButtonFn();
                        } else {
                            const nextProductBtn = document.getElementById('nextProductButton');
                            if (nextProductBtn) nextProductBtn.style.display = 'none';
                        }
                        return;
                    }
                }
                
                // ì˜µì…˜ì´ ì—†ê±°ë‚˜ ë ˆê±°ì‹œ ëª¨ë“œì¸ ê²½ìš°
                function val(v) { return v != null && v !== '' ? String(v) : ''; }
                const productLabel = (r.productNumber && r.productName) ? (r.productNumber + ' / ' + r.productName) : (r.productNumber || r.productName || '');
                formData.productNumber = productLabel;
                const productInput = document.getElementById('field-productNumber');
                if (productInput) productInput.value = productLabel;

                if (r.date) {
                    formData.date = val(r.date);
                    const dateInput = document.getElementById('field-date');
                    const dateLabel = document.querySelector('[data-field="date"] .field-label');
                    if (dateInput) {
                        dateInput.value = formData.date;
                        dateInput.readOnly = true;
                        // flatpickr ì¸ìŠ¤í„´ìŠ¤ ì™„ì „íˆ ì œê±°
                        if (dateInput._flatpickr) {
                            try {
                                dateInput._flatpickr.destroy();
                            } catch (e) {}
                            dateInput._flatpickr = null;
                        }
                        if (datePickerInstance) {
                            try {
                                datePickerInstance.destroy();
                            } catch (e) {}
                            datePickerInstance = null;
                        }
                        // flatpickr í´ë˜ìŠ¤ ì œê±°
                        dateInput.classList.remove('flatpickr-input');
                        // readonly ì†ì„± ê°•ì œ ì„¤ì •
                        dateInput.setAttribute('readonly', 'readonly');
                    }
                    if (dateLabel) {
                        dateLabel.textContent = 'ë‚ ì§œ : DATA';
                    }
                }
                
                // ìˆ˜ì • ëª¨ë“œì¼ ë•ŒëŠ” ë‹¤ìŒìƒí’ˆ ë²„íŠ¼ ìˆ¨ê¹€
                const nextProductBtn = document.getElementById('nextProductButton');
                if (nextProductBtn) nextProductBtn.style.display = 'none';

                ['sellingPrice','discountCoupon','priceFluctuation','salesQuantity','marginPerUnit','advertisingCost','adSales','organicSales'].forEach(function(k) {
                    const v = val(r[k]);
                    if (v) {
                        formData[k] = v;
                        const el = document.getElementById('field-' + k);
                        if (el) el.value = v;
                    }
                });

                calculateDerivedFields();

                ['finalSellingPrice','actualSalesRevenue','totalMargin','netProfit','marginRate','organicSalesRatio','roas'].forEach(function(k) {
                    const v = r[k];
                    if (v != null && v !== '') {
                        formData[k] = String(v);
                        const valueEl = document.getElementById('value-' + k);
                        if (valueEl) {
                            const n = parseFloat(v);
                            if (k === 'marginRate' || k === 'organicSalesRatio') valueEl.textContent = isNaN(n) ? '-' : n.toFixed(1) + '%';
                            else if (k === 'roas') valueEl.textContent = isNaN(n) ? '-' : n.toFixed(2);
                            else valueEl.textContent = isNaN(n) ? '-' : Math.round(n).toLocaleString('ko-KR');
                        }
                    }
                });

                fields.forEach(function(f, i) { updateFieldState(i); });
                checkCanProceed(0);
            } catch (e) {
                console.error('ìˆ˜ì • ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜', e);
            }
        }

        // Event Listeners
        function initEventListeners() {
            // Back Button
            document.getElementById('backButton').addEventListener('click', function(e) {
                if (hasUnsavedChanges()) {
                    if (!confirm('ì…ë ¥ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì…ë ¥í•œ ë‚´ìš©ì´ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')) {
                        e.preventDefault();
                        return;
                    }
                }
                window.location.href = '/margin-tracker';
            });

            const productInput = document.getElementById('field-productNumber');
            if (productInput) {
                productInput.addEventListener('change', function() {
                    const val = this.value.trim();
                    if (val && val.indexOf(' / ') !== -1) {
                        const parts = val.split(' / ');
                        const productNumber = parts[0].trim();
                        handleProductSelect(productNumber, null);
                    }
                });
            }

            // Input Fields
            fields.forEach((field, index) => {
                const fieldElement = document.querySelector(`[data-field="${field}"]`);
                const inputElement = document.getElementById(`field-${field}`);
                const valueElement = document.getElementById(`value-${field}`);
                const isCalculated = calculatedFields.includes(field);

                if (fieldElement) {
                    // Click to focus
                    fieldElement.addEventListener('click', () => {
                        if (index <= currentStep) {
                            setCurrentStep(index);
                            if (isCalculated && valueElement && inputElement) {
                                // ê³„ì‚°ëœ í•„ë“œ: í´ë¦­í•˜ë©´ ì…ë ¥ ëª¨ë“œë¡œ ì „í™˜
                                if (valueElement.classList.contains('hidden')) {
                                    // ì´ë¯¸ ì…ë ¥ ëª¨ë“œ
                                    inputElement.focus();
                                } else {
                                    // í‘œì‹œ ëª¨ë“œ -> ì…ë ¥ ëª¨ë“œë¡œ ì „í™˜
                                    const currentValue = valueElement.textContent;
                                    if (currentValue && currentValue !== '-') {
                                        // ìˆ«ìë§Œ ì¶”ì¶œ (ì½¤ë§ˆ, % ë“± ì œê±°)
                                        const numValue = currentValue.replace(/[^0-9.-]/g, '');
                                        inputElement.value = numValue;
                                    }
                                    valueElement.classList.add('hidden');
                                    inputElement.classList.add('active');
                                    inputElement.style.display = 'block';
                                    setTimeout(() => inputElement.focus(), 50);
                                }
                            } else if (inputElement) {
                                // ì¼ë°˜ ì…ë ¥ í•„ë“œ
                                inputElement.focus();
                            }
                        }
                    });

                    if (inputElement) {
                        // Input events (ê°’ë§Œ ë°˜ì˜, ìë™ ì´ë™ ì—†ìŒ)
                        inputElement.addEventListener('input', (e) => {
                            formData[field] = e.target.value;
                            if (!isCalculated) {
                                calculateDerivedFields();
                            }
                            updateFieldState(index);
                            checkCanProceed(index);
                        });

                        // Blur event for calculated fields
                        if (isCalculated) {
                            inputElement.addEventListener('blur', () => {
                                // ì…ë ¥ ëª¨ë“œ -> í‘œì‹œ ëª¨ë“œë¡œ ì „í™˜
                                if (inputElement.value) {
                                    formData[field] = inputElement.value;
                                    updateCalculatedFieldDisplay(field, parseFloat(inputElement.value));
                                } else {
                                    calculateDerivedFields();
                                }
                                valueElement.classList.remove('hidden');
                                inputElement.classList.remove('active');
                                inputElement.style.display = 'none';
                            });
                        }

                        inputElement.addEventListener('keydown', (e) => {
                            // ê³„ì‚°ëœ í•„ë“œëŠ” ì—”í„°ë¡œ ë„˜ì–´ê°€ì§€ ì•ŠìŒ
                            if (isCalculated && e.key === 'Enter') {
                                e.preventDefault();
                                inputElement.blur();
                                return;
                            }

                            // ë‚ ì§œ í•„ë“œëŠ” ì—”í„°ë¡œ ë‚ ì§œ ì„ íƒê¸° ì—´ê¸° (readonlyê°€ ì•„ë‹ ë•Œë§Œ)
                            if (field === 'date' && e.key === 'Enter') {
                                const dateInput = document.getElementById('field-date');
                                if (dateInput && !dateInput.readOnly) {
                                    e.preventDefault();
                                    openDatePicker();
                                    return;
                                }
                            }

                            if (e.key === 'Enter') {
                                e.preventDefault();
                                // ì—”í„° í‚¤ë¡œ ë‹¤ìŒ í•„ë“œë¡œ ì´ë™
                                moveToNextInputField(index);
                            }
                            // Tab key also moves to next field
                            if (e.key === 'Tab' && !e.shiftKey) {
                                e.preventDefault();
                                moveToNextInputField(index);
                            }
                        });
                    }
                }
            });

            // Save Button
            document.getElementById('saveButton').addEventListener('click', function() {
                if (currentProductOptions.length > 0 && optionDataSets.length > 0) {
                    var zeroIndices = getZeroQuantityOptionIndices();
                    if (zeroIndices.length > 0) {
                        var msg = formatOptionZeroConfirmMessage(zeroIndices);
                        if (msg && !confirm(msg)) return;
                        fillOptionDataWithZero(zeroIndices);
                    }
                    saveData();
                    return;
                }
                var sq = formData.salesQuantity;
                if (sq === undefined || sq === null || sq === '' || (String(sq).trim() === '')) {
                    if (!confirm('ìƒí’ˆì˜ íŒë§¤ê°œìˆ˜ë¥¼ 0ê°œë¡œ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                    formData.salesQuantity = 0;
                    formData.advertisingCost = formData.advertisingCost !== undefined && formData.advertisingCost !== '' ? formData.advertisingCost : 0;
                    formData.adSales = 0;
                    formData.organicSales = 0;
                    if (typeof calculateDerivedFields === 'function') calculateDerivedFields();
                }
                saveData();
            });

            // Next Product Button
            const nextProductBtn = document.getElementById('nextProductButton');
            if (nextProductBtn) {
                updateNextProductButtonFn = function() {
                    if (allRegisteredProducts.length === 0 || !currentProductInfo) {
                        nextProductBtn.style.display = 'none';
                        return;
                    }
                    const currentIdx = allRegisteredProducts.findIndex(p => p.productNumber === currentProductInfo.productNumber);
                    if (currentIdx === -1 || currentIdx === allRegisteredProducts.length - 1) {
                        nextProductBtn.style.display = 'none';
                        return;
                    }
                    const next = allRegisteredProducts[currentIdx + 1];
                    if (next) {
                        nextProductBtn.textContent = 'ë‹¤ìŒìƒí’ˆ(' + (next.productName || next.productNumber) + ')';
                        nextProductBtn.style.display = 'block';
                    } else {
                        nextProductBtn.style.display = 'none';
                    }
                };
                nextProductBtn.addEventListener('click', async function() {
                    if (allRegisteredProducts.length === 0 || !currentProductInfo) return;
                    const currentIdx = allRegisteredProducts.findIndex(p => p.productNumber === currentProductInfo.productNumber);
                    if (currentIdx === -1 || currentIdx === allRegisteredProducts.length - 1) return;
                    const next = allRegisteredProducts[currentIdx + 1];
                    if (next) {
                        const dateInput = document.getElementById('field-date');
                        const dateStr = (dateInput && dateInput.value) ? dateInput.value.trim() : null;
                        if (dateStr) sessionStorage.setItem('marginTracker_nextProductDate', dateStr);
                        const nextUrl = '/margin-tracker/input?product=' + encodeURIComponent(next.productNumber) + (dateStr ? '&date=' + encodeURIComponent(dateStr) : '');
                        if (currentProductOptions.length > 0 && optionDataSets.length > 0) {
                            var zeroIndices = getZeroQuantityOptionIndices();
                            if (zeroIndices.length > 0) {
                                var msg = formatOptionZeroConfirmMessage(zeroIndices);
                                if (msg && !confirm(msg)) return;
                                fillOptionDataWithZero(zeroIndices);
                            }
                        } else {
                            var sq = formData.salesQuantity;
                            if (sq === undefined || sq === null || sq === '' || (String(sq).trim() === '')) {
                                if (!confirm('í˜„ì¬ ìƒí’ˆì˜ íŒë§¤ê°œìˆ˜ë¥¼ 0ê°œë¡œ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                                formData.salesQuantity = 0;
                                formData.advertisingCost = formData.advertisingCost !== undefined && formData.advertisingCost !== '' ? formData.advertisingCost : 0;
                                formData.adSales = 0;
                                formData.organicSales = 0;
                                if (typeof calculateDerivedFields === 'function') calculateDerivedFields();
                            }
                        }
                        await saveData(nextUrl);
                    }
                });
                // ìˆ˜ì • ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ë‹¤ìŒìƒí’ˆ ë²„íŠ¼ ì—…ë°ì´íŠ¸
                const isEditModeForNextBtn = editId !== null;
                if (!isEditModeForNextBtn && updateNextProductButtonFn) {
                    updateNextProductButtonFn();
                } else {
                    const nextProductBtn = document.getElementById('nextProductButton');
                    if (nextProductBtn) nextProductBtn.style.display = 'none';
                }
            }
            
            // Delete Button
            const deleteBtn = document.getElementById('deleteButton');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', async function() {
                    if (!confirm('ì´ íŒë§¤ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                    const uid = localStorage.getItem('salesChart_userId');
                    if (!uid) {
                        alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    // ì˜µì…˜ ëª¨ë“œ: ì—¬ëŸ¬ dataSeqê°€ ìˆì„ ìˆ˜ ìˆìŒ
                    if (currentProductOptions.length > 0 && optionDataSets.length > 0) {
                        var dataSeqs = optionDataSets.filter(function(d) { return d && d.dataSeq; }).map(function(d) { return d.dataSeq; });
                        if (dataSeqs.length === 0) {
                            alert('ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                            return;
                        }
                        var deleteCount = 0;
                        var failCount = 0;
                        for (var i = 0; i < dataSeqs.length; i++) {
                            try {
                                const res = await fetch('/api/margin-tracker/record/' + dataSeqs[i] + '?userId=' + encodeURIComponent(uid), {
                                    method: 'DELETE'
                                });
                                const data = await res.json();
                                if (data.success) {
                                    deleteCount++;
                                } else {
                                    failCount++;
                                }
                            } catch (e) {
                                failCount++;
                            }
                        }
                        if (failCount === 0) {
                            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            window.location.href = '/margin-tracker';
                        } else {
                            alert('ì¼ë¶€ ë°ì´í„° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    } else {
                        // ë ˆê±°ì‹œ ëª¨ë“œ: editId ì‚¬ìš©
                        if (!editId) {
                            alert('ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                            return;
                        }
                        try {
                            const res = await fetch('/api/margin-tracker/record/' + editId + '?userId=' + encodeURIComponent(uid), {
                                method: 'DELETE'
                            });
                            const data = await res.json();
                            if (data.success) {
                                alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                window.location.href = '/margin-tracker';
                            } else {
                                alert(data.message || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                            }
                        } catch (e) {
                            console.error(e);
                            alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        }
                    }
                });
            }

            // Back to Tracker Button
            const backToTrackerBtn = document.getElementById('backToTrackerButton');
            if (backToTrackerBtn) {
                backToTrackerBtn.addEventListener('click', function() {
                    if (hasUnsavedChanges()) {
                        if (!confirm('ì…ë ¥ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì…ë ¥í•œ ë‚´ìš©ì´ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')) {
                            return;
                        }
                    }
                    window.location.href = '/margin-tracker';
                });
            }

            // ë‚ ì§œ í•„ë“œ: í´ë¦­ + í„°ì¹˜ ëª¨ë‘ì—ì„œ ë‹¬ë ¥ ì—´ê¸° (ëª¨ë°”ì¼ì—ì„œ í„°ì¹˜ í•„ìˆ˜)
            function bindDateFieldOpen() {
                const dateInput = document.getElementById('field-date');
                const dateFieldContainer = document.querySelector('.date-field-container');
                if (!dateInput) return;
                
                // readonlyì¼ ë•ŒëŠ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì•„ì˜ˆ ë“±ë¡í•˜ì§€ ì•ŠìŒ
                if (dateInput.readOnly) {
                    return;
                }

                function openAndMaybePrevent(e) {
                    // readonlyì¼ ë•ŒëŠ” ë‚ ì§œ ì„ íƒ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—´ì§€ ì•ŠìŒ
                    if (dateInput.readOnly) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        return false;
                    }
                    setCurrentStep(1);
                    openDatePicker();
                    e.preventDefault();
                    e.stopPropagation();
                }

                [dateInput, dateFieldContainer].filter(Boolean).forEach(function(el) {
                    el.addEventListener('click', function(e) {
                        if (dateInput.readOnly) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            return false;
                        }
                        openAndMaybePrevent(e);
                    }, true);
                    el.addEventListener('touchend', function(e) {
                        if (dateInput.readOnly) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            return false;
                        }
                        openAndMaybePrevent(e);
                    }, { passive: false, capture: true });
                });
            }
            // readonlyê°€ ì•„ë‹ ë•Œë§Œ ë‚ ì§œ í•„ë“œ ì´ë²¤íŠ¸ ë°”ì¸ë”©
            const dateInputCheck = document.getElementById('field-date');
            if (!dateInputCheck || !dateInputCheck.readOnly) {
                bindDateFieldOpen();
            }
        }

        // ë‹¤ìŒ ì…ë ¥ í•„ë“œë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
        function moveToNextInputField(currentIndex) {
            if (currentIndex < fields.length - 1) {
                let nextIndex = currentIndex + 1;
                while (nextIndex < fields.length) {
                    const nextField = fields[nextIndex];
                    const nextInput = document.getElementById(`field-${nextField}`);
                    if (nextInput && !nextInput.readOnly && !calculatedFields.includes(nextField)) {
                        setCurrentStep(nextIndex);
                        setTimeout(() => {
                            nextInput.focus();
                            // í•„ë“œ ì»¨í…Œì´ë„ˆ ì°¾ê¸°
                            const fieldElement = document.querySelector(`[data-field="${nextField}"]`);
                            if (fieldElement) {
                                // í•„ë“œ ì»¨í…Œì´ë„ˆë¡œ ìŠ¤í¬ë¡¤
                                fieldElement.scrollIntoView({ 
                                    behavior: 'smooth', 
                                    block: 'center',
                                    inline: 'nearest'
                                });
                            } else {
                                // í•„ë“œ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìœ¼ë©´ ì…ë ¥ í•„ë“œë¡œ ìŠ¤í¬ë¡¤
                                nextInput.scrollIntoView({ 
                                    behavior: 'smooth', 
                                    block: 'center',
                                    inline: 'nearest'
                                });
                            }
                        }, 150);
                        break;
                    }
                    nextIndex++;
                }
            }
        }

        // Date Picker
        let datePickerInstance = null;
        
        function openDatePicker() {
            const dateInput = document.getElementById('field-date');
            if (!dateInput) {
                return;
            }
            
            // readonlyì¼ ë•ŒëŠ” ë‚ ì§œ ì„ íƒê¸° ì—´ì§€ ì•ŠìŒ
            if (dateInput.readOnly) {
                return;
            }

            // ë‚ ì§œ ì„ íƒê¸°ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
            if (!dateInput._flatpickr && !datePickerInstance) {
                initDatePicker();
            }
            
            // clickOpensë¥¼ trueë¡œ ë³€ê²½í•˜ì—¬ í´ë¦­ ì‹œ ì—´ë¦¬ë„ë¡
            try {
                if (dateInput._flatpickr && dateInput._flatpickr.config) {
                    dateInput._flatpickr.config.clickOpens = true;
                }
            } catch (e) {
                console.log('Error setting clickOpens on _flatpickr:', e);
            }
            
            try {
                if (datePickerInstance && datePickerInstance.config) {
                    datePickerInstance.config.clickOpens = true;
                }
            } catch (e) {
                console.log('Error setting clickOpens on datePickerInstance:', e);
            }

            // ë‚ ì§œ ì„ íƒê¸° ì—´ê¸°
            setTimeout(() => {
                let fpInstance = null;
                if (dateInput._flatpickr) {
                    fpInstance = dateInput._flatpickr;
                } else if (datePickerInstance) {
                    fpInstance = datePickerInstance;
                } else {
                    initDatePicker();
                    setTimeout(() => {
                        const retryInput = document.getElementById('field-date');
                        if (retryInput && retryInput._flatpickr) {
                            fpInstance = retryInput._flatpickr;
                        } else {
                            return;
                        }
                    }, 200);
                }
                
                if (fpInstance) {
                    var calendar = fpInstance.calendarContainer;
                    if (calendar) {
                        calendar.style.zIndex = '3000';
                        calendar.style.display = '';
                        calendar.style.visibility = '';
                        calendar.style.opacity = '';
                    }
                    fpInstance.open();
                }
            }, 50);
        }
        
        function initDatePicker() {
            const dateInput = document.getElementById('field-date');
            if (!dateInput) {
                return;
            }
            
            // readonlyì¼ ë•ŒëŠ” ë‚ ì§œ ì„ íƒê¸° ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ
            if (dateInput.readOnly) {
                return;
            }

            // ì´ë¯¸ ì´ˆê¸°í™”ë˜ì–´ ìˆìœ¼ë©´ ì œê±° í›„ ì¬ì´ˆê¸°í™”
            if (dateInput._flatpickr) {
                try {
                    if (dateInput._flatpickr.destroy && typeof dateInput._flatpickr.destroy === 'function') {
                        dateInput._flatpickr.destroy();
                    }
                } catch (e) {
                    console.log('Error destroying flatpickr:', e);
                }
                dateInput._flatpickr = null;
            }
            
            if (datePickerInstance) {
                try {
                    if (datePickerInstance.destroy && typeof datePickerInstance.destroy === 'function') {
                        datePickerInstance.destroy();
                    }
                } catch (e) {
                    console.log('Error destroying datePickerInstance:', e);
                }
                datePickerInstance = null;
            }

            // flatpickrì´ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (typeof flatpickr === 'undefined') {
                console.error('Flatpickr library is not loaded');
                return false;
            }

            try {
                // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ê¸°ë³¸ê°’ ì„¤ì •
                const today = new Date();
                const todayStr = today.getFullYear() + 'ë…„ ' + (today.getMonth() + 1) + 'ì›” ' + today.getDate() + 'ì¼';
                
                // ê°’ì´ ì—†ì„ ë•Œë§Œ ì„¤ì •
                if (!dateInput.value || dateInput.value === '') {
                    dateInput.value = todayStr;
                    formData.date = todayStr;
                }

                datePickerInstance = flatpickr(dateInput, {
                    locale: "ko",
                    dateFormat: "Yë…„ mì›” dì¼",
                    defaultDate: today,
                    clickOpens: !dateInput.readOnly,
                    allowInput: false,
                    inline: false,
                    static: false,
                    appendTo: document.body,
                    disableMobile: false,
                    positionElement: dateInput,
                    openOnReady: false,
                    onReady: function(selectedDates, dateStr, instance) {
                        var input = instance.input;
                        if (input) {
                            // readonlyê°€ ì•„ë‹ ë•Œë§Œ readonly ì†ì„± ì„¤ì •
                            if (!input.readOnly) {
                                input.setAttribute('readonly', 'readonly');
                            }
                        }
                        if (instance.isOpen) {
                            instance.close();
                        }
                    },
                    onChange: function(selectedDates, dateStr, instance) {
                        formData.date = dateStr;
                        calculateDerivedFields();
                        updateFieldState(1);
                        checkCanProceed(1);
                        
                        // ë‚ ì§œ ì„ íƒ ì‹œ ë‹¬ë ¥ ê°•ì œë¡œ ë‹«ê¸°
                        setTimeout(() => {
                            if (instance && instance.isOpen) {
                                instance.close();
                            }
                        }, 50);
                        
                        // ë‚ ì§œ ì„ íƒ ì™„ë£Œ ì‹œ ì¦‰ì‹œ ë‹¤ìŒ í•„ë“œë¡œ ì´ë™ (date=index 1 -> sellingPrice=index 2)
                        setCurrentStep(2);
                        setTimeout(() => {
                            const nextInput = document.getElementById('field-sellingPrice');
                            if (nextInput) {
                                const fieldElement = document.querySelector('[data-field="sellingPrice"]');
                                if (fieldElement) {
                                    fieldElement.scrollIntoView({ 
                                        behavior: 'smooth', 
                                        block: 'center',
                                        inline: 'nearest'
                                    });
                                }
                                setTimeout(() => {
                                    nextInput.focus();
                                }, 100);
                            }
                        }, 300);
                    }
                });

                return true;
            } catch (error) {
                console.error('Error initializing date picker:', error);
                return false;
            }
        }

        // Step Management
        function setCurrentStep(step) {
            currentStep = step;
            
            // Update field states
            fields.forEach((field, index) => {
                const fieldElement = document.querySelector(`[data-field="${field}"]`);
                if (fieldElement) {
                    fieldElement.classList.remove('active', 'completed');
                    if (index === step) {
                        fieldElement.classList.add('active');
                    } else if (index < step) {
                        fieldElement.classList.add('completed');
                    }
                }
            });

            // Update progress
            const progress = ((step + 1) / fields.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressInfo').textContent = `${step + 1}/${fields.length}`;
        }

        function updateFieldState(index) {
            const field = fields[index];
            const fieldElement = document.querySelector(`[data-field="${field}"]`);
            const value = formData[field];

            if (fieldElement && value && value !== '') {
                fieldElement.classList.add('completed');
            }
        }

        function checkCanProceed(step) {
            const field = fields[step];
            const value = formData[field];
            checkCanSave();
        }

        // Calculations
        function calculateDerivedFields() {
            const sellingPrice = parseFloat(formData.sellingPrice) || 0;
            const discountCoupon = parseFloat(formData.discountCoupon) || 0;
            const priceFluctuation = parseFloat(formData.priceFluctuation) || 0;
            const salesQuantity = parseFloat(formData.salesQuantity) || 0;
            const marginPerUnit = parseFloat(formData.marginPerUnit) || 0;
            const advertisingCost = parseFloat(formData.advertisingCost) || 0;
            const adSales = parseFloat(formData.adSales) || 0;
            const organicSales = parseFloat(formData.organicSales) || 0;

            // ìµœì¢… íŒë§¤ê°€ = íŒë§¤ê°€ - í• ì¸ì¿ í°
            const finalSellingPrice = sellingPrice - discountCoupon;
            formData.finalSellingPrice = finalSellingPrice > 0 ? finalSellingPrice : '';
            updateCalculatedField('finalSellingPrice', finalSellingPrice);

            // ì‹¤ì œ íŒë§¤ ë§¤ì¶œ = ìµœì¢… íŒë§¤ê°€ * íŒë§¤ìˆ˜ëŸ‰
            const actualSalesRevenue = finalSellingPrice * salesQuantity;
            formData.actualSalesRevenue = actualSalesRevenue > 0 ? actualSalesRevenue : '';
            updateCalculatedField('actualSalesRevenue', actualSalesRevenue);

            // ìˆœì´ìµ ê³„ì‚°: (ê°œë‹¹ ë§ˆì§„ * íŒë§¤ ìˆ˜ëŸ‰) + (íŒë§¤ê°€ ë³€ë™ * íŒë§¤ ìˆ˜ëŸ‰) - ê´‘ê³ ë¹„
            // ìˆ˜ìˆ˜ë£Œ 1.1ë°° ë³´ì •: ìƒí’ˆ ë“±ë¡ í˜ì´ì§€ì™€ ë™ì¼í•˜ê²Œ ì ìš©
            const effectiveMarginPerUnit = getEffectiveMarginPerUnit(marginPerUnit, finalSellingPrice);
            const marginFromBase = effectiveMarginPerUnit * salesQuantity;  // ê°œë‹¹ ë§ˆì§„ * íŒë§¤ ìˆ˜ëŸ‰
            const marginFromFluctuation = priceFluctuation * salesQuantity;  // íŒë§¤ê°€ ë³€ë™ * íŒë§¤ ìˆ˜ëŸ‰
            const totalMargin = marginFromBase + marginFromFluctuation;
            formData.totalMargin = totalMargin !== 0 ? totalMargin : '';
            updateCalculatedField('totalMargin', totalMargin);

            // ê´‘ê³ ë¹„ (1.1ë°°)
            const adjustedAdvertisingCost = advertisingCost * 1.1;
            formData.advertisingCostAdjusted = adjustedAdvertisingCost;

            // ìˆœìˆ˜ìµ = (ê°œë‹¹ ë§ˆì§„ * íŒë§¤ ìˆ˜ëŸ‰) + (íŒë§¤ê°€ ë³€ë™ * íŒë§¤ ìˆ˜ëŸ‰) - ê´‘ê³ ë¹„(1.1ë°°)
            const netProfit = totalMargin - adjustedAdvertisingCost;
            formData.netProfit = netProfit !== 0 ? netProfit : '';
            updateCalculatedField('netProfit', netProfit);

            // ë§ˆì§„ìœ¨ = (ì¡°ì •ëœ ê°œë‹¹ ë§ˆì§„ / ìµœì¢… íŒë§¤ê°€) * 100
            const adjustedMarginPerUnit = marginPerUnit + priceFluctuation;
            const marginRate = finalSellingPrice > 0 ? (adjustedMarginPerUnit / finalSellingPrice) * 100 : 0;
            formData.marginRate = marginRate !== 0 ? marginRate : '';
            updateCalculatedField('marginRate', marginRate);

            // ìì—°íŒë§¤ë¹„ìœ¨ = (ìì—°íŒë§¤ / íŒë§¤ìˆ˜ëŸ‰) * 100
            const organicSalesRatio = salesQuantity > 0 ? (organicSales / salesQuantity) * 100 : 0;
            formData.organicSalesRatio = organicSalesRatio !== 0 ? organicSalesRatio : '';
            updateCalculatedField('organicSalesRatio', organicSalesRatio);

            // ROAS = ì‹¤ì œ íŒë§¤ ë§¤ì¶œ / ê´‘ê³ ë¹„ (ê´‘ê³ ë¹„ê°€ 0ë³´ë‹¤ í´ ë•Œ)
            const roas = advertisingCost > 0 ? actualSalesRevenue / advertisingCost : 0;
            formData.roas = roas !== 0 ? roas : '';
            updateCalculatedField('roas', roas);
        }

        function updateCalculatedField(field, value) {
            const valueElement = document.getElementById(`value-${field}`);
            const inputElement = document.getElementById(`field-${field}`);
            
            if (valueElement) {
                // ì…ë ¥ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ì—…ë°ì´íŠ¸
                if (!valueElement.classList.contains('hidden')) {
                    if (value === 0 || isNaN(value) || !isFinite(value)) {
                        valueElement.textContent = '-';
                    } else {
                        if (field === 'marginRate' || field === 'organicSalesRatio') {
                            valueElement.textContent = value.toFixed(1) + '%';
                        } else if (field === 'roas') {
                            valueElement.textContent = value.toFixed(2);
                        } else {
                            valueElement.textContent = Math.round(value).toLocaleString('ko-KR');
                        }
                    }
                }
            }
            
            // ì…ë ¥ í•„ë“œì—ë„ ê°’ ì €ì¥ (ìˆ˜ë™ ì…ë ¥ ì‹œ)
            if (inputElement && formData[field] === '') {
                formData[field] = value.toString();
            }
        }

        function updateCalculatedFieldDisplay(field, value) {
            const valueElement = document.getElementById(`value-${field}`);
            if (valueElement) {
                if (value === 0 || isNaN(value) || !isFinite(value)) {
                    valueElement.textContent = '-';
                } else {
                    if (field === 'marginRate' || field === 'organicSalesRatio') {
                        valueElement.textContent = value.toFixed(1) + '%';
                    } else if (field === 'roas') {
                        valueElement.textContent = value.toFixed(2);
                    } else {
                        valueElement.textContent = Math.round(value).toLocaleString('ko-KR');
                    }
                }
            }
        }

        function hasUnsavedChanges() {
            return fields.some(f => formData[f] && formData[f] !== '');
        }

        function resetForm() {
            currentStep = 0;
            formData = {};
            
            // flatpickr ì¸ìŠ¤í„´ìŠ¤ ì •ë¦¬
            const dateInput = document.getElementById('field-date');
            if (dateInput && dateInput._flatpickr) {
                try {
                    if (dateInput._flatpickr.destroy && typeof dateInput._flatpickr.destroy === 'function') {
                        if (dateInput._flatpickr.calendarContainer) {
                            dateInput._flatpickr.destroy();
                        }
                    }
                } catch (e) {
                    console.log('Error destroying flatpickr in resetForm:', e);
                }
                dateInput._flatpickr = null;
            }
            
            if (datePickerInstance) {
                try {
                    if (datePickerInstance.destroy && typeof datePickerInstance.destroy === 'function') {
                        if (datePickerInstance.calendarContainer) {
                            datePickerInstance.destroy();
                        }
                    }
                } catch (e) {
                    console.log('Error destroying datePickerInstance in resetForm:', e);
                }
                datePickerInstance = null;
            }
            
            fields.forEach(field => {
                formData[field] = '';
                const input = document.getElementById(`field-${field}`);
                if (input) {
                    input.value = '';
                    input.style.display = '';
                    input.classList.remove('active');
                }
                const value = document.getElementById(`value-${field}`);
                if (value) {
                    value.textContent = '-';
                    value.classList.remove('hidden');
                }
            });
            setCurrentStep(0);
        }

        // Save Data (API)
        async function saveData(redirectUrl) {
            const userId = localStorage.getItem('salesChart_userId');
            if (!userId) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/margin-tracker';
                return;
            }
            if (currentProductOptions.length > 0 && optionDataSets.length > 0) {
                let dateStr = formData.date || document.getElementById('field-date').value;
                if (!dateStr) {
                    alert('ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                if (dateStr.indexOf('ë…„') !== -1) {
                    const match = dateStr.match(/(\d+)ë…„\s*(\d+)ì›”\s*(\d+)ì¼/);
                    if (match) {
                        const y = match[1];
                        const m = String(match[2]).padStart(2, '0');
                        const d = String(match[3]).padStart(2, '0');
                        dateStr = y + 'ë…„ ' + parseInt(m, 10) + 'ì›” ' + parseInt(d, 10) + 'ì¼';
                    }
                }
                function normSalesQty(v) {
                    if (v === undefined || v === null) return 0;
                    if (typeof v === 'number' && !isNaN(v) && v >= 0) return v;
                    var s = String(v).trim();
                    if (s === '') return 0;
                    var n = Number(s);
                    return isNaN(n) || n < 0 ? 0 : n;
                }
                let successCount = 0;
                for (let i = 0; i < currentProductOptions.length; i++) {
                    const opt = currentProductOptions[i];
                    const data = optionDataSets[i] || {};
                    const sq = normSalesQty(data.salesQuantity);
                    const sellingPrice = (data.sellingPrice != null && data.sellingPrice !== '') ? data.sellingPrice : (opt.sellingPrice != null && opt.sellingPrice !== '') ? opt.sellingPrice : null;
                    const priceFluctuation = (typeof data.priceFluctuation === 'number') ? data.priceFluctuation : (data.priceFluctuation !== undefined && data.priceFluctuation !== null && data.priceFluctuation !== '') ? Number(data.priceFluctuation) : null;
                    const finalPrice = (data.finalSellingPrice != null && data.finalSellingPrice !== '') ? data.finalSellingPrice : (sellingPrice != null ? Number(sellingPrice) + (priceFluctuation || 0) : null);
                    const adCost = (data.advertisingCost !== undefined && data.advertisingCost !== null && data.advertisingCost !== '') ? Number(data.advertisingCost) : 0;
                    const adSalesVal = (data.adSales !== undefined && data.adSales !== null && data.adSales !== '') ? Number(data.adSales) : 0;
                    const actualRevenue = (data.actualSalesRevenue != null && data.actualSalesRevenue !== '') ? data.actualSalesRevenue : (finalPrice != null ? finalPrice * sq : 0);
                    const organicVal = (data.organicSales !== undefined && data.organicSales !== null) ? Number(data.organicSales) : Math.max(0, sq - adSalesVal);
                    const netProfitVal = (data.netProfit !== undefined && data.netProfit !== null && data.netProfit !== '') ? Number(data.netProfit) : null;
                    const payload = {
                        userId: userId,
                        productNumber: currentProductInfo.productNumber || null,
                        productName: currentProductInfo.productName || null,
                        optionId: opt.optionId || null,
                        optionAlias: opt.optionAlias || null,
                        date: dateStr,
                        sellingPrice: sellingPrice,
                        priceFluctuation: priceFluctuation,
                        finalSellingPrice: finalPrice,
                        salesQuantity: sq,
                        actualSalesRevenue: actualRevenue,
                        advertisingCost: adCost,
                        adSales: adSalesVal,
                        organicSales: organicVal,
                        netProfit: netProfitVal,
                        marginRate: data.marginRate != null && data.marginRate !== '' ? data.marginRate : null,
                        roas: data.roas != null && data.roas !== '' ? data.roas : null,
                        isSoldOut: data.isSoldOut === true
                    };
                    if (data.dataSeq) {
                        payload.dataSeq = data.dataSeq;
                    }
                    try {
                        const res = await fetch('/api/margin-tracker/save', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const result = await res.json();
                        if (result.success) successCount++;
                    } catch (e) {
                        console.error('ì˜µì…˜ ì €ì¥ ì‹¤íŒ¨', i, e);
                    }
                }
                if (successCount > 0) {
                    if (redirectUrl) {
                        window.location.href = redirectUrl;
                    } else {
                        alert(successCount + 'ê°œ ì˜µì…˜ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        window.location.href = '/margin-tracker';
                    }
                } else {
                    alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } else {
                let pn = (formData.productNumber || '').trim();
                let pname = '';
                if (pn.indexOf(' / ') !== -1) {
                    const parts = pn.split(' / ');
                    pn = parts[0].trim();
                    pname = parts.slice(1).join(' / ').trim();
                }
                const payload = {
                    userId: userId,
                    productNumber: pn || null,
                    productName: pname || null,
                    date: formData.date || null,
                    sellingPrice: formData.sellingPrice != null && formData.sellingPrice !== '' ? formData.sellingPrice : null,
                    discountCoupon: formData.discountCoupon != null && formData.discountCoupon !== '' ? formData.discountCoupon : null,
                    finalSellingPrice: formData.finalSellingPrice != null && formData.finalSellingPrice !== '' ? formData.finalSellingPrice : null,
                    priceFluctuation: (typeof formData.priceFluctuation === 'number') ? formData.priceFluctuation : (formData.priceFluctuation !== undefined && formData.priceFluctuation !== null && formData.priceFluctuation !== '') ? Number(formData.priceFluctuation) : null,
                    salesQuantity: (typeof formData.salesQuantity === 'number') ? formData.salesQuantity : (formData.salesQuantity !== undefined && formData.salesQuantity !== null && formData.salesQuantity !== '') ? Number(formData.salesQuantity) : null,
                    actualSalesRevenue: formData.actualSalesRevenue != null && formData.actualSalesRevenue !== '' ? formData.actualSalesRevenue : null,
                    marginPerUnit: formData.marginPerUnit || null,
                    totalMargin: formData.totalMargin || null,
                    advertisingCost: formData.advertisingCost || null,
                    netProfit: formData.netProfit || null,
                    marginRate: formData.marginRate || null,
                    adSales: formData.adSales || null,
                    organicSales: formData.organicSales || null,
                    organicSalesRatio: formData.organicSalesRatio || null,
                    roas: formData.roas || null
                };
                if (editId) payload.dataSeq = parseInt(editId, 10);
                try {
                    const res = await fetch('/api/margin-tracker/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await res.json();
                    if (result.success) {
                        if (redirectUrl) {
                            window.location.href = redirectUrl;
                        } else {
                            window.location.href = '/margin-tracker';
                        }
                    } else {
                        alert(result.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                } catch (e) {
                    console.error(e);
                    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }
    </script>
</body>
</html>
