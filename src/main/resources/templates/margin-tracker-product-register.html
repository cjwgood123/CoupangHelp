<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상품 등록 및 관리 - 헬쿠 매출 일지</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --helku: hsl(330, 80%, 55%);
            --primary: #3182F6;
            --background: #F9FAFB;
            --card: #FFFFFF;
            --text-primary: #191F28;
            --text-secondary: #8B95A1;
            --border: #E8EAED;
            --radius: 16px;
            --radius-sm: 12px;
            --foreground: hsl(220, 15%, 20%);
            --muted-foreground: hsl(220, 10%, 50%);
            --primary-foreground: hsl(0, 0%, 100%);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }
        .mt-container { display: flex; min-height: 100vh; }
        .mt-sidebar {
            width: 320px;
            background: var(--card);
            border-right: 1px solid var(--border);
            overflow-y: auto;
        }
        .mt-sidebar-header { padding: 1.5rem; }
        .mt-sidebar .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            text-decoration: none;
            color: inherit;
        }
        .mt-sidebar .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--helku);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mt-sidebar .logo-icon svg { width: 24px; height: 24px; stroke: white; }
        .mt-sidebar .logo-text h2 { font-weight: 700; font-size: 1rem; color: var(--text-primary); }
        .mt-sidebar .logo-text p { font-size: 0.75rem; color: var(--text-secondary); }
        .mt-sidebar .nav { padding: 0 1.5rem 1.5rem; }
        .mt-sidebar .nav-section { margin-bottom: 0.5rem; }
        .mt-sidebar .nav-toggle {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            border: none;
            background: transparent;
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            cursor: pointer;
        }
        .mt-sidebar .nav-toggle:hover { background: var(--background); }
        .mt-sidebar .nav-toggle svg { width: 16px; height: 16px; transition: transform 0.2s; }
        .mt-sidebar .nav-toggle.active svg { transform: rotate(180deg); }
        .mt-sidebar .nav-items { display: none; padding-left: 0.75rem; margin-top: 0.25rem; }
        .mt-sidebar .nav-items.show { display: block; }
        .mt-sidebar .nav-item {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            border-radius: var(--radius-sm);
            margin-bottom: 0.25rem;
            text-decoration: none;
            color: var(--text-primary);
            display: block;
        }
        .mt-sidebar .nav-item:hover { background: var(--background); }
        .mt-sidebar .nav-item.active { background: rgba(49, 130, 246, 0.15); color: var(--primary); font-weight: 600; }
        .mt-main { flex: 1; min-width: 0; }

        /* 헤더 (매출일지와 동일) */
        .header {
            background-color: var(--card);
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: none;
            box-shadow: 0 1px 0 rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }
        .header-title .brand { color: var(--helku); }
        .menu-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            color: var(--text-primary);
            -webkit-tap-highlight-color: transparent;
        }
        /* 모바일 헤더 (매출일지와 동일) */
        .mobile-header {
            display: none;
            background-color: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        .logo-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            color: inherit;
        }
        .logo-link .logo-icon {
            width: 32px;
            height: 32px;
            background-color: var(--helku);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .logo-link .logo-icon svg {
            width: 18px;
            height: 18px;
            stroke: var(--primary-foreground);
        }
        .logo-link .logo-text h2 {
            font-weight: bold;
            font-size: 0.875rem;
            color: var(--foreground);
        }
        .menu-toggle {
            background: none;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            color: var(--foreground);
        }
        .menu-toggle svg { width: 24px; height: 24px; }
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--muted-foreground);
            text-decoration: none;
            font-size: 0.8125rem;
        }
        .back-link svg { width: 16px; height: 16px; }
        /* 모바일 메뉴 (매출일지와 동일) */
        .mobile-menu {
            display: none !important;
            background-color: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 1rem;
            max-height: 70vh;
            overflow-y: auto;
        }
        .mobile-menu.show { display: block !important; }
        .mobile-menu .nav-section { margin-bottom: 1rem; }
        .mobile-menu .nav-toggle {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: none;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--foreground);
        }
        .mobile-menu .nav-toggle:hover { background-color: var(--background); }
        .mobile-menu .nav-toggle svg { width: 16px; height: 16px; transition: transform 0.2s; }
        .mobile-menu .nav-toggle.active svg { transform: rotate(180deg); }
        .mobile-menu .nav-items { display: none; padding-left: 0.5rem; margin-top: 0.25rem; }
        .mobile-menu .nav-items.show { display: block; }
        .mobile-menu .nav-item {
            padding: 0.625rem 0.75rem;
            border-radius: var(--radius);
            font-size: 0.8125rem;
            color: var(--foreground);
            text-decoration: none;
            display: block;
        }
        .mobile-menu .nav-item:hover { background-color: var(--background); }
        .mobile-menu .nav-item.active { font-weight: 600; color: var(--primary); }

        .pr-content { padding: 1.25rem; max-width: 640px; margin: 0 auto; }
        .pr-section { margin-bottom: 1.5rem; }
        .pr-section-title {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }
        .pr-section-head {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .pr-section-hint {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 400;
        }
        .pr-field {
            margin-bottom: 1rem;
        }
        .pr-field label {
            display: block;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-bottom: 0.35rem;
        }
        .pr-field input,
        .pr-field .pr-calc {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9375rem;
            background: var(--card);
            color: var(--text-primary);
        }
        .pr-field input::placeholder { color: var(--text-secondary); opacity: 0.7; }
        .pr-calc { background: #f5f5f5; color: var(--text-secondary); }

        .pr-options-title { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary); }
        .pr-option-block {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            position: relative;
        }
        .pr-option-block .pr-field { margin-bottom: 0.75rem; }
        .pr-option-block .pr-field:last-of-type { margin-bottom: 0; }
        .pr-option-block .pr-option-actions {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }
        .pr-option-delete {
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card);
            color: var(--text-secondary);
            font-size: 0.8125rem;
            cursor: pointer;
        }
        .pr-option-delete:hover { background: #ffebee; color: #c62828; border-color: #ef9a9a; }
        .pr-add-option {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: 2px dashed var(--border);
            background: var(--card);
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            transition: border-color 0.2s, color 0.2s;
        }
        .pr-add-option:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        .pr-save-wrap { margin-top: 1.5rem; margin-bottom: 2rem; text-align: center; }
        .pr-save-btn {
            padding: 0.875rem 2.5rem;
            border: none;
            border-radius: var(--radius-sm);
            background: var(--primary);
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        .pr-save-btn:hover { opacity: 0.9; }
        .pr-save-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* 탭: 상품 등록/수정 | 상품 노출 순서 변경 */
        .pr-tabs {
            display: flex;
            gap: 0;
            padding: 0 1.25rem;
            background: var(--card);
            border-bottom: 1px solid var(--border);
        }
        .pr-tab {
            padding: 0.875rem 1.25rem;
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-secondary);
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            margin-bottom: -1px;
        }
        .pr-tab:hover { color: var(--text-primary); }
        .pr-tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; }
        .pr-panel { display: none; }
        .pr-panel.active { display: block; }

        /* 상품 노출 순서 변경 리스트 */
        .order-list { list-style: none; padding: 0; margin: 0; }
        .order-list li {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            margin-bottom: 0.5rem;
            cursor: grab;
        }
        .order-list li:active { cursor: grabbing; }
        .order-list li.dragging { opacity: 0.5; }
        .order-list .handle {
            width: 28px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            flex-shrink: 0;
            font-size: 1.25rem;
            cursor: grab;
        }
        .order-list .label { flex: 1; font-size: 0.9375rem; color: var(--text-primary); }
        .order-list .sub { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .order-save-wrap { margin-top: 1.5rem; text-align: center; }
        .order-save-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-sm);
            background: var(--primary);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
        }
        .order-save-btn:hover { opacity: 0.9; }
        #productOrderList.empty + .order-save-wrap { display: none; }

        .pr-delete-wrap { margin-top: 1.5rem; text-align: center; }
        .pr-delete-btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: var(--radius-sm);
            background: #C62828;
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        .pr-delete-btn:hover { background: #B71C1C; }
        .pr-delete-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .shipping-mode-wrap { display: flex; flex-direction: row; flex-wrap: nowrap; gap: 1rem; margin-bottom: 0.75rem; align-items: center; }
        .shipping-mode-opt { font-size: 0.875rem; cursor: pointer; }
        .shipping-panel { margin-top: 0.5rem; }
        .shipping-rule-row {
            display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem;
            padding: 0.75rem; background: #f9fafb; border: 1px solid var(--border);
            border-radius: 8px; margin-bottom: 0.5rem;
        }
        .shipping-rule-row input[type="number"] { width: 100px; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; }
        .shipping-rule-row .rule-shipping-label { font-size: 0.8125rem; color: var(--text-secondary); }
        .add-rule-btn {
            padding: 0.5rem 1rem; border: 1px dashed var(--border); border-radius: 8px;
            background: var(--card); color: var(--text-secondary); font-size: 0.875rem; cursor: pointer;
        }
        .add-rule-btn:hover { border-color: var(--primary); color: var(--primary); }
        .remove-rule-btn { padding: 0.25rem 0.5rem; font-size: 0.75rem; color: var(--text-secondary); cursor: pointer; }

        /* 모바일 전용 스타일 (매출일지와 동일: 햄버거 + 슬라이드 메뉴) */
        @media (max-width: 767px) {
            .mt-container {
                flex-direction: column;
            }
            .mt-sidebar {
                display: none !important;
            }
            .header {
                display: none;
            }
            .mobile-header {
                display: block !important;
            }
            .mt-sidebar-header {
                padding: 1rem;
            }
            .mt-sidebar .logo {
                margin-bottom: 1rem;
            }
            .mt-sidebar .nav {
                padding: 0 1rem 1rem;
            }
            .pr-content {
                padding: 1rem;
                max-width: 100%;
            }
            .pr-section {
                margin-bottom: 1.25rem;
            }
            .pr-section-title {
                font-size: 0.875rem;
            }
            .pr-field {
                margin-bottom: 0.875rem;
            }
            .pr-field input,
            .pr-field .pr-calc {
                padding: 0.625rem 0.875rem;
                font-size: 0.875rem;
            }
            .pr-option-block {
                padding: 0.875rem 1rem;
            }
            .pr-tabs {
                padding: 0 1rem;
            }
            .pr-tab {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }
            .shipping-mode-wrap {
                gap: 0.5rem;
            }
            .shipping-rule-row {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }
            .shipping-rule-row input[type="number"] {
                width: 100%;
            }
            .order-list li {
                padding: 0.875rem 1rem;
            }
            .order-list .handle {
                width: 24px;
                height: 24px;
                font-size: 1rem;
            }
        }

        @media (min-width: 768px) {
            .mt-main { max-width: 800px; margin: 0 auto; box-shadow: 0 0 20px rgba(0,0,0,0.08); }
            .pr-content { padding: 1.5rem 2rem; }
        }
    </style>
</head>
<body>
    <div class="mt-container">
        <aside class="mt-sidebar">
            <div class="mt-sidebar-header">
                <a href="/" class="logo" style="text-decoration: none; color: inherit;">
                    <div class="logo-icon">
                        <svg fill="none" stroke-width="2" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                        </svg>
                    </div>
                    <div class="logo-text">
                        <h2>헬쿠</h2>
                        <p>셀러 데이터 분석</p>
                    </div>
                </a>
                <div th:replace="~{fragments/sidebar-nav :: nav}"></div>
            </div>
        </aside>
        <main class="mt-main">
            <header class="mobile-header" style="display: none;">
                <div class="header-top">
                    <a href="/margin-tracker" class="logo-link">
                        <div class="logo-icon">
                            <svg fill="none" stroke-width="2" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                            </svg>
                        </div>
                        <div class="logo-text">
                            <h2 th:text="${pageTitle}">상품 등록</h2>
                        </div>
                    </a>
                    <button class="menu-toggle" id="sidebarToggle" aria-label="메뉴">
                        <svg fill="none" stroke-width="2" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                        </svg>
                    </button>
                </div>
                <a href="/margin-tracker" class="back-link">
                    <svg fill="none" stroke-width="2" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                    매출일지로
                </a>
            </header>
            <nav class="mobile-menu" id="mobileMenu">
                <div th:replace="~{fragments/sidebar-nav :: nav}"></div>
            </nav>
            <div class="header" id="desktopHeader">
                <h1 class="header-title"><span class="brand">헬쿠</span> <span th:text="${pageTitle}">상품 등록</span></h1>
                <div class="menu-icon" id="desktopSidebarToggle" aria-label="메뉴">☰</div>
            </div>
            <div class="pr-tabs">
                <button type="button" class="pr-tab active" data-panel="register">상품 등록/수정</button>
                <button type="button" class="pr-tab" data-panel="order">상품 노출 순서 변경</button>
                <button type="button" class="pr-tab" data-panel="delete">상품 삭제</button>
            </div>
            <div class="pr-content pr-panel active" id="panelRegister">
                <!-- 상품 선택 셀렉트 (수정 모드일 때만 표시) -->
                <section class="pr-section" id="productSelectSection" style="display: none;">
                    <div class="pr-section-head">
                        <h2 class="pr-section-title">수정할 상품 선택</h2>
                    </div>
                    <div class="pr-field">
                        <label>등록된 상품</label>
                        <select id="productSelect" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 1rem;">
                            <option value="">-- 상품을 선택하세요 --</option>
                        </select>
                    </div>
                </section>
                
                <section class="pr-section">
                    <div class="pr-section-head">
                        <h2 class="pr-section-title">상품 정보</h2>
                        <span class="pr-section-hint">마진 = 판매가 − 입출고/배송비 − 수수료 − 원가 (수수료 = 판매가 × 수수료비율 × 1.1)</span>
                    </div>
                    <div class="pr-field">
                        <label>상품 ID (입력값)</label>
                        <input type="text" id="productId" placeholder="상품 ID">
                    </div>
                    <div class="pr-field">
                        <label>상품 별칭 (입력값)</label>
                        <input type="text" id="productAlias" placeholder="상품 별칭">
                    </div>
                    <div class="pr-field">
                        <label>입출고/배송비 (원) — 마진 계산용</label>
                        <div class="shipping-mode-wrap">
                            <label class="shipping-mode-opt"><input type="radio" name="shippingMode" value="fixed" checked> 고정</label>
                            <label class="shipping-mode-opt"><input type="radio" name="shippingMode" value="by_price"> 판매가별 입출/배송비 설정</label>
                        </div>
                        <div id="shippingFixedWrap" class="shipping-panel">
                            <input type="number" id="shippingCost" placeholder="0" min="0" step="1" value="0">
                        </div>
                        <div id="shippingByPriceWrap" class="shipping-panel" style="display: none;">
                            <p class="pr-section-hint" style="margin-bottom: 0.75rem;">판매가 구간별 적용 배송비를 입력하세요. (최대 5개)</p>
                            <div id="shippingRulesList"></div>
                            <button type="button" class="add-rule-btn" id="addShippingRuleBtn">+ 구간 추가</button>
                        </div>
                    </div>
                    <div class="pr-field">
                        <label>해당 상품의 수수료 비율 (입력값) ex. 10.8%</label>
                        <input type="text" id="commissionRate" placeholder="10.8">
                    </div>
                </section>

                <section class="pr-section">
                    <h2 class="pr-options-title">옵션추가</h2>
                    <div id="optionBlocks">
                        <div class="pr-option-block" data-option-index="0">
                            <div class="pr-field">
                                <label>옵션 ID (입력값)</label>
                                <input type="text" class="opt-id" placeholder="옵션 ID">
                            </div>
                            <div class="pr-field">
                                <label>옵션 별칭 (입력값)</label>
                                <input type="text" class="opt-alias" placeholder="옵션 별칭">
                            </div>
                            <div class="pr-field">
                                <label>현재 판매가 (입력값)</label>
                                <input type="number" class="opt-price" placeholder="0" min="0" step="1">
                            </div>
                            <div class="pr-field">
                                <label>원가 (입력값)</label>
                                <input type="number" class="opt-cost" placeholder="0" min="0" step="1">
                            </div>
                            <div class="pr-field">
                                <label>개당 예상 마진 (계산값)</label>
                                <div class="pr-calc opt-margin" readonly>0원</div>
                            </div>
                            <div class="pr-option-actions">
                                <button type="button" class="pr-option-delete" aria-label="이 옵션 삭제">옵션 삭제</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="pr-add-option" id="addOptionBtn" aria-label="옵션 추가">+</button>
                </section>
                <div class="pr-save-wrap">
                    <button type="button" class="pr-save-btn" id="prSaveBtn">저장하기</button>
                </div>
            </div>
            <div class="pr-content pr-panel" id="panelOrder">
                <section class="pr-section">
                    <h2 class="pr-section-title">상품 노출 순서 변경</h2>
                    <p class="pr-section-hint" style="margin-bottom: 1rem;">드래그하여 순서를 바꾼 뒤 [순서 저장]을 누르세요. 매출 일지에서 상품 탭이 이 순서로 표시됩니다.</p>
                    <ul class="order-list" id="productOrderList"></ul>
                    <div class="order-save-wrap">
                        <button type="button" class="order-save-btn" id="orderSaveBtn">순서 저장</button>
                    </div>
                </section>
            </div>
            <div class="pr-content pr-panel" id="panelDelete">
                <section class="pr-section">
                    <h2 class="pr-section-title">상품 삭제</h2>
                    <p class="pr-section-hint" style="margin-bottom: 1rem;">삭제 시 해당 상품과 연결된 모든 매출 데이터가 함께 삭제됩니다. 복구할 수 없습니다.</p>
                    <div class="pr-field">
                        <label>삭제할 상품 선택</label>
                        <select id="productDeleteSelect" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 1rem;">
                            <option value="">-- 상품을 선택하세요 --</option>
                        </select>
                    </div>
                    <div class="pr-delete-wrap">
                        <button type="button" class="pr-delete-btn" id="productDeleteBtn">삭제</button>
                    </div>
                </section>
            </div>
        </main>
    </div>
    <script>
        function toggleNav(id) {
            var navItems = document.getElementById(id);
            var toggle = navItems ? navItems.previousElementSibling : null;
            if (navItems && toggle) {
                navItems.classList.toggle('show');
                toggle.classList.toggle('active');
            }
        }
        function toggleMobileMenu() {
            var menu = document.getElementById('mobileMenu');
            if (menu) {
                menu.classList.toggle('show');
                if (menu.classList.contains('show')) {
                    menu.style.display = '';
                    setTimeout(function() { bindNavToggleEventsForMenu(); }, 100);
                } else {
                    menu.style.display = 'none';
                }
            }
        }
        function bindNavToggleEventsForMenu() {
            var mobileMenu = document.getElementById('mobileMenu');
            if (!mobileMenu) return;
            mobileMenu.querySelectorAll('.nav-toggle').forEach(function(toggle) {
                var newToggle = toggle.cloneNode(true);
                toggle.parentNode.replaceChild(newToggle, toggle);
                newToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    var onclickAttr = this.getAttribute('onclick');
                    var navId = null;
                    if (onclickAttr) {
                        var match = onclickAttr.match(/toggleNav\(['"]([^'"]+)['"]\)/);
                        if (match && match[1]) navId = match[1];
                    }
                    if (!navId) {
                        var nextSibling = this.nextElementSibling;
                        if (nextSibling && nextSibling.classList && nextSibling.classList.contains('nav-items'))
                            navId = nextSibling.id;
                    }
                    if (navId) toggleNav(navId);
                });
            });
        }
        document.addEventListener('DOMContentLoaded', function() {
            var sidebarToggle = document.getElementById('sidebarToggle');
            var desktopSidebarToggle = document.getElementById('desktopSidebarToggle');
            var mobileMenu = document.getElementById('mobileMenu');
            if (sidebarToggle && mobileMenu) {
                sidebarToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleMobileMenu();
                });
            }
            if (desktopSidebarToggle) {
                desktopSidebarToggle.addEventListener('click', function() {
                    var sidebar = document.querySelector('.mt-sidebar');
                    if (sidebar)
                        sidebar.style.display = sidebar.style.display === 'none' ? 'block' : 'none';
                });
            }
            document.addEventListener('click', function(event) {
                if (mobileMenu && mobileMenu.classList.contains('show') && !mobileMenu.contains(event.target) && sidebarToggle && !sidebarToggle.contains(event.target))
                    mobileMenu.classList.remove('show');
            });
        });
    </script>
    <script>
        (function() {
            var optionIndex = 1;
            function parseNum(val) { var n = parseFloat(String(val).replace(/,/g, '')); return isNaN(n) ? 0 : n; }
            function formatWon(n) { return (n >= 0 ? '' : '-') + Math.abs(Math.round(n)).toLocaleString('ko-KR') + '원'; }
            function getProductCommissionRate() { return parseNum(document.getElementById('commissionRate') && document.getElementById('commissionRate').value); }

            var shippingRules = [];

            function getShippingMode() {
                var r = document.querySelector('input[name="shippingMode"]:checked');
                return r ? r.value : 'fixed';
            }
            function getProductShipping(optionPrice) {
                if (getShippingMode() === 'fixed') {
                    return parseNum(document.getElementById('shippingCost') && document.getElementById('shippingCost').value);
                }
                if (getShippingMode() !== 'by_price') return 0;
                // 판매가별 모드: DOM에서 직접 읽어서 계산
                var price = optionPrice != null ? parseNum(optionPrice) : 0;
                var rulesList = document.getElementById('shippingRulesList');
                if (!rulesList) return 0;
                var rows = rulesList.querySelectorAll('.shipping-rule-row');
                for (var i = 0; i < rows.length; i++) {
                    var row = rows[i];
                    var maxInp = row.querySelector('.rule-max');
                    var minInp = row.querySelector('.rule-min');
                    var shipInp = row.querySelector('.rule-shipping');
                    if (!maxInp || !shipInp) continue;
                    var maxVal = parseNum(maxInp.value);
                    var shipVal = parseNum(shipInp.value);
                    if (minInp) {
                        // 구간형: "N원 이상 M원 미만"
                        var minVal = parseNum(minInp.value);
                        if (price >= minVal && price < maxVal) return shipVal;
                    } else {
                        // 미만형: "~ N원 미만"
                        if (price < maxVal) return shipVal;
                    }
                }
                return 0;
            }
            function syncShippingModeUI() {
                var isFixed = getShippingMode() === 'fixed';
                document.getElementById('shippingFixedWrap').style.display = isFixed ? 'block' : 'none';
                document.getElementById('shippingByPriceWrap').style.display = isFixed ? 'none' : 'block';
                refreshAllOptionMargins();
            }
            function renderShippingRules() {
                var list = document.getElementById('shippingRulesList');
                list.innerHTML = '';
                shippingRules.forEach(function(r, idx) {
                    var row = document.createElement('div');
                    row.className = 'shipping-rule-row';
                    row.setAttribute('data-rule-idx', idx);
                    if (r.type === 'under') {
                        row.innerHTML = '<input type="number" class="rule-max" placeholder="금액" value="' + (r.max != null ? r.max : '') + '" min="0" step="1"> <span class="rule-shipping-label">원 미만</span> 적용배송비: <input type="number" class="rule-shipping" placeholder="0" value="' + (r.shipping != null ? r.shipping : '') + '" min="0" step="1"> <button type="button" class="remove-rule-btn">삭제</button>';
                    } else {
                        row.innerHTML = '<input type="number" class="rule-min" placeholder="최소" value="' + (r.min != null ? r.min : '') + '" min="0" step="1"> <span class="rule-shipping-label">이상</span> <input type="number" class="rule-max" placeholder="최대" value="' + (r.max != null ? r.max : '') + '" min="0" step="1"> <span class="rule-shipping-label">원 미만</span> 적용배송비: <input type="number" class="rule-shipping" placeholder="0" value="' + (r.shipping != null ? r.shipping : '') + '" min="0" step="1"> <button type="button" class="remove-rule-btn">삭제</button>';
                    }
                    list.appendChild(row);
                    row.querySelector('.remove-rule-btn').addEventListener('click', function() {
                        shippingRules = collectShippingRulesFromDOM();
                        shippingRules.splice(idx, 1);
                        renderShippingRules();
                        refreshAllOptionMargins();
                    });
                    row.querySelectorAll('.rule-max, .rule-min, .rule-shipping').forEach(function(inp) {
                        inp.addEventListener('input', refreshAllOptionMargins);
                    });
                });
            }
            function addShippingRule() {
                shippingRules = collectShippingRulesFromDOM();
                if (shippingRules.length >= 5) {
                    alert('최대 5개까지 추가할 수 있습니다.');
                    return;
                }
                var last = shippingRules[shippingRules.length - 1];
                if (!last) {
                    shippingRules.push({ type: 'under', max: 5000, shipping: 0 });
                } else {
                    var nextMin = last.type === 'under' ? (last.max != null ? last.max : 5000) : (last.max != null ? last.max : 5000);
                    shippingRules.push({ type: 'range', min: nextMin, max: nextMin + 2000, shipping: 0 });
                }
                renderShippingRules();
            }
            function collectShippingRulesFromDOM() {
                var list = document.getElementById('shippingRulesList');
                var collected = [];
                list.querySelectorAll('.shipping-rule-row').forEach(function(row) {
                    var maxInp = row.querySelector('.rule-max');
                    var minInp = row.querySelector('.rule-min');
                    var shipInp = row.querySelector('.rule-shipping');
                    var maxVal = maxInp ? parseNum(maxInp.value) : null;
                    var minVal = minInp ? parseNum(minInp.value) : null;
                    var shipVal = shipInp ? parseNum(shipInp.value) : 0;
                    if (minInp) collected.push({ type: 'range', min: minVal, max: maxVal, shipping: shipVal });
                    else collected.push({ type: 'under', max: maxVal, shipping: shipVal });
                });
                return collected;
            }
            function buildShippingCostRangeForSave() {
                if (getShippingMode() === 'fixed') {
                    var v = document.getElementById('shippingCost').value;
                    return v != null ? String(v).trim() : '';
                }
                var rules = collectShippingRulesFromDOM();
                if (rules.length === 0) return '';
                return JSON.stringify({ mode: 'by_price', rules: rules });
            }
            function loadShippingCostRange(val) {
                if (val == null || val === '') {
                    document.querySelector('input[name="shippingMode"][value="fixed"]').checked = true;
                    document.getElementById('shippingCost').value = '0';
                    shippingRules = [];
                    syncShippingModeUI();
                    return;
                }
                var trimmed = String(val).trim();
                if (/^\d+$/.test(trimmed)) {
                    document.querySelector('input[name="shippingMode"][value="fixed"]').checked = true;
                    document.getElementById('shippingCost').value = trimmed;
                    shippingRules = [];
                    syncShippingModeUI();
                    return;
                }
                try {
                    var obj = JSON.parse(trimmed);
                    if (obj && obj.mode === 'by_price' && Array.isArray(obj.rules)) {
                        document.querySelector('input[name="shippingMode"][value="by_price"]').checked = true;
                        shippingRules = obj.rules.slice();
                        syncShippingModeUI();
                        renderShippingRules();
                        return;
                    }
                } catch (e) {}
                document.querySelector('input[name="shippingMode"][value="fixed"]').checked = true;
                document.getElementById('shippingCost').value = '0';
                shippingRules = [];
                syncShippingModeUI();
            }
            
            // URL 파라미터에서 모드 확인
            var params = new URLSearchParams(window.location.search);
            var mode = params.get('mode');
            var isEditMode = mode === 'edit';
            
            // 상품 선택 셀렉트 표시/숨김
            var productSelectSection = document.getElementById('productSelectSection');
            if (isEditMode && productSelectSection) {
                productSelectSection.style.display = 'block';
            }
            
            // 상품 목록 로드 및 셀렉트에 추가
            async function loadProductList() {
                var userId = localStorage.getItem('salesChart_userId');
                if (!userId) return;
                
                try {
                    var res = await fetch('/api/margin-tracker/registered-products?userId=' + encodeURIComponent(userId));
                    var data = await res.json();
                    if (!data.success || !data.products || data.products.length === 0) {
                        if (isEditMode) {
                            alert('등록된 상품이 없습니다.');
                            window.location.href = '/margin-tracker/product-register';
                        }
                        return;
                    }
                    
                    var select = document.getElementById('productSelect');
                    if (!select) return;
                    
                    select.innerHTML = '<option value="">-- 상품을 선택하세요 --</option>';
                    data.products.forEach(function(p) {
                        var option = document.createElement('option');
                        option.value = p.productNumber || '';
                        option.textContent = (p.productName || '') + ' / ' + (p.productNumber || '');
                        option.setAttribute('data-product-seq', p.productSeq || '');
                        select.appendChild(option);
                    });
                    
                    // 셀렉트 변경 이벤트 - 상품 선택 시 자동으로 상품번호/상품명 채우기
                    select.addEventListener('change', function() {
                        var selectedValue = this.value;
                        if (selectedValue) {
                            // 상품 선택 시 자동으로 상품 정보 로드 및 입력
                            loadProductForEdit(selectedValue);
                        } else {
                            // 초기화
                            document.getElementById('productId').value = '';
                            document.getElementById('productAlias').value = '';
                            document.getElementById('commissionRate').value = '';
                            loadShippingCostRange('');
                            document.body.removeAttribute('data-product-seq');
                            
                            var container = document.getElementById('optionBlocks');
                            // 첫 번째 옵션 블록 템플릿 저장
                            var firstBlockTemplate = container.querySelector('.pr-option-block');
                            if (firstBlockTemplate) {
                                container.innerHTML = '';
                                optionIndex = 1;
                                var block = firstBlockTemplate.cloneNode(true);
                                block.setAttribute('data-option-index', 0);
                                block.querySelector('.opt-id').value = '';
                                block.querySelector('.opt-alias').value = '';
                                block.querySelector('.opt-price').value = '';
                                block.querySelector('.opt-cost').value = '';
                                block.querySelector('.opt-margin').textContent = '0원';
                                block._deleteBound = false;
                                block._marginHandler = null;
                                container.appendChild(block);
                                bindOptionBlock(block);
                            }
                        }
                    });
                } catch (e) {
                    console.error('상품 목록 로드 오류:', e);
                }
            }
            
            // 상품 로드 함수
            async function loadProductForEdit(productNumber) {
                var userId = localStorage.getItem('salesChart_userId');
                if (!userId) {
                    console.error('로그인이 필요합니다.');
                    return;
                }
                try {
                    // 등록된 상품 목록에서 해당 상품 찾기
                    var res = await fetch('/api/margin-tracker/registered-products?userId=' + encodeURIComponent(userId));
                    var data = await res.json();
                    if (!data.success || !data.products) return;
                    
                    var product = data.products.find(function(p) {
                        return p.productNumber === productNumber;
                    });
                    if (!product) {
                        alert('해당 상품을 찾을 수 없습니다.');
                        return;
                    }
                    
                    // 상품 정보 자동 입력 (상품번호/상품명 자동으로 가져오기)
                    document.getElementById('productId').value = product.productNumber || '';
                    document.getElementById('productAlias').value = product.productName || '';
                    if (product.commissionRate) {
                        document.getElementById('commissionRate').value = product.commissionRate;
                    }
                    loadShippingCostRange(product.shippingCostRange || product.shippingCost || '');
                    if (product.productSeq) {
                        document.body.setAttribute('data-product-seq', product.productSeq);
                    }
                    
                    // 옵션별 마진 계산을 위해 배송비 모드 변경 시 자동 갱신
                    refreshAllOptionMargins();
                    
                    // 옵션 로드
                    var optRes = await fetch('/api/margin-tracker/product-options?userId=' + encodeURIComponent(userId) + '&productNumber=' + encodeURIComponent(productNumber));
                    var optData = await optRes.json();
                    var container = document.getElementById('optionBlocks');
                    
                    // 첫 번째 옵션 블록 템플릿 저장 (제거 전에)
                    var firstBlockTemplate = container.querySelector('.pr-option-block');
                    if (!firstBlockTemplate) {
                        console.error('옵션 블록 템플릿을 찾을 수 없습니다.');
                        return;
                    }
                    
                    // 기존 옵션 블록 모두 제거
                    container.innerHTML = '';
                    optionIndex = 1;
                    
                    if (optData.success && optData.options && optData.options.length > 0) {
                        // 옵션 데이터가 있으면 로드
                        optData.options.forEach(function(opt, idx) {
                            var block;
                            if (idx === 0) {
                                // 첫 번째 블록은 템플릿 복제
                                block = firstBlockTemplate.cloneNode(true);
                                block.setAttribute('data-option-index', 0);
                            } else {
                                // 추가 블록은 첫 번째 블록 복제
                                block = firstBlockTemplate.cloneNode(true);
                                block.removeAttribute('data-option-index');
                                block.setAttribute('data-option-index', optionIndex++);
                            }
                            
                            block.querySelector('.opt-id').value = opt.optionId || '';
                            block.querySelector('.opt-alias').value = opt.optionAlias || '';
                            block.querySelector('.opt-price').value = opt.sellingPrice || '';
                            block.querySelector('.opt-cost').value = opt.costPrice || '';
                            block.querySelector('.opt-margin').textContent = '0원';
                            block._deleteBound = false;
                            block._marginHandler = null;
                            
                            container.appendChild(block);
                            updateOptionMargin(block);
                            bindOptionBlock(block);
                        });
                        refreshAllOptionMargins();
                    } else {
                        // 옵션 데이터가 없으면 첫 번째 블록만 추가
                        var block = firstBlockTemplate.cloneNode(true);
                        block.setAttribute('data-option-index', 0);
                        block.querySelector('.opt-id').value = '';
                        block.querySelector('.opt-alias').value = '';
                        block.querySelector('.opt-price').value = '';
                        block.querySelector('.opt-cost').value = '';
                        block.querySelector('.opt-margin').textContent = '0원';
                        block._deleteBound = false;
                        block._marginHandler = null;
                        container.appendChild(block);
                        bindOptionBlock(block);
                    }
                } catch (e) {
                    console.error('상품 로드 오류:', e);
                    alert('상품 정보를 불러오는 중 오류가 발생했습니다.');
                }
            }
            
            // 페이지 로드 시 초기화
            document.addEventListener('DOMContentLoaded', function() {
                if (isEditMode) {
                    loadProductList();
                }
            });
            function updateOptionMargin(block) {
                var price = parseNum(block.querySelector('.opt-price').value);
                var cost = parseNum(block.querySelector('.opt-cost').value);
                var shipping = getProductShipping(price);
                var commissionPct = getProductCommissionRate();
                var effectivePct = commissionPct * 1.1;
                var fee = price * (effectivePct / 100);
                var margin = price - shipping - fee - cost;
                var marginEl = block.querySelector('.opt-margin');
                marginEl.textContent = formatWon(margin);
            }
            function refreshAllOptionMargins() {
                document.querySelectorAll('#optionBlocks .pr-option-block').forEach(updateOptionMargin);
            }
            function bindOptionBlock(block) {
                block.querySelectorAll('.opt-price, .opt-cost').forEach(function(inp) {
                    inp.removeEventListener('input', block._marginHandler);
                    block._marginHandler = function() { updateOptionMargin(block); };
                    inp.addEventListener('input', block._marginHandler);
                });
                var delBtn = block.querySelector('.pr-option-delete');
                if (delBtn && !block._deleteBound) {
                    block._deleteBound = true;
                    delBtn.addEventListener('click', function() {
                        var container = document.getElementById('optionBlocks');
                        var blocks = container.querySelectorAll('.pr-option-block');
                        if (blocks.length <= 1) {
                            alert('최소 1개의 옵션은 필요합니다.');
                            return;
                        }
                        block.remove();
                    });
                }
            }
            function addOptionBlock() {
                var container = document.getElementById('optionBlocks');
                var first = container.querySelector('.pr-option-block');
                var clone = first.cloneNode(true);
                clone.removeAttribute('data-option-index');
                clone.setAttribute('data-option-index', optionIndex++);
                clone.querySelector('.opt-id').value = '';
                clone.querySelector('.opt-alias').value = '';
                clone.querySelector('.opt-price').value = '';
                clone.querySelector('.opt-cost').value = '';
                clone.querySelector('.opt-margin').textContent = '0원';
                clone._deleteBound = false;
                clone._marginHandler = null;
                container.appendChild(clone);
                bindOptionBlock(clone);
            }
            document.querySelectorAll('.pr-option-block').forEach(bindOptionBlock);
            document.getElementById('addOptionBtn').addEventListener('click', addOptionBlock);
            var shippingEl = document.getElementById('shippingCost');
            var commissionEl = document.getElementById('commissionRate');
            if (shippingEl) shippingEl.addEventListener('input', refreshAllOptionMargins);
            if (commissionEl) commissionEl.addEventListener('input', refreshAllOptionMargins);
            document.querySelectorAll('input[name="shippingMode"]').forEach(function(radio) {
                radio.addEventListener('change', syncShippingModeUI);
            });
            document.getElementById('addShippingRuleBtn').addEventListener('click', addShippingRule);

            document.getElementById('prSaveBtn').addEventListener('click', function() {
                var userId = localStorage.getItem('salesChart_userId');
                if (!userId) {
                    alert('로그인 후 저장할 수 있습니다.');
                    return;
                }
                var productId = document.getElementById('productId').value.trim();
                var productAlias = document.getElementById('productAlias').value.trim();
                if (!productId || !productAlias) {
                    alert('상품 ID와 상품 별칭을 입력해주세요.');
                    return;
                }
                var options = [];
                var optionBlocks = document.querySelectorAll('#optionBlocks .pr-option-block');
                if (optionBlocks.length === 0) {
                    alert('최소 1개의 옵션을 입력해주세요.');
                    return;
                }
                for (var i = 0; i < optionBlocks.length; i++) {
                    var block = optionBlocks[i];
                    var optId = block.querySelector('.opt-id').value.trim();
                    var optAlias = block.querySelector('.opt-alias').value.trim();
                    if (!optId || !optAlias) {
                        alert('모든 옵션의 옵션 ID와 옵션 별칭을 입력해주세요.');
                        return;
                    }
                    var price = parseNum(block.querySelector('.opt-price').value);
                    var cost = parseNum(block.querySelector('.opt-cost').value);
                    // 화면에 표시된 개당 예상 마진 값을 그대로 사용
                    var marginText = block.querySelector('.opt-margin').textContent;
                    var marginPerUnit = parseNum(marginText); // "125,001원" 형식에서 숫자 추출
                    options.push({
                        optionId: optId,
                        optionAlias: optAlias,
                        sellingPrice: price,
                        costPrice: cost,
                        marginPerUnit: marginPerUnit
                    });
                }
                var payload = {
                    userId: userId,
                    productNumber: productId,
                    productName: productAlias,
                    shippingCostRange: buildShippingCostRangeForSave(),
                    commissionRate: document.getElementById('commissionRate').value.trim(),
                    options: options
                };
                var productSeq = document.body.getAttribute('data-product-seq');
                if (productSeq) payload.productSeq = productSeq;
                var btn = document.getElementById('prSaveBtn');
                btn.disabled = true;
                fetch('/api/margin-tracker/product', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }).then(function(r) { return r.json(); }).then(function(res) {
                    btn.disabled = false;
                    if (res.success) {
                        alert(res.message || '저장되었습니다.');
                        if (res.productSeq) document.body.setAttribute('data-product-seq', res.productSeq);
                        window.location.href = '/margin-tracker';
                    } else {
                        alert(res.message || '저장에 실패했습니다.');
                    }
                }).catch(function() {
                    btn.disabled = false;
                    alert('저장 중 오류가 발생했습니다.');
                });
            });
        })();
    </script>
    <script>
        (function() {
            var listEl = document.getElementById('productOrderList');
            var orderSaveBtn = document.getElementById('orderSaveBtn');
            var orderProducts = [];

            document.querySelectorAll('.pr-tab').forEach(function(tab) {
                tab.addEventListener('click', function() {
                    var panelId = this.getAttribute('data-panel');
                    document.querySelectorAll('.pr-tab').forEach(function(t) { t.classList.remove('active'); });
                    document.querySelectorAll('.pr-panel').forEach(function(p) { p.classList.remove('active'); });
                    this.classList.add('active');
                    var panel = document.getElementById('panelRegister');
                    if (panelId === 'order') panel = document.getElementById('panelOrder');
                    else if (panelId === 'delete') panel = document.getElementById('panelDelete');
                    if (panel) panel.classList.add('active');
                    if (panelId === 'order') loadOrderList();
                    if (panelId === 'delete') loadDeleteProductList();
                });
            });

            async function loadOrderList() {
                var userId = localStorage.getItem('salesChart_userId');
                if (!userId) {
                    listEl.innerHTML = '<li class="empty">로그인 후 이용해 주세요.</li>';
                    listEl.classList.add('empty');
                    return;
                }
                try {
                    var res = await fetch('/api/margin-tracker/registered-products?userId=' + encodeURIComponent(userId));
                    var data = await res.json();
                    if (!data.success || !data.products || data.products.length === 0) {
                        listEl.innerHTML = '<li class="empty">등록된 상품이 없습니다.</li>';
                        listEl.classList.add('empty');
                        orderProducts = [];
                        return;
                    }
                    orderProducts = data.products;
                    renderOrderList();
                    listEl.classList.remove('empty');
                    bindOrderDragDrop();
                } catch (e) {
                    listEl.innerHTML = '<li class="empty">목록을 불러오지 못했습니다.</li>';
                    listEl.classList.add('empty');
                }
            }

            function renderOrderList() {
                listEl.innerHTML = '';
                orderProducts.forEach(function(p) {
                    var li = document.createElement('li');
                    li.setAttribute('draggable', 'true');
                    li.setAttribute('data-product-seq', p.productSeq);
                    li.innerHTML = '<span class="handle" aria-label="드래그하여 순서 변경">≡</span>' +
                        '<div class="label">' + (p.productName || '') + ' <span class="sub">' + (p.productNumber || '') + '</span></div>';
                    listEl.appendChild(li);
                });
            }

            function bindOrderDragDrop() {
                var dragged = null;
                listEl.querySelectorAll('li').forEach(function(li) {
                    li.setAttribute('draggable', 'true');
                    li.ondragstart = function(e) {
                        dragged = li;
                        e.dataTransfer.setData('text/plain', li.getAttribute('data-product-seq'));
                        li.classList.add('dragging');
                    };
                    li.ondragend = function() {
                        li.classList.remove('dragging');
                        dragged = null;
                    };
                    li.ondragover = function(e) {
                        e.preventDefault();
                        if (dragged && dragged !== li) {
                            var rect = li.getBoundingClientRect();
                            var mid = rect.top + rect.height / 2;
                            if (e.clientY < mid) {
                                listEl.insertBefore(dragged, li);
                            } else {
                                listEl.insertBefore(dragged, li.nextSibling);
                            }
                        }
                    };
                });
            }

            function getOrderedSeqs() {
                var seqs = [];
                listEl.querySelectorAll('li[data-product-seq]').forEach(function(li) {
                    seqs.push(parseInt(li.getAttribute('data-product-seq'), 10));
                });
                return seqs;
            }

            if (orderSaveBtn) {
                orderSaveBtn.addEventListener('click', function() {
                    var userId = localStorage.getItem('salesChart_userId');
                    if (!userId) {
                        alert('로그인 후 저장할 수 있습니다.');
                        return;
                    }
                    var seqs = getOrderedSeqs();
                    if (seqs.length === 0) {
                        alert('저장할 상품이 없습니다.');
                        return;
                    }
                    orderSaveBtn.disabled = true;
                    fetch('/api/margin-tracker/product-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: userId, productSeqs: seqs })
                    }).then(function(r) { return r.json(); }).then(function(res) {
                        orderSaveBtn.disabled = false;
                        if (res.success) {
                            alert(res.message || '순서가 저장되었습니다.');
                            loadOrderList();
                        } else {
                            alert(res.message || '저장에 실패했습니다.');
                        }
                    }).catch(function() {
                        orderSaveBtn.disabled = false;
                        alert('저장 중 오류가 발생했습니다.');
                    });
                });
            }

            var productDeleteSelect = document.getElementById('productDeleteSelect');
            var productDeleteBtn = document.getElementById('productDeleteBtn');
            async function loadDeleteProductList() {
                if (!productDeleteSelect) return;
                var userId = localStorage.getItem('salesChart_userId');
                productDeleteSelect.innerHTML = '<option value="">-- 상품을 선택하세요 --</option>';
                if (!userId) return;
                try {
                    var res = await fetch('/api/margin-tracker/registered-products?userId=' + encodeURIComponent(userId));
                    var data = await res.json();
                    if (data.success && data.products && data.products.length > 0) {
                        data.products.forEach(function(p) {
                            var opt = document.createElement('option');
                            opt.value = p.productNumber || '';
                            opt.textContent = (p.productName || '') + (p.productNumber ? ' (' + p.productNumber + ')' : '');
                            productDeleteSelect.appendChild(opt);
                        });
                    }
                } catch (e) {
                    console.error(e);
                }
            }
            if (productDeleteBtn) {
                productDeleteBtn.addEventListener('click', function() {
                    var userId = localStorage.getItem('salesChart_userId');
                    if (!userId) {
                        alert('로그인 후 이용할 수 있습니다.');
                        return;
                    }
                    var productNumber = productDeleteSelect && productDeleteSelect.value ? productDeleteSelect.value.trim() : '';
                    if (!productNumber) {
                        alert('삭제할 상품을 선택하세요.');
                        return;
                    }
                    var label = productDeleteSelect.options[productDeleteSelect.selectedIndex].textContent;
                    if (!confirm('「' + label + '」 상품과 이 상품에 연결된 모든 매출 데이터가 삭제됩니다. 복구할 수 없습니다. 삭제하시겠습니까?')) {
                        return;
                    }
                    productDeleteBtn.disabled = true;
                    fetch('/api/margin-tracker/product', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: userId, productNumber: productNumber })
                    }).then(function(r) { return r.json(); }).then(function(res) {
                        productDeleteBtn.disabled = false;
                        if (res.success) {
                            alert(res.message || '삭제되었습니다.');
                            loadDeleteProductList();
                        } else {
                            alert(res.message || '삭제에 실패했습니다.');
                        }
                    }).catch(function() {
                        productDeleteBtn.disabled = false;
                        alert('삭제 중 오류가 발생했습니다.');
                    });
                });
            }
        })();
    </script>
</body>
</html>
