<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>헬쿠 매출 일지</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --helku: hsl(330, 80%, 55%);
            --helku-soft: hsl(330, 100%, 97%);
            --toss-blue: #3182F6;
            --primary: #3182F6;
            --primary-dark: #1B64DA;
            --primary-foreground: hsl(0, 0%, 100%);
            --secondary: hsl(330, 100%, 97%);
            --secondary-foreground: hsl(330, 80%, 40%);
            --background: #F9FAFB;
            --card: #FFFFFF;
            --text-primary: #191F28;
            --text-secondary: #8B95A1;
            --text-disabled: #B1B8C0;
            --border: #E8EAED;
            --radius: 16px;
            --radius-sm: 12px;
            --foreground: hsl(220, 15%, 20%);
            --muted-foreground: hsl(220, 10%, 50%);
            --primary-foreground: hsl(0, 0%, 100%);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 100px;
        }
        @media (max-width: 767px) {
            body {
                background-color: var(--background);
                background-image: none;
                padding-bottom: 2rem;
            }
        }

        /* Header */
        .header {
            background-color: var(--card);
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: none;
            box-shadow: 0 1px 0 rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }
        .header-title .brand { color: var(--helku); }

        .menu-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            color: var(--text-primary);
            -webkit-tap-highlight-color: transparent;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            padding: 1.25rem;
        }

        .summary-card {
            background-color: var(--card);
            border-radius: var(--radius);
            padding: 1.25rem;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        }

        .summary-label {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        .summary-value.positive {
            color: #E53935; /* 빨간색: + 금액 */
        }
        .summary-value.negative {
            color: #3182F6; /* 파란색: - 금액 */
        }
        .summary-value .unit {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-left: 2px;
        }

        .summary-value.grey {
            color: var(--text-primary);
        }

        /* 공통 기간 선택 토글 */
        .period-toggle-section {
            padding: 0 1.25rem 1rem;
        }
        .period-toggle-container {
            background-color: var(--card);
            border-radius: var(--radius-sm);
            padding: 0.75rem 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border);
        }
        @media (max-width: 767px) {
            .period-toggle-container {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0.625rem 0.5rem;
                gap: 0.25rem;
                justify-content: flex-start;
            }
            .period-toggle-container::-webkit-scrollbar {
                display: none;
            }
        }
        .period-toggle-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--background);
            color: var(--text-secondary);
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            white-space: nowrap;
        }
        @media (max-width: 767px) {
            .period-toggle-btn {
                padding: 0.375rem 0.625rem;
                font-size: 0.6875rem;
                flex-shrink: 0;
            }
        }
        .period-toggle-btn:hover {
            background: var(--border);
            color: var(--text-primary);
            transform: translateY(-1px);
        }
        .period-toggle-btn.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(49, 130, 246, 0.3);
        }
        .period-toggle-btn.active:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(49, 130, 246, 0.4);
        }

        /* Product Tabs (총 순수익 · 평균 마진율 아래, 달력 위) - 3개씩 캐러셀, 마지막에 상품 등록 */
        .product-tabs-wrap {
            padding: 0 1.25rem 1rem;
            position: relative;
        }
        .product-tabs-carousel {
            overflow: hidden;
            position: relative;
        }
        .product-tabs-track {
            display: flex;
            transition: transform 0.25s ease;
        }
        .product-tabs-slide {
            flex: 0 0 100%;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            min-width: 0;
        }
        .product-tabs-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 50%;
            background: var(--card);
            box-shadow: 0 1px 4px rgba(0,0,0,0.12);
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            -webkit-tap-highlight-color: transparent;
        }
        .product-tabs-nav:hover { background: var(--background); color: var(--text-primary); }
        .product-tabs-nav.prev { left: 0.5rem; }
        .product-tabs-nav.next { right: 0.5rem; }
        .product-tabs-nav:disabled { opacity: 0.35; cursor: not-allowed; }
        .product-tab {
            padding: 0.75rem 0.5rem;
            border-radius: var(--radius-sm);
            background: var(--background);
            border: 1px solid var(--border);
            cursor: pointer;
            text-align: center;
            font-size: 0.8125rem;
            color: var(--text-primary);
            -webkit-tap-highlight-color: transparent;
            transition: background 0.2s, border-color 0.2s, color 0.2s;
            text-decoration: none;
            display: block;
        }
        .product-tab:hover {
            background: var(--border);
        }
        .product-tab.on {
            background: rgba(49, 130, 246, 0.12);
            border-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        .product-tab.register {
            border-style: dashed;
            color: var(--text-secondary);
        }
        .product-tab.register.on {
            border-color: var(--primary);
            color: var(--primary);
        }
        .product-tabs-dots {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-top: 0.5rem;
        }
        .product-tabs-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--border);
            border: none;
            padding: 0;
            cursor: pointer;
        }
        .product-tabs-dot.active { background: var(--primary); }
        .calendar-day.clickable {
            cursor: pointer;
        }
        .calendar-day.clickable:hover {
            background: rgba(0, 0, 0, 0.04);
        }

        /* Calendar Section (Toss-style) */
        .calendar-section {
            background-color: var(--card);
            border-radius: var(--radius);
            padding: 1.25rem;
            margin: 0 1.25rem 1.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(232, 92, 74, 0.18);
            min-height: 300px;
        }
        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding: 0 2px;
        }
        .calendar-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .calendar-nav button {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: var(--background);
            color: var(--text-secondary);
            font-size: 1.125rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }
        .calendar-nav button:hover {
            background: var(--border);
            color: var(--text-primary);
        }
        .calendar-grid-wrap {
            border: 1px solid rgba(232, 92, 74, 0.25);
            border-radius: var(--radius-sm);
            background: #FFFBFD;
            overflow: hidden;
        }
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #FFFBFD;
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }
        .calendar-weekdays span {
            text-align: center;
            font-size: 0.6875rem;
            font-weight: 600;
            padding: 0.5rem 0;
            color: var(--text-secondary);
            letter-spacing: 0.02em;
        }
        .calendar-weekdays span.sunday {
            color: #E85C4A;
        }
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-primary);
            background: #FFFBFD;
            min-height: 36px;
            padding: 2px;
            gap: 0;
            overflow: hidden;
            position: relative;
        }
        .calendar-day-num {
            line-height: 1.2;
        }
        .calendar-day-profit {
            font-size: 0.5625rem;
            font-weight: 600;
            line-height: 1.2;
            margin-top: 1px;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .calendar-day-profit.positive {
            color: #E53935; /* 빨간색: + 금액 */
        }
        .calendar-day-profit.negative {
            color: #3182F6; /* 파란색: - 금액 */
        }
        .calendar-day-data {
            margin-top: 0.25rem;
            font-size: 0.65rem;
            line-height: 1.3;
            width: 100%;
            max-height: 60px;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        .calendar-day-data > div {
            margin-bottom: 0.1rem;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        @media (max-width: 767px) {
            .calendar-day-data {
                max-height: none;
                overflow: visible;
            }
            .calendar-day-data > div {
                margin-bottom: 0.05rem;
                line-height: 1.2;
            }
            /* 모바일에서는 제품명/옵션명 숨기고 금액만 표시 */
            .calendar-day-data .product-label-mobile {
                display: none !important;
            }
            .calendar-day-profit {
                font-size: 0.5rem !important;
                line-height: 1.1;
            }
        }
        .calendar-day.other-month {
            color: var(--text-disabled);
        }
        .calendar-day.other-month .calendar-day-profit {
            color: var(--text-disabled);
        }
        .calendar-day.sunday {
            color: #E85C4A;
        }
        .calendar-day.sunday.other-month {
            color: rgba(232, 92, 74, 0.5);
        }

        /* 상품별 판매 내역 (최근 기록 위) */
        .product-summary-section {
            padding: 0 1.25rem 1.25rem;
        }
        .product-summary-section .section-title {
            margin-bottom: 0.75rem;
        }
        .product-summary-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .product-summary-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .product-summary-label {
            flex-shrink: 0;
            font-size: 0.8125rem;
            color: var(--text-primary);
            font-weight: 500;
            min-width: 4.5em;
        }
        .product-summary-bar-wrap {
            flex: 1;
            min-width: 0;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }
        .product-summary-bar {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            min-width: 2px;
            transition: width 0.25s ease;
        }
        .product-summary-pct {
            flex-shrink: 0;
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-primary);
            min-width: 2.5em;
            text-align: right;
        }
        .product-summary-section .empty-message {
            padding: 1rem 0;
        }

        /* Recent Records */
        .recent-section {
            padding: 0 1.25rem;
            margin-bottom: 1.25rem;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .records-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .records-carousel {
            position: relative;
            overflow: hidden;
        }
        .records-slide {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            min-height: 200px;
        }
        .record-item {
            background-color: var(--card);
            border-radius: var(--radius-sm);
            padding: 1rem 1rem 1rem 1.25rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
        }

        .record-left {
            flex: 1;
            min-width: 0;
        }
        .record-date {
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 600;
        }
        .record-product {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        .record-profit {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary);
        }
        .record-profit.positive {
            color: #E53935; /* 빨간색: + 금액 */
        }
        .record-profit.negative {
            color: #3182F6; /* 파란색: - 금액 */
        }
        .record-profit .unit {
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        .record-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        .record-actions button {
            padding: 6px 10px;
            border: none;
            border-radius: 8px;
            font-size: 0.75rem;
            cursor: pointer;
            background: var(--background);
            color: var(--text-secondary);
        }
        .record-actions button:hover {
            background: var(--primary);
            color: #fff;
        }
        .record-actions button.delete-btn:hover {
            background: #E53935;
            color: #fff;
        }
        .records-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        .records-nav button {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--card);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
        }
        .records-nav button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .records-nav .page-info {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .empty-message {
            text-align: center;
            color: var(--text-disabled);
            font-size: 0.875rem;
            padding: 2rem;
        }

        /* 커스텀 확인 다이얼로그 (모바일 브라우저 기본 confirm 대체) */
        .custom-confirm-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .custom-confirm-overlay.show {
            display: flex;
        }
        .custom-confirm-dialog {
            background-color: var(--card);
            border-radius: var(--radius);
            padding: 1.5rem;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .custom-confirm-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--foreground);
            margin-bottom: 0.5rem;
        }
        .custom-confirm-message {
            font-size: 0.875rem;
            color: var(--foreground);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        .custom-confirm-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        .custom-confirm-btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .custom-confirm-btn:hover {
            opacity: 0.9;
        }
        .custom-confirm-btn.cancel {
            background-color: var(--background);
            color: var(--foreground);
            border: 1px solid var(--border);
        }
        .custom-confirm-btn.confirm {
            background-color: var(--primary);
            color: white;
        }
        @media (max-width: 767px) {
            .custom-confirm-dialog {
                padding: 1.25rem;
            }
            .custom-confirm-buttons {
                flex-direction: column;
            }
            .custom-confirm-btn {
                width: 100%;
            }
        }

        /* Login Section */
        .login-section {
            padding: 1.25rem;
            max-width: 400px;
            margin: 0 auto;
        }
        .login-section h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
        }
        .form-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .form-actions .btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .btn-secondary {
            background-color: var(--border);
            color: var(--text-primary);
        }
        .radio-group { display: flex; gap: 1rem; flex-wrap: wrap; }
        .radio-label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }

        /* 모바일 헤더 스타일 (board-mobile.html과 완전 동일) */
        .mobile-header {
            display: none;
            background-color: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        .logo-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            color: inherit;
        }
        .logo-icon {
            width: 32px;
            height: 32px;
            background-color: var(--helku);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .logo-icon svg {
            width: 18px;
            height: 18px;
            stroke: var(--primary-foreground);
        }
        .logo-text h2 {
            font-weight: bold;
            font-size: 0.875rem;
            color: var(--foreground);
        }
        .menu-toggle {
            background: none;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            color: var(--foreground);
        }
        .menu-toggle svg {
            width: 24px;
            height: 24px;
        }
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--muted-foreground);
            text-decoration: none;
            font-size: 0.8125rem;
        }
        .back-link svg {
            width: 16px;
            height: 16px;
        }

        /* 모바일 메뉴 스타일 (board-mobile.html과 완전 동일) */
        .mobile-menu {
            display: none !important;
            background-color: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 1rem;
            max-height: 70vh;
            overflow-y: auto;
        }
        .mobile-menu.show {
            display: block !important;
        }
        .mobile-menu .nav-section {
            margin-bottom: 1rem;
        }
        .mobile-menu .nav-toggle {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: none;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--foreground);
        }
        .mobile-menu .nav-toggle:hover {
            background-color: var(--background);
        }
        .mobile-menu .nav-toggle svg {
            width: 16px;
            height: 16px;
            transition: transform 0.2s;
        }
        .mobile-menu .nav-toggle.active svg {
            transform: rotate(180deg);
        }
        .mobile-menu .nav-items {
            display: none;
            padding-left: 0.5rem;
            margin-top: 0.25rem;
        }
        .mobile-menu .nav-items.show {
            display: block;
        }
        .mobile-menu .nav-item {
            padding: 0.625rem 0.75rem;
            border-radius: var(--radius);
            font-size: 0.8125rem;
            color: var(--foreground);
            text-decoration: none;
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .mobile-menu .nav-item:hover {
            background-color: var(--background);
        }
        .mobile-menu .nav-item.active {
            background-color: var(--secondary);
            color: var(--secondary-foreground);
            font-weight: 600;
        }
        .mobile-menu .nav-item.muted {
            color: var(--muted-foreground);
        }

        /* Layout: sidebar + main (다른 메뉴와 동일) */
        .mt-container {
            display: flex;
            min-height: 100vh;
        }
        .mt-sidebar {
            width: 320px;
            background-color: var(--card);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            transition: transform 0.3s ease;
        }
        @media (max-width: 767px) {
            .mt-sidebar {
                display: none !important;
            }
        }
        .mt-sidebar-header {
            padding: 1.5rem;
        }
        .mt-sidebar .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            text-decoration: none;
            color: inherit;
        }
        .mt-sidebar .logo-icon {
            width: 40px;
            height: 40px;
            background-color: var(--helku);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mt-sidebar .logo-icon svg {
            width: 24px;
            height: 24px;
            stroke: white;
        }
        .mt-sidebar .logo-text h2 { font-weight: 700; font-size: 1rem; color: var(--text-primary); }
        .mt-sidebar .logo-text p { font-size: 0.75rem; color: var(--text-secondary); }
        .mt-sidebar .nav { padding: 0 1.5rem 1.5rem; }
        .mt-sidebar .nav-section { margin-bottom: 0.5rem; }
        .mt-sidebar .nav-toggle {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            border: none;
            background: transparent;
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            cursor: pointer;
        }
        .mt-sidebar .nav-toggle:hover { background-color: var(--background); }
        .mt-sidebar .nav-toggle svg { width: 16px; height: 16px; transition: transform 0.2s; }
        .mt-sidebar .nav-toggle.active svg { transform: rotate(180deg); }
        .mt-sidebar .nav-items { display: none; padding-left: 0.75rem; margin-top: 0.25rem; }
        .mt-sidebar .nav-items.show { display: block; }
        .mt-sidebar .nav-item {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            border-radius: var(--radius-sm);
            margin-bottom: 0.25rem;
            text-decoration: none;
            color: var(--text-primary);
            display: block;
        }
        .mt-sidebar .nav-item:hover { background-color: var(--background); }
        .mt-sidebar .nav-item.active { background-color: rgba(49, 130, 246, 0.15); color: var(--primary); font-weight: 600; }
        .mt-main { flex: 1; min-width: 0; }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 1.25rem;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--helku) 0%, var(--primary) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(49, 130, 246, 0.4);
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.2s, box-shadow 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .fab:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(66, 133, 244, 0.5);
        }

        .fab:active {
            transform: scale(0.95);
        }

        .fab-icon {
            color: white;
            font-size: 24px;
            font-weight: 300;
            line-height: 1;
        }


        @media (max-width: 768px) {
            .mt-container { flex-direction: column; }
            .mt-sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border); }
        }

        /* 모바일 전용 스타일 (board-mobile.html과 완전 동일) */
        @media (max-width: 767px) {
            body {
                padding-bottom: 2rem;
                background-color: var(--background);
                background-image: none;
            }
            .mt-container {
                flex-direction: column;
            }
            .header {
                display: none;
            }
            .mobile-header {
                display: block !important;
            }
            .mt-sidebar {
                display: none !important;
            }
            .mt-sidebar-header {
                display: none;
            }
            .mt-main {
                padding: 0;
                max-width: 100%;
                width: 100%;
            }
            #dashboardScreen {
                padding: 0;
            }
            .summary-cards {
                padding: 1rem;
                gap: 0.75rem;
            }
            .summary-card {
                padding: 1rem;
            }
            .summary-value {
                font-size: 1.25rem;
            }
            .period-toggle-section {
                padding: 0 1rem 0.75rem;
            }
            .product-tabs-wrap {
                padding: 0 1rem 0.75rem;
            }
            .product-tabs-slide {
                gap: 0.5rem;
            }
            .product-tab {
                padding: 0.625rem 0.375rem;
                font-size: 0.75rem;
            }
            .calendar-section {
                margin: 0 1rem 1rem;
                padding: 1rem;
                min-height: auto;
            }
            .calendar-header {
                margin-bottom: 0.75rem;
            }
            .calendar-title {
                font-size: 0.9375rem;
            }
            .calendar-nav button {
                width: 28px;
                height: 28px;
                font-size: 1rem;
            }
            .calendar-day {
                min-height: 40px;
                padding: 1px;
                font-size: 0.75rem;
            }
            .calendar-day-num {
                font-size: 0.75rem;
            }
            .calendar-day-profit {
                font-size: 0.5rem !important;
                line-height: 1.1;
            }
            .calendar-day-data {
                font-size: 0.55rem;
                max-height: none;
                margin-top: 0.15rem;
                overflow: visible;
                -webkit-overflow-scrolling: touch;
            }
            .calendar-day-data > div {
                font-size: 0.5rem;
                margin-bottom: 0.05rem;
                line-height: 1.2;
            }
            .calendar-day-data .product-label-mobile {
                display: none !important;
            }
            .calendar-day {
                overflow: visible;
            }
            .calendar-day.clickable:active {
                background: rgba(0, 0, 0, 0.08);
            }
            .product-summary-section {
                margin: 0 1rem 1rem;
                padding: 1rem;
            }
            .product-summary-item {
                padding: 0.75rem;
            }
            .recent-section {
                margin: 0 1rem 1rem;
                padding: 1rem;
            }
            .fab {
                bottom: 1.5rem;
                right: 1rem;
                width: 48px;
                height: 48px;
            }
            .fab-icon {
                font-size: 20px;
            }
        }

        /* Tablet Styles */
        @media (min-width: 768px) {
            body {
                max-width: none;
                margin: 0;
                box-shadow: none;
            }
            .mt-main { max-width: 800px; margin: 0 auto; box-shadow: 0 0 20px rgba(0, 0, 0, 0.1); }

            .header {
                padding: 1.25rem 2rem;
            }

            .summary-cards {
                padding: 1.5rem 2rem;
                gap: 1.5rem;
            }

            .summary-card {
                padding: 1.5rem;
            }

            .period-toggle-section {
                padding: 0 2rem 1.25rem;
            }

            .period-toggle-container {
                padding: 1rem 1.25rem;
            }

            .summary-value {
                font-size: 2rem;
            }

            .product-tabs-wrap {
                padding: 0 2rem 1rem;
            }

            .calendar-section {
                margin: 0 2rem 1.5rem;
                padding: 1.5rem;
                min-height: 350px;
            }

            .product-summary-section {
                padding: 0 2rem 1.25rem;
            }

            .recent-section {
                padding: 0 2rem;
            }

            .fab {
                right: calc(50% - 400px + 2rem);
                width: 64px;
                height: 64px;
                bottom: 2.5rem;
            }

            .fab-icon {
                font-size: 28px;
            }

        }

        /* Desktop Styles */
        @media (min-width: 1024px) {
            .mt-main { max-width: 900px; }
            .fab {
                right: calc(50% - 450px + 2rem);
            }
        }


    </style>
</head>
<body>
    <div class="mt-container">
        <aside class="mt-sidebar">
            <div class="mt-sidebar-header">
                <a href="/" class="logo" style="text-decoration: none; color: inherit;">
                    <div class="logo-icon">
                        <svg fill="none" stroke-width="2" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                        </svg>
                    </div>
                    <div class="logo-text">
                        <h2>헬쿠</h2>
                        <p>셀러 데이터 분석</p>
                    </div>
                </a>
                <div th:replace="~{fragments/sidebar-nav :: nav}"></div>
            </div>
        </aside>
        
        <main class="mt-main">
    <!-- Login Section (when not logged in) -->
    <div id="loginSection" style="display: none;">
        <div class="header">
            <h1 class="header-title"><span class="brand">헬쿠</span> 매출 일지</h1>
        </div>
        <div class="login-section">
            <h2>로그인 / 회원가입</h2>
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">판매실적추이 그래프와 동일한 계정으로 로그인하세요.</p>
            <div id="loginForm">
                <div class="form-group">
                    <label for="mtUserId">아이디</label>
                    <input type="text" id="mtUserId" placeholder="아이디">
                </div>
                <div class="form-group">
                    <label for="mtUserPw">비밀번호</label>
                    <input type="password" id="mtUserPw" placeholder="비밀번호">
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="handleMtLogin()">로그인</button>
                    <button class="btn btn-secondary" onclick="showMtSignupForm()">회원가입</button>
                </div>
            </div>
            <div id="signupForm" style="display: none;">
                <div class="form-group">
                    <label for="mtSignupUserId">아이디</label>
                    <input type="text" id="mtSignupUserId" placeholder="아이디">
                </div>
                <div class="form-group">
                    <label for="mtSignupUserPw">비밀번호</label>
                    <input type="password" id="mtSignupUserPw" placeholder="비밀번호 (최소 4자)">
                </div>
                <div class="form-group">
                    <label for="mtSignupUserPwConfirm">비밀번호 확인</label>
                    <input type="password" id="mtSignupUserPwConfirm" placeholder="비밀번호 확인">
                </div>
                <div class="form-group">
                    <label>셀러 옵션</label>
                    <div class="radio-group">
                        <label class="radio-label"><input type="radio" name="mtSellerType" value="ROCKET_GROSS" checked> 로켓그로스</label>
                        <label class="radio-label"><input type="radio" name="mtSellerType" value="OTHER"> 기타</label>
                    </div>
                </div>
                <div class="form-group" id="mtSellerOtherGroup" style="display: none;">
                    <label for="mtSellerOther">기타 셀러명</label>
                    <input type="text" id="mtSellerOther" placeholder="셀러명">
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="handleMtSignup()">회원가입</button>
                    <button class="btn btn-secondary" onclick="showMtLoginForm()">취소</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboardScreen" style="display: none;">
        <!-- 모바일 헤더 (board-mobile.html과 완전 동일) -->
        <header class="mobile-header" style="display: none;">
            <div class="header-top">
                <a href="/" class="logo-link">
                    <div class="logo-icon">
                        <svg fill="none" stroke-width="2" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                        </svg>
                    </div>
                    <div class="logo-text">
                        <h2>매출 일지</h2>
                    </div>
                </a>
                <button class="menu-toggle" id="sidebarToggle">
                    <svg fill="none" stroke-width="2" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                    </svg>
                </button>
            </div>
            <a href="/" class="back-link">
                <svg fill="none" stroke-width="2" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                </svg>
                홈으로
            </a>
        </header>
        
        <!-- 모바일 메뉴 (board-mobile.html과 동일한 구조) -->
        <nav class="mobile-menu" id="mobileMenu">
            <div th:replace="~{fragments/sidebar-nav :: nav}"></div>
        </nav>
        
        <!-- 커스텀 확인 다이얼로그 (모바일 브라우저 기본 confirm 대체) -->
        <div class="custom-confirm-overlay" id="customConfirmDialog">
            <div class="custom-confirm-dialog">
                <div class="custom-confirm-title" id="customConfirmTitle">확인</div>
                <div class="custom-confirm-message" id="customConfirmMessage"></div>
                <div class="custom-confirm-buttons">
                    <button type="button" class="custom-confirm-btn cancel" id="customConfirmCancel">취소</button>
                    <button type="button" class="custom-confirm-btn confirm" id="customConfirmOk">확인</button>
                </div>
            </div>
        </div>
        
        <!-- 데스크톱 헤더 -->
        <div class="header" id="desktopHeader">
            <h1 class="header-title"><span class="brand">헬쿠</span> 매출 일지</h1>
            <div class="menu-icon" id="desktopSidebarToggle">☰</div>
        </div>

        <!-- 공통 기간 선택 토글 (총 순수익/평균 마진율 위에 배치) -->
        <div class="period-toggle-section">
            <div class="period-toggle-container">
                <button type="button" class="period-toggle-btn active" data-period="all">전체기간</button>
                <button type="button" class="period-toggle-btn" data-period="30">최근 한달</button>
                <button type="button" class="period-toggle-btn" data-period="7">최근 7일</button>
                <button type="button" class="period-toggle-btn" data-period="3">최근 3일</button>
                <button type="button" class="period-toggle-btn" data-period="1">어제</button>
            </div>
        </div>

        <div class="summary-cards">
            <div class="summary-card">
                <div class="summary-label">총 순수익</div>
                <div class="summary-value" id="totalProfit">0<span class="unit">원</span></div>
            </div>
            <div class="summary-card">
                <div class="summary-label">평균 마진율</div>
                <div class="summary-value grey" id="avgMarginRate">0%</div>
            </div>
        </div>

        <div class="product-tabs-wrap">
            <div class="product-tabs-carousel">
                <button type="button" class="product-tabs-nav prev" id="productTabsPrev" aria-label="이전" style="display: none;">‹</button>
                <div class="product-tabs-track" id="productTabsTrack"></div>
                <button type="button" class="product-tabs-nav next" id="productTabsNext" aria-label="다음" style="display: none;">›</button>
            </div>
            <div class="product-tabs-dots" id="productTabsDots"></div>
        </div>

        <div class="calendar-section" id="calendarSection">
            <div class="calendar-header">
                <span class="calendar-title" id="calendarTitle">2026년 2월</span>
                <div class="calendar-nav">
                    <button type="button" id="calendarPrev" aria-label="이전 달">‹</button>
                    <button type="button" id="calendarNext" aria-label="다음 달">›</button>
                </div>
            </div>
            <div class="calendar-grid-wrap">
                <div class="calendar-weekdays">
                    <span class="sunday">SUN</span>
                    <span>MON</span>
                    <span>TUE</span>
                    <span>WED</span>
                    <span>THU</span>
                    <span>FRI</span>
                    <span>SAT</span>
                </div>
                <div class="calendar-days" id="calendarDays"></div>
            </div>
        </div>

        <div class="product-summary-section">
            <h2 class="section-title" id="productSummaryTitle">매출 내역 (전체기간)</h2>
            <div class="product-summary-list" id="productSummaryList">
                <div class="empty-message">아직 기록이 없습니다</div>
            </div>
        </div>

        <div class="recent-section">
            <h2 class="section-title">최근 기록</h2>
            <div class="records-carousel">
                <div class="records-slide" id="recordsList">
                    <div class="empty-message">아직 기록이 없습니다</div>
                </div>
                <div class="records-nav" id="recordsNav" style="display: none;">
                    <button type="button" id="recordsPrev">← 이전</button>
                    <span class="page-info" id="recordsPageInfo">1 / 1</span>
                    <button type="button" id="recordsNext">다음 →</button>
                </div>
            </div>
        </div>
    </div>


        </main>
    </div>

    <script>
    // 전역 함수로 정의 (onclick 속성에서 호출 가능하도록)
    function toggleNav(id) {
        const navItems = document.getElementById(id);
        const toggle = navItems ? navItems.previousElementSibling : null;
        
        if (navItems && toggle) {
            navItems.classList.toggle('show');
            toggle.classList.toggle('active');
        }
    }

    // 커스텀 확인 다이얼로그 함수 (모바일 브라우저 기본 confirm 대체)
    function showCustomConfirm(message, onConfirm) {
        var dialog = document.getElementById('customConfirmDialog');
        var messageEl = document.getElementById('customConfirmMessage');
        var okBtn = document.getElementById('customConfirmOk');
        var cancelBtn = document.getElementById('customConfirmCancel');
        
        if (!dialog || !messageEl || !okBtn || !cancelBtn) {
            // 폴백: 기본 confirm 사용
            if (confirm(message)) {
                onConfirm();
            }
            return;
        }
        
        messageEl.textContent = message;
        dialog.classList.add('show');
        
        // 기존 이벤트 리스너 제거 후 재바인딩
        var newOkBtn = okBtn.cloneNode(true);
        var newCancelBtn = cancelBtn.cloneNode(true);
        okBtn.parentNode.replaceChild(newOkBtn, okBtn);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        newOkBtn.addEventListener('click', function() {
            dialog.classList.remove('show');
            if (onConfirm) onConfirm();
        });
        
        newCancelBtn.addEventListener('click', function() {
            dialog.classList.remove('show');
        });
        
        // 오버레이 클릭 시 닫기
        dialog.addEventListener('click', function(e) {
            if (e.target === dialog) {
                dialog.classList.remove('show');
            }
        });
    }
    </script>
    <script>
        var mtUserId = localStorage.getItem('salesChart_userId');
        var mtLoginTime = localStorage.getItem('salesChart_loginTime');
        if (mtUserId && mtLoginTime && (Date.now() - parseInt(mtLoginTime, 10)) > 30 * 60 * 1000) {
            localStorage.removeItem('salesChart_userId');
            localStorage.removeItem('salesChart_loginTime');
            mtUserId = null;
        }

        document.querySelectorAll('input[name="mtSellerType"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                document.getElementById('mtSellerOtherGroup').style.display = this.value === 'OTHER' ? 'block' : 'none';
            });
        });

        function showMtLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
        }
        function showMtSignupForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
        }

        async function handleMtLogin() {
            const userId = document.getElementById('mtUserId')?.value.trim();
            const userPw = document.getElementById('mtUserPw')?.value.trim();
            if (!userId || !userPw) {
                alert('아이디와 비밀번호를 입력해주세요.');
                return;
            }
            try {
                const res = await fetch('/api/sales-chart/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: userId, userPw: userPw })
                });
                const result = await res.json();
                if (result.success) {
                    localStorage.setItem('salesChart_userId', result.userId);
                    localStorage.setItem('salesChart_loginTime', Date.now().toString());
                    window.location.reload();
                } else {
                    alert(result.message || '로그인에 실패했습니다.');
                }
            } catch (e) {
                alert('로그인 중 오류가 발생했습니다.');
            }
        }

        async function handleMtSignup() {
            const userId = document.getElementById('mtSignupUserId')?.value.trim();
            const userPw = document.getElementById('mtSignupUserPw')?.value.trim();
            const userPwConfirm = document.getElementById('mtSignupUserPwConfirm')?.value.trim();
            const sellerType = document.querySelector('input[name="mtSellerType"]:checked')?.value || 'ROCKET_GROSS';
            const sellerOther = document.getElementById('mtSellerOther')?.value.trim();
            if (!userId || !userPw || !userPwConfirm) {
                alert('모든 필드를 입력해주세요.');
                return;
            }
            if (userPw !== userPwConfirm) {
                alert('비밀번호가 일치하지 않습니다.');
                return;
            }
            if (sellerType === 'OTHER' && !sellerOther) {
                alert('기타 셀러명을 입력해주세요.');
                return;
            }
            try {
                const res = await fetch('/api/sales-chart/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        userPw: userPw,
                        userPwConfirm: userPwConfirm,
                        sellerType: sellerType,
                        sellerOther: sellerType === 'OTHER' ? sellerOther : null
                    })
                });
                const result = await res.json();
                if (result.success) {
                    alert('회원가입이 완료되었습니다.');
                    localStorage.setItem('salesChart_userId', result.userId);
                    localStorage.setItem('salesChart_loginTime', Date.now().toString());
                    window.location.reload();
                } else {
                    alert(result.message || '회원가입에 실패했습니다.');
                }
            } catch (e) {
                alert('회원가입 중 오류가 발생했습니다.');
            }
        }

        // Calendar state
        var calendarYear = new Date().getFullYear();
        var calendarMonth = new Date().getMonth();
        // 단일 상품만 선택 (첫 번째 상품 기본 선택, 탭 클릭 시 해당 상품만 선택)
        var selectedProductKey = null;
        var selectedProductLabel = null;

        function getDistinctProducts(records) {
            var map = new Map();
            records.forEach(function(r) {
                var key = r.productNumber || r.productName || '미분류';
                // 이름 먼저, 번호 나중
                var label = (r.productNumber && r.productName) ? (r.productName + ' / ' + r.productNumber) : (r.productName || r.productNumber || '미분류');
                if (!map.has(key)) map.set(key, label);
            });
            return Array.from(map.entries()).map(function(entry) { return { key: entry[0], label: entry[1] }; });
        }

        function getRecordDateKey(record) {
            // 판매일자(sale_date) 기준으로 사용 - timestamp(reg_date) 무시
            var dStr = record.date;
            if (!dStr || typeof dStr !== 'string') return '';
            var m = dStr.match(/(\d{4})\s*년\s*(\d{1,2})\s*월\s*(\d{1,2})\s*일/);
            if (m) return m[1] + '-' + String(parseInt(m[2],10)).padStart(2, '0') + '-' + String(parseInt(m[3],10)).padStart(2, '0');
            m = dStr.match(/(\d{1,2})\s*월\s*(\d{1,2})\s*일/);
            if (m) {
                var y = new Date().getFullYear();
                return y + '-' + String(parseInt(m[1],10)).padStart(2, '0') + '-' + String(parseInt(m[2],10)).padStart(2, '0');
            }
            if (/^\d{4}-\d{2}-\d{2}$/.test(dStr)) return dStr;
            return '';
        }

        function getRecordProductKey(record) {
            return record.productNumber || record.productName || '미분류';
        }

        /** 선택된 상품 기준으로 기록 필터 (단일 선택) */
        function getRecordsForSelectedProduct(records) {
            if (!records || records.length === 0) return [];
            if (!selectedProductKey) return [];
            return records.filter(function(r) { return getRecordProductKey(r) === selectedProductKey; });
        }

        function getProfitForDate(productKey, dateKey) {
            if (!productKey || !dateKey || !allRecords.length) return null;
            var sum = 0;
            allRecords.forEach(function(r) {
                if (getRecordProductKey(r) !== productKey) return;
                if (getRecordDateKey(r) !== dateKey) return;
                sum += parseFloat(r.netProfit) || 0;
            });
            return sum;
        }

        var productTabsCurrentSlide = 0;
        var productTabsTotalSlides = 0;

        var registeredProducts = [];

        function renderProductTabs(records, registered) {
            var track = document.getElementById('productTabsTrack');
            var prevBtn = document.getElementById('productTabsPrev');
            var nextBtn = document.getElementById('productTabsNext');
            var dotsEl = document.getElementById('productTabsDots');
            if (!track) return;
            var fromRecords = getDistinctProducts(records || []);
            var seen = new Set();
            var allProducts = [];
            // 1) 등록 상품을 노출 순서(display_order)대로 먼저 (API가 이미 순서대로 반환)
            if (registered && registered.length > 0) {
                registered.forEach(function(r) {
                    var key = r.productNumber || '';
                    var label = (r.productNumber && r.productName) ? (r.productName + ' / ' + r.productNumber) : (r.productName || r.productNumber || '');
                    if (key) {
                        seen.add(key);
                        allProducts.push({ key: key, label: label });
                    }
                });
            }
            // 2) 기록에만 있는 상품을 뒤에 추가
            fromRecords.forEach(function(p) {
                if (!seen.has(p.key)) {
                    seen.add(p.key);
                    allProducts.push(p);
                }
            });
            // 단일 선택: 목록 중 첫 번째 상품을 기본 선택 (기존 선택이 목록에 없으면 첫 번째로)
            if (allProducts.length > 0) {
                var stillInList = selectedProductKey && productMap.has(selectedProductKey);
                if (!stillInList) {
                    selectedProductKey = allProducts[0].key;
                    selectedProductLabel = allProducts[0].label;
                }
            } else {
                selectedProductKey = null;
                selectedProductLabel = null;
            }
            track.innerHTML = '';
            var items = [];
            if (allProducts.length > 0) {
                allProducts.forEach(function(p) {
                    items.push({ type: 'product', key: p.key, label: p.label });
                });
            }
            items.push({ type: 'register' });
            items.push({ type: 'edit' });
            var slides = [];
            for (var i = 0; i < items.length; i += 3) {
                slides.push(items.slice(i, i + 3));
            }
            productTabsTotalSlides = slides.length;
            productTabsCurrentSlide = 0;
            slides.forEach(function(slideItems) {
                var slide = document.createElement('div');
                slide.className = 'product-tabs-slide';
                slideItems.forEach(function(item) {
                    if (item.type === 'register') {
                        var a = document.createElement('a');
                        a.href = '/margin-tracker/product-register';
                        a.className = 'product-tab register';
                        a.setAttribute('data-register', 'true');
                        a.textContent = '상품 등록';
                        slide.appendChild(a);
                    } else if (item.type === 'edit') {
                        var editBtn = document.createElement('a');
                        editBtn.href = '/margin-tracker/product-register?mode=edit';
                        editBtn.className = 'product-tab edit';
                        editBtn.setAttribute('data-edit', 'true');
                        editBtn.textContent = '상품 수정';
                        slide.appendChild(editBtn);
                    } else {
                        var tab = document.createElement('div');
                        tab.className = 'product-tab';
                        var pKey = item.key;
                        var pLabel = item.label;
                        tab.setAttribute('data-product-key', pKey);
                        tab.setAttribute('data-product-label', pLabel);
                        tab.textContent = pLabel.length > 12 ? pLabel.slice(0, 11) + '…' : pLabel;
                        tab.title = pLabel;
                        if (selectedProductKey === pKey) {
                            tab.classList.add('on');
                        }
                        tab.addEventListener('click', function() {
                            selectedProductKey = pKey;
                            selectedProductLabel = pLabel;
                            document.querySelectorAll('.product-tab[data-product-key]').forEach(function(t) {
                                t.classList.toggle('on', t.getAttribute('data-product-key') === pKey);
                            });
                            renderCalendar();
                            updateProfitDisplay();
                            updateMarginDisplay();
                            renderProductSummary(allRecords, registeredProducts);
                            loadRecordsPage(1);
                        });
                        slide.appendChild(tab);
                    }
                });
                track.appendChild(slide);
            });
            if (productTabsTotalSlides <= 1) {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
                dotsEl.innerHTML = '';
            } else {
                prevBtn.style.display = 'flex';
                nextBtn.style.display = 'flex';
                dotsEl.innerHTML = '';
                for (var d = 0; d < productTabsTotalSlides; d++) {
                    var dot = document.createElement('button');
                    dot.type = 'button';
                    dot.className = 'product-tabs-dot' + (d === 0 ? ' active' : '');
                    dot.setAttribute('aria-label', (d + 1) + '번째 슬라이드');
                    dot.addEventListener('click', function() {
                        var idx = parseInt(this.getAttribute('data-idx'), 10);
                        productTabsCurrentSlide = idx;
                        updateProductTabsCarousel();
                    });
                    dot.setAttribute('data-idx', d);
                    dotsEl.appendChild(dot);
                }
            }
            updateProductTabsCarousel();
        }

        function updateProductTabsCarousel() {
            var track = document.getElementById('productTabsTrack');
            var prevBtn = document.getElementById('productTabsPrev');
            var nextBtn = document.getElementById('productTabsNext');
            if (!track) return;
            track.style.transform = 'translateX(-' + (productTabsCurrentSlide * 100) + '%)';
            if (prevBtn) prevBtn.disabled = productTabsCurrentSlide <= 0;
            if (nextBtn) nextBtn.disabled = productTabsCurrentSlide >= productTabsTotalSlides - 1;
            document.querySelectorAll('#productTabsDots .product-tabs-dot').forEach(function(dot, i) {
                dot.classList.toggle('active', i === productTabsCurrentSlide);
            });
        }

        function renderProductSummary(records, registered) {
            var container = document.getElementById('productSummaryList');
            if (!container) return;
            var byProductOption = {};
            var totalProfit = 0;
            
            // 옵션별로 구분하여 집계
            if (records && records.length > 0) {
                records.forEach(function(r) {
                    var profit = parseFloat(r.netProfit) || 0;
                    totalProfit += profit;
                    
                    var productKey = getRecordProductKey(r);
                    var productName = r.productName || '';
                    var productNumber = r.productNumber || '';
                    var productLabel = (productNumber && productName) ? (productName + ' / ' + productNumber) : (productName || productNumber || '미분류');
                    
                    if (!byProductOption[productKey]) {
                        byProductOption[productKey] = { 
                            label: productLabel, 
                            productName: productName,
                            productNumber: productNumber,
                            options: {} 
                        };
                    }
                    
                    // 옵션 키 생성 (옵션 ID 또는 별칭으로 구분)
                    var optKey = '';
                    if (r.optionId) {
                        optKey = 'opt_' + r.optionId;
                    } else if (r.optionAlias) {
                        optKey = 'opt_' + r.optionAlias;
                    } else {
                        optKey = 'no_option';
                    }
                    
                    if (!byProductOption[productKey].options[optKey]) {
                        byProductOption[productKey].options[optKey] = {
                            optionId: r.optionId || null,
                            optionAlias: r.optionAlias || null,
                            profit: 0
                        };
                    }
                    byProductOption[productKey].options[optKey].profit += profit;
                });
            }
            
            // 등록된 상품 중 매출이 없는 것도 표시
            if (registered && registered.length > 0) {
                registered.forEach(function(r) {
                    var key = r.productNumber || '';
                    var productName = r.productName || '';
                    var productNumber = r.productNumber || '';
                    var label = (productNumber && productName) ? (productName + ' / ' + productNumber) : (productName || productNumber || '');
                    if (key && !byProductOption[key]) {
                        byProductOption[key] = { 
                            label: label, 
                            productName: productName,
                            productNumber: productNumber,
                            options: {} 
                        };
                    }
                });
            }
            
            // 리스트 생성: 각 상품의 각 옵션을 개별 항목으로
            var list = [];
            Object.keys(byProductOption).forEach(function(productKey) {
                var productInfo = byProductOption[productKey];
                var optionKeys = Object.keys(productInfo.options);
                
                if (optionKeys.length === 0) {
                    // 옵션이 없고 매출도 없는 경우
                    list.push({
                        key: productKey,
                        label: productInfo.productName || productInfo.label,
                        productNumber: productInfo.productNumber || '',
                        profit: 0,
                        isOption: false,
                        optionIndex: 0
                    });
                } else {
                    // 옵션별로 순서 번호 매기기 (옵션 ID/별칭 기준으로 정렬)
                    var sortedOptions = optionKeys.map(function(optKey) {
                        return productInfo.options[optKey];
                    }).sort(function(a, b) {
                        // 옵션 ID나 별칭으로 정렬
                        var aKey = (a.optionId || a.optionAlias || '').toString();
                        var bKey = (b.optionId || b.optionAlias || '').toString();
                        return aKey.localeCompare(bKey);
                    });
                    
                    sortedOptions.forEach(function(opt, optIdx) {
                        list.push({
                            key: productKey + '_' + optIdx,
                            label: productInfo.productName || productInfo.label,
                            productNumber: productInfo.productNumber || '',
                            profit: opt.profit || 0,
                            isOption: !!(opt.optionId || opt.optionAlias),
                            optionIndex: optIdx + 1
                        });
                    });
                }
            });
            
            list.sort(function(a, b) { return b.profit - a.profit; });
            container.innerHTML = '';
            if (list.length === 0) {
                container.innerHTML = '<div class="empty-message">아직 기록이 없습니다</div>';
                return;
            }
            
            list.forEach(function(item, idx) {
                var pct = totalProfit !== 0 ? (item.profit / totalProfit * 100) : 0;
                var barWidth = totalProfit !== 0 ? Math.min(100, Math.max(0, (item.profit / totalProfit * 100))) : 0;
                var row = document.createElement('div');
                row.className = 'product-summary-item';
                var labelEl = document.createElement('span');
                labelEl.className = 'product-summary-label';
                // 전체기간일 때: 상품명 (상품번호)(옵션번호) 형식
                var displayLabel = item.label || '';
                if (item.productNumber) {
                    displayLabel = displayLabel + ' (' + item.productNumber + ')';
                }
                if (item.isOption) {
                    displayLabel = displayLabel + '(' + item.optionIndex + ')';
                }
                if (displayLabel.length > 20) displayLabel = displayLabel.slice(0, 19) + '…';
                labelEl.textContent = (idx + 1) + '. ' + displayLabel;
                var fullTitle = item.label || '';
                if (item.productNumber) {
                    fullTitle = fullTitle + ' (' + item.productNumber + ')';
                }
                if (item.isOption) {
                    fullTitle = fullTitle + '(' + item.optionIndex + ')';
                }
                labelEl.title = fullTitle;
                var barWrap = document.createElement('div');
                barWrap.className = 'product-summary-bar-wrap';
                var bar = document.createElement('div');
                bar.className = 'product-summary-bar';
                bar.style.width = barWidth + '%';
                var pctEl = document.createElement('span');
                pctEl.className = 'product-summary-pct';
                pctEl.textContent = pct.toFixed(0) + '%';
                barWrap.appendChild(bar);
                row.appendChild(labelEl);
                row.appendChild(barWrap);
                row.appendChild(pctEl);
                container.appendChild(row);
            });
        }

        function renderCalendar() {
            var titleEl = document.getElementById('calendarTitle');
            var daysEl = document.getElementById('calendarDays');
            if (!titleEl || !daysEl) return;
            titleEl.textContent = calendarYear + '년 ' + (calendarMonth + 1) + '월';

            var first = new Date(calendarYear, calendarMonth, 1);
            var last = new Date(calendarYear, calendarMonth + 1, 0);
            var startDow = first.getDay();
            var daysInMonth = last.getDate();
            var prevMonth = new Date(calendarYear, calendarMonth, 0);
            var prevDays = prevMonth.getDate();

            daysEl.innerHTML = '';
            var totalCells = Math.ceil((startDow + daysInMonth) / 7) * 7;
            for (var i = 0; i < totalCells; i++) {
                var cell = document.createElement('div');
                cell.className = 'calendar-day';
                var dayNum;
                var isOther = false;
                if (i < startDow) {
                    dayNum = prevDays + 1 - startDow + i;
                    isOther = true;
                } else if (i >= startDow + daysInMonth) {
                    dayNum = i - startDow - daysInMonth + 1;
                    isOther = true;
                } else {
                    dayNum = i - startDow + 1;
                }
                var numSpan = document.createElement('span');
                numSpan.className = 'calendar-day-num';
                numSpan.textContent = dayNum;
                cell.appendChild(numSpan);
                if (!isOther) {
                    var dateKey = calendarYear + '-' + String(calendarMonth + 1).padStart(2, '0') + '-' + String(dayNum).padStart(2, '0');
                    var dateObj = new Date(calendarYear, calendarMonth, dayNum);
                    dateObj.setHours(0, 0, 0, 0);
                    
                    // 선택된 상품 + 기간 필터 적용
                    var filteredRecords = profitPeriod === 'all' ? allRecords : filterRecordsByPeriod(allRecords, profitPeriod);
                    var forSelected = getRecordsForSelectedProduct(filteredRecords);
                    var dayRecords = [];
                    forSelected.forEach(function(r) {
                        var rDate = getRecordDate(r);
                        if (rDate) {
                            rDate.setHours(0, 0, 0, 0);
                            if (rDate.getTime() === dateObj.getTime()) {
                                dayRecords.push(r);
                            }
                        }
                    });
                    
                    if (dayRecords.length > 0) {
                        var profitContainer = document.createElement('div');
                        profitContainer.className = 'calendar-day-data';
                        
                        // 같은 상품별로 그룹화하고 옵션 순서 번호 매기기
                        var productGroups = {};
                        dayRecords.forEach(function(record) {
                            var productKey = getRecordProductKey(record);
                            if (!productGroups[productKey]) {
                                productGroups[productKey] = [];
                            }
                            productGroups[productKey].push(record);
                        });
                        
                        // 각 상품 그룹별로 표시
                        Object.keys(productGroups).forEach(function(productKey) {
                            var records = productGroups[productKey];
                            var productLabel = (records[0].productName || records[0].productNumber || '미분류');
                            if (productLabel.length > 6) productLabel = productLabel.slice(0, 5) + '…';
                            
                            // 모바일 감지: matchMedia를 사용하여 더 정확하게 감지
                            var isMobile = window.matchMedia('(max-width: 767px)').matches || window.innerWidth <= 767;
                            
                            if (records.length === 1 && !records[0].optionId && !records[0].optionAlias) {
                                // 옵션이 없는 경우
                                var profit = parseFloat(records[0].netProfit) || 0;
                                var recordDiv = document.createElement('div');
                                recordDiv.style.cssText = 'margin-bottom: 0.05rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center;';
                                // 모바일이든 데스크톱이든 항상 제품명과 금액을 포함하되, CSS로 모바일에서 제품명 숨김
                                recordDiv.innerHTML = '<span class="product-label-mobile" style="color: var(--text-secondary); font-size: 0.6rem;">' + escapeHtml(productLabel) + '</span> ' +
                                    '<span class="calendar-day-profit ' + (profit >= 0 ? 'positive' : 'negative') + '" style="font-weight: 600; font-size: 0.65rem;">' +
                                    (profit >= 0 ? '+' : '') + Math.round(profit).toLocaleString('ko-KR') + '</span>';
                                profitContainer.appendChild(recordDiv);
                            } else {
                                // 옵션이 있는 경우: 각 옵션별로 표시
                                records.forEach(function(record, idx) {
                                    var profit = parseFloat(record.netProfit) || 0;
                                    var recordDiv = document.createElement('div');
                                    recordDiv.style.cssText = 'margin-bottom: 0.05rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center;';
                                    // 모바일이든 데스크톱이든 항상 옵션명과 금액을 포함하되, CSS로 모바일에서 옵션명 숨김
                                    var optionLabel = productLabel + ' (' + (idx + 1) + ')';
                                    recordDiv.innerHTML = '<span class="product-label-mobile" style="color: var(--text-secondary); font-size: 0.6rem;">' + escapeHtml(optionLabel) + '</span> ' +
                                        '<span class="calendar-day-profit ' + (profit >= 0 ? 'positive' : 'negative') + '" style="font-weight: 600; font-size: 0.65rem;">' +
                                        (profit >= 0 ? '+' : '') + Math.round(profit).toLocaleString('ko-KR') + '</span>';
                                    profitContainer.appendChild(recordDiv);
                                });
                            }
                        });
                        cell.appendChild(profitContainer);
                    }
                }
                if (isOther) cell.classList.add('other-month');
                else {
                    cell.classList.add('clickable');
                    cell.setAttribute('data-year', calendarYear);
                    cell.setAttribute('data-month', calendarMonth + 1);
                    cell.setAttribute('data-day', dayNum);
                    cell.addEventListener('click', function onDayClick() {
                        if (!selectedProductKey) return;
                        var y = parseInt(this.getAttribute('data-year'), 10);
                        var m = parseInt(this.getAttribute('data-month'), 10);
                        var d = parseInt(this.getAttribute('data-day'), 10);
                        var label = selectedProductLabel || '해당 상품';
                        var msg = m + '/' + d + '일 ' + label + ' 상품 판매 정보를 등록하시겠습니까?';
                        // 커스텀 확인 다이얼로그 사용 (모바일 브라우저 기본 confirm 대체)
                        showCustomConfirm(msg, function() {
                            window.location.href = '/margin-tracker/input?date=' + y + '-' + String(m).padStart(2,'0') + '-' + String(d).padStart(2,'0') + '&product=' + encodeURIComponent(selectedProductKey || '');
                        });
                    });
                }
                var dayOfWeek = i % 7;
                if (dayOfWeek === 0) cell.classList.add('sunday');
                daysEl.appendChild(cell);
            }
        }

        function calendarPrevMonth() {
            calendarMonth--;
            if (calendarMonth < 0) { calendarYear--; calendarMonth = 11; }
            renderCalendar();
        }
        function calendarNextMonth() {
            calendarMonth++;
            if (calendarMonth > 11) { calendarYear++; calendarMonth = 0; }
            renderCalendar();
        }

        // 사이드바 토글 (모바일 - board-mobile.html과 동일한 방식)
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            if (menu) {
                menu.classList.toggle('show');
                // 인라인 스타일 제거하여 CSS가 제대로 적용되도록 함
                if (menu.classList.contains('show')) {
                    menu.style.display = '';
                    // 메뉴가 열릴 때 nav-toggle 이벤트 재바인딩
                    setTimeout(function() {
                        bindNavToggleEventsForMenu();
                    }, 100);
                } else {
                    menu.style.display = 'none';
                }
            }
        }
        
        // 모바일 메뉴 내부의 nav-toggle 이벤트 바인딩 함수 (전역 함수로 정의)
        function bindNavToggleEventsForMenu() {
            var mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenu) {
                mobileMenu.querySelectorAll('.nav-toggle').forEach(function(toggle) {
                    // 기존 이벤트 리스너 제거를 위해 클론 후 교체
                    var newToggle = toggle.cloneNode(true);
                    toggle.parentNode.replaceChild(newToggle, toggle);
                    
                    newToggle.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        
                        // onclick 속성에서 ID 추출
                        var onclickAttr = this.getAttribute('onclick');
                        var navId = null;
                        
                        if (onclickAttr) {
                            // onclick="toggleNav('nov2025')" 형식 파싱
                            var match = onclickAttr.match(/toggleNav\(['"]([^'"]+)['"]\)/);
                            if (match && match[1]) {
                                navId = match[1];
                            }
                        }
                        
                        // 다음 형제 요소가 nav-items인지 확인
                        if (!navId) {
                            var nextSibling = this.nextElementSibling;
                            if (nextSibling && nextSibling.classList && nextSibling.classList.contains('nav-items')) {
                                navId = nextSibling.id;
                            }
                        }
                        
                        if (navId) {
                            toggleNav(navId);
                        } else if (onclickAttr) {
                            // 폴백: onclick 속성 직접 실행
                            try {
                                eval(onclickAttr);
                            } catch (err) {
                                console.error('Error executing onclick:', err, onclickAttr);
                            }
                        }
                    });
                });
            }
        }

        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // 모바일 메뉴 토글 (board-mobile.html과 동일)
            var sidebarToggle = document.getElementById('sidebarToggle');
            var desktopSidebarToggle = document.getElementById('desktopSidebarToggle');
            var mobileMenu = document.getElementById('mobileMenu');
            
            if (sidebarToggle && mobileMenu) {
                sidebarToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleMobileMenu();
                });
            }
            
            if (desktopSidebarToggle) {
                desktopSidebarToggle.addEventListener('click', function() {
                    var sidebar = document.querySelector('.mt-sidebar');
                    if (sidebar) {
                        sidebar.style.display = sidebar.style.display === 'none' ? 'block' : 'none';
                    }
                });
            }
            
            // 외부 클릭 시 메뉴 닫기
            document.addEventListener('click', function(event) {
                if (mobileMenu && mobileMenu.classList.contains('show') && 
                    !mobileMenu.contains(event.target) && 
                    sidebarToggle && !sidebarToggle.contains(event.target)) {
                    mobileMenu.classList.remove('show');
                }
            });
            
            // 초기 바인딩
            bindNavToggleEventsForMenu();
            
            // dashboardScreen이 표시될 때 다시 바인딩
            var observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        var dashboardScreen = document.getElementById('dashboardScreen');
                        if (dashboardScreen && dashboardScreen.style.display !== 'none') {
                            setTimeout(bindNavToggleEventsForMenu, 100);
                        }
                    }
                });
            });
            
            var dashboardScreen = document.getElementById('dashboardScreen');
            if (dashboardScreen) {
                observer.observe(dashboardScreen, { attributes: true });
            }
            
            
            if (mtUserId) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboardScreen').style.display = 'block';
                
                // 모바일 메뉴 이벤트 재바인딩 (dashboardScreen이 표시된 후)
                setTimeout(function() {
                    bindNavToggleEventsForMenu();
                }, 300);
                
                renderCalendar();
                document.getElementById('calendarPrev').addEventListener('click', calendarPrevMonth);
                document.getElementById('calendarNext').addEventListener('click', calendarNextMonth);
                document.getElementById('productTabsPrev').addEventListener('click', function() {
                    if (productTabsCurrentSlide > 0) { productTabsCurrentSlide--; updateProductTabsCarousel(); }
                });
                document.getElementById('productTabsNext').addEventListener('click', function() {
                    if (productTabsCurrentSlide < productTabsTotalSlides - 1) { productTabsCurrentSlide++; updateProductTabsCarousel(); }
                });
                // 공통 기간 선택 토글
                document.querySelectorAll('.period-toggle-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.period-toggle-btn').forEach(function(b) { b.classList.remove('active'); });
                        this.classList.add('active');
                        var period = this.getAttribute('data-period');
                        profitPeriod = period;
                        marginPeriod = period;
                        updateProfitDisplay();
                        updateMarginDisplay();
                    });
                });
                loadData();
            } else {
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('dashboardScreen').style.display = 'none';
                showMtLoginForm();
            }
        });

        const PAGE_SIZE = 5;
        let allRecords = [];
        let currentRecordsPage = 1;
        let totalRecordsCount = 0;

        async function loadData() {
            const userId = localStorage.getItem('salesChart_userId');
            if (!userId) return;
            try {
                const res = await fetch('/api/margin-tracker/records?userId=' + encodeURIComponent(userId) + '&page=1&size=9999');
                const data = await res.json();
                allRecords = (data.success && data.records) ? data.records : [];
                totalRecordsCount = data.total != null ? data.total : allRecords.length;
                try {
                    const regRes = await fetch('/api/margin-tracker/registered-products?userId=' + encodeURIComponent(userId));
                    const regData = await regRes.json();
                    registeredProducts = (regData.success && regData.products) ? regData.products : [];
                } catch (e) {
                    registeredProducts = [];
                }
                renderProductTabs(allRecords, registeredProducts);
                renderSummaryAndChart(allRecords);
                loadRecordsPage(1);
            } catch (e) {
                console.error(e);
                document.getElementById('recordsList').innerHTML = '<div class="empty-message">데이터를 불러오는데 실패했습니다.</div>';
            }
        }

        var profitPeriod = 'all';
        var marginPeriod = 'all'; // profitPeriod와 동일하게 동작

        function filterRecordsByPeriod(records, period) {
            if (period === 'all') return records;
            var today = new Date();
            today.setHours(23, 59, 59, 999); // 오늘 끝 시간
            var cutoff = new Date();
            if (period === '1') {
                // 어제: 오늘 -1일부터 오늘까지
                cutoff.setDate(today.getDate() - 1);
                cutoff.setHours(0, 0, 0, 0);
                return records.filter(function(r) {
                    var d = getRecordDate(r);
                    if (!d) return false;
                    d.setHours(0, 0, 0, 0);
                    return d >= cutoff && d <= today;
                });
            } else {
                // 최근 N일: 오늘 -N일부터 오늘까지
                var days = parseInt(period, 10);
                cutoff.setDate(today.getDate() - days);
                cutoff.setHours(0, 0, 0, 0);
                return records.filter(function(r) {
                    var d = getRecordDate(r);
                    if (!d) return false;
                    d.setHours(0, 0, 0, 0);
                    return d >= cutoff && d <= today;
                });
            }
        }

        function getPeriodLabel(period) {
            if (period === 'all') return '전체기간';
            if (period === '30') return '최근 한달';
            if (period === '7') return '최근 7일';
            if (period === '3') return '최근 3일';
            if (period === '1') return '어제';
            return '전체기간';
        }

        function getRecordDate(record) {
            // 판매일자(sale_date) 기준으로 사용 - timestamp(reg_date) 무시
            var dStr = record.date;
            if (!dStr) return null;
            var m = dStr.match(/(\d{4})\s*년\s*(\d{1,2})\s*월\s*(\d{1,2})\s*일/);
            if (m) {
                var y = parseInt(m[1], 10);
                var mo = parseInt(m[2], 10) - 1;
                var d = parseInt(m[3], 10);
                return new Date(y, mo, d);
            }
            m = dStr.match(/(\d{1,2})\s*월\s*(\d{1,2})\s*일/);
            if (m) {
                var y = new Date().getFullYear();
                var mo = parseInt(m[1], 10) - 1;
                var d = parseInt(m[2], 10);
                return new Date(y, mo, d);
            }
            if (/^\d{4}-\d{2}-\d{2}/.test(dStr)) {
                try { return new Date(dStr); } catch (e) {}
            }
            return null;
        }

        function updateProfitDisplay() {
            var filtered = filterRecordsByPeriod(allRecords, profitPeriod);
            var forSelected = getRecordsForSelectedProduct(filtered);
            var totalProfit = 0;
            forSelected.forEach(function(record) {
                totalProfit += parseFloat(record.netProfit) || 0;
            });
            var profitEl = document.getElementById('totalProfit');
            profitEl.innerHTML = (totalProfit >= 0 ? '+' : '') + Math.round(totalProfit).toLocaleString('ko-KR') + '<span class="unit">원</span>';
            profitEl.className = 'summary-value' + (totalProfit >= 0 ? ' positive' : ' negative');
            var titleEl = document.getElementById('productSummaryTitle');
            if (titleEl) {
                titleEl.textContent = '매출 내역 (' + getPeriodLabel(profitPeriod) + ')';
            }
            // 선택된 상품만 매출 내역에 표시
            var recordsForSummary = getRecordsForSelectedProduct(allRecords);
            var regForSummary = selectedProductKey ? registeredProducts.filter(function(r) {
                return (r.productNumber || '') === selectedProductKey;
            }) : [];
            renderProductSummary(recordsForSummary, regForSummary);
            renderCalendar();
        }

        function updateMarginDisplay() {
            var filtered = filterRecordsByPeriod(allRecords, profitPeriod);
            var forSelected = getRecordsForSelectedProduct(filtered);
            var totalMarginRate = 0;
            var validMarginRates = 0;
            forSelected.forEach(function(record) {
                var mr = parseFloat(record.marginRate) || 0;
                // 마진율이 없거나 0이면 계산
                if (mr <= 0) {
                    var finalPrice = parseFloat(record.finalSellingPrice) || 0;
                    var marginPerUnit = parseFloat(record.marginPerUnit) || 0;
                    var totalMargin = parseFloat(record.totalMargin) || 0;
                    var actualRevenue = parseFloat(record.actualSalesRevenue) || 0;
                    
                    // 개당 마진과 최종 판매가로 계산
                    if (finalPrice > 0 && marginPerUnit !== 0) {
                        mr = (marginPerUnit / finalPrice) * 100;
                    }
                    // 또는 총 마진과 실제 매출로 계산
                    else if (actualRevenue > 0 && totalMargin !== 0) {
                        mr = (totalMargin / actualRevenue) * 100;
                    }
                }
                if (mr > 0) {
                    totalMarginRate += mr;
                    validMarginRates++;
                }
            });
            var avgMarginRate = validMarginRates > 0 ? totalMarginRate / validMarginRates : 0;
            document.getElementById('avgMarginRate').textContent = avgMarginRate.toFixed(1) + '%';
        }

        function renderSummaryAndChart(records) {
            if (records.length === 0) {
                var profitEl = document.getElementById('totalProfit');
                profitEl.innerHTML = '0<span class="unit">원</span>';
                profitEl.className = 'summary-value';
                document.getElementById('avgMarginRate').textContent = '0%';
                var titleEl = document.getElementById('productSummaryTitle');
                if (titleEl) {
                    titleEl.textContent = '매출 내역 (전체기간)';
                }
                return;
            }
            updateProfitDisplay();
            updateMarginDisplay();
        }

        function loadRecordsPage(page) {
            var filtered = getRecordsForSelectedProduct(allRecords);
            filtered = filtered.slice().sort(function(a, b) {
                var da = getRecordDate(a), db = getRecordDate(b);
                if (!da || !db) return 0;
                return db.getTime() - da.getTime();
            });
            totalRecordsCount = filtered.length;
            currentRecordsPage = page;
            var start = (page - 1) * PAGE_SIZE;
            var pageRecords = filtered.slice(start, start + PAGE_SIZE);
            renderRecordsPage(pageRecords);
            updateRecordsNav();
        }

        function renderRecordsPage(records) {
            const listEl = document.getElementById('recordsList');
            if (!records.length) {
                listEl.innerHTML = '<div class="empty-message">아직 기록이 없습니다</div>';
                return;
            }
            listEl.innerHTML = '';
            records.forEach(record => {
                const dateStr = record.date || (record.timestamp ? new Date(record.timestamp).toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric' }) : '-');
                const profit = parseFloat(record.netProfit) || 0;
                const productLabel = record.productNumber && record.productName
                    ? (record.productNumber + ' / ' + record.productName)
                    : (record.productNumber || record.productName || '');
                const div = document.createElement('div');
                div.className = 'record-item';
                div.innerHTML =
                    '<div class="record-left">' +
                    '<div class="record-date">' + escapeHtml(dateStr) + '</div>' +
                    (productLabel ? '<div class="record-product">' + escapeHtml(productLabel) + '</div>' : '') +
                    '</div>' +
                    '<div class="record-profit' + (profit >= 0 ? ' positive' : ' negative') + '">' + (profit >= 0 ? '+' : '') + Math.round(profit).toLocaleString('ko-KR') + '<span class="unit">원</span></div>' +
                    '<div class="record-actions">' +
                    '<button type="button" class="edit-btn" data-id="' + record.id + '">수정</button>' +
                    '<button type="button" class="delete-btn" data-id="' + record.id + '">삭제</button>' +
                    '</div>';
                listEl.appendChild(div);
            });
            listEl.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    window.location.href = '/margin-tracker/input?id=' + this.getAttribute('data-id');
                });
            });
            listEl.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (!confirm('이 기록을 삭제할까요?')) return;
                    deleteRecord(this.getAttribute('data-id'));
                });
            });
        }

        function escapeHtml(s) {
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        function updateRecordsNav() {
            const totalPages = Math.max(1, Math.ceil(totalRecordsCount / PAGE_SIZE));
            const nav = document.getElementById('recordsNav');
            if (totalRecordsCount <= PAGE_SIZE) {
                nav.style.display = 'none';
                return;
            }
            nav.style.display = 'flex';
            document.getElementById('recordsPageInfo').textContent = currentRecordsPage + ' / ' + totalPages;
            document.getElementById('recordsPrev').disabled = currentRecordsPage <= 1;
            document.getElementById('recordsNext').disabled = currentRecordsPage >= totalPages;
        }

        document.getElementById('recordsPrev').addEventListener('click', function() {
            if (currentRecordsPage > 1) loadRecordsPage(currentRecordsPage - 1);
        });
        document.getElementById('recordsNext').addEventListener('click', function() {
            const totalPages = Math.max(1, Math.ceil(totalRecordsCount / PAGE_SIZE));
            if (currentRecordsPage < totalPages) loadRecordsPage(currentRecordsPage + 1);
        });

        async function deleteRecord(id) {
            const userId = localStorage.getItem('salesChart_userId');
            if (!userId) return;
            try {
                const res = await fetch('/api/margin-tracker/record/' + id + '?userId=' + encodeURIComponent(userId), { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    loadData();
                } else {
                    alert(data.message || '삭제에 실패했습니다.');
                }
            } catch (e) {
                alert('삭제 중 오류가 발생했습니다.');
            }
        }

    </script>
</body>
</html>
