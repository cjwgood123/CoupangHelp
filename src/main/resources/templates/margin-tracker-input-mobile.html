<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>íŒë§¤ ë°ì´í„° ì…ë ¥ - í—¬ì¿  ë§¤ì¶œ ì¼ì§€</title>
    <script>
        (function(){
            var q = typeof window !== 'undefined' && window.location && window.location.search || '';
            if (/[?&]product=/.test(q) || /[?&]id=/.test(q)) {
                document.documentElement.classList.add('url-product-view');
            }
        })();
    </script>
    <!-- Flatpickr (ë‚ ì§œ ì„ íƒ ë¼ì´ë¸ŒëŸ¬ë¦¬) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4285F4;
            --primary-dark: #3367D6;
            --background: #F5F5F5;
            --card: #FFFFFF;
            --text-primary: #202124;
            --text-secondary: #5F6368;
            --text-disabled: #9AA0A6;
            --border: #E8EAED;
            --success: #34A853;
            --error: #EA4335;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        .input-header {
            background-color: var(--card);
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .back-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-primary);
            cursor: pointer;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            min-width: 44px;
            min-height: 44px;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }

        .back-button:hover {
            background-color: var(--background);
            border-radius: 50%;
        }

        .input-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            text-align: center;
        }

        .progress-info {
            font-size: 0.875rem;
            color: var(--text-secondary);
            min-width: 50px;
            text-align: right;
        }

        .progress-bar {
            height: 3px;
            background-color: var(--border);
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary);
            transition: width 0.3s ease;
        }

        /* Input Fields */
        .input-fields {
            padding: 1.5rem 2rem;
            padding-bottom: 2rem;
        }

        .input-field {
            margin-bottom: 1rem;
            opacity: 0.4;
            transition: opacity 0.3s;
        }

        .input-field.active {
            opacity: 1;
        }

        .input-field.completed {
            opacity: 0.6;
        }

        .field-number {
            display: none !important;
        }

        .field-container {
            background-color: var(--card);
            border-radius: 12px;
            padding: 1rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 56px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
        }

        .input-field.active .field-container {
            box-shadow: 0 2px 8px rgba(66, 133, 244, 0.2);
            border: 2px solid var(--primary) !important;
            outline: none;
        }
        
        .input-field.active .field-input {
            color: var(--primary) !important;
        }

        .field-label {
            font-size: clamp(0.75rem, 2.5vw, 0.9375rem);
            line-height: 1.25;
            color: var(--text-primary);
            font-weight: 500;
            word-break: keep-all;
            overflow-wrap: break-word;
            display: block;
        }

        .field-container .field-value,
        .field-container .field-input {
            font-size: 1rem;
            color: var(--text-primary);
            text-align: right;
            min-height: 24px;
            padding: 0.25rem 0;
        }

        .field-input {
            border: none;
            outline: none;
            background: transparent;
            width: 100%;
        }

        .field-input::placeholder {
            color: var(--text-disabled);
        }

        .field-input:focus {
            color: var(--primary);
        }

        .field-icon {
            margin-left: 0.75rem;
            color: var(--text-secondary);
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        /* rowë‹¹ 1ê°œ ë°ì´í„°: ëª…ì¹­ ì¢Œì¸¡, ê°’ ìš°ì¸¡ í•œ ì¤„ (ë‚ ì§œÂ·íŒë§¤ê°¯ìˆ˜Â·ìˆœì´ìµÂ·ROAS ë™ì¼ ìŠ¤íƒ€ì¼) */
        .field-container.field-row-single,
        .field-container.date-field-container.field-row-single {
            flex-direction: row !important;
            flex-wrap: nowrap;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 1rem;
            min-height: 56px;
        }
        .field-container.field-row-single .field-label,
        .date-field-container.field-row-single .field-label {
            text-align: left;
            flex: 1 1 auto;
            min-width: 0;
            margin-right: 0.5rem;
        }
        .field-container.field-row-single .field-value,
        .field-container.field-row-single .field-input,
        .date-field-container.field-row-single .field-input {
            flex: 0 0 auto !important;
            width: auto !important;
            max-width: 60%;
            text-align: right;
        }
        .date-field-container.field-row-single .field-input {
            min-width: 100px;
        }
        .date-field-container .field-icon {
            flex: 0 0 auto;
            margin-left: 0.25rem;
        }
        .date-field-container .field-input,
        #field-date {
            font-family: inherit;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
            text-align: right;
        }

        .field-value {
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 500;
            text-align: right;
        }

        .calculated-field {
            background-color: #F0F7FF;
        }

        .calculated-field .field-value {
            color: var(--primary);
            font-weight: 600;
        }

        /* Save Button */
        .save-button-container {
            display: flex;
            flex-direction: row;
            gap: 0.5rem;
            padding: 1rem 1rem;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
            background-color: var(--background);
            border-top: 1px solid var(--border);
        }
        /* ë²„íŠ¼ ê³ ì • ì‹œ ë³¸ë¬¸ í•˜ë‹¨ì´ ê°€ë¦¬ì§€ ì•Šë„ë¡ ì—¬ë°± */
        .input-fields {
            padding-bottom: 5.5rem;
        }

        .save-button {
            flex: 1;
            min-width: 0;
            padding: 1.25rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s, transform 0.1s;
            min-height: 56px;
            -webkit-tap-highlight-color: transparent;
        }

        .save-button:not(:disabled):hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .save-button:not(:disabled):active {
            transform: translateY(0);
        }

        .save-button:disabled {
            cursor: not-allowed;
        }

        /* Flatpickr Calendar Positioning */
        .flatpickr-calendar {
            z-index: 3000 !important;
        }

        .flatpickr-calendar.open {
            position: fixed !important;
            left: 50% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important;
            margin: 0 !important;
        }

        .flatpickr-calendar:not(.open) {
            display: none !important;
        }

        /* ëª¨ë°”ì¼ ìµœì í™” ìŠ¤íƒ€ì¼ */
        body {
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .input-header {
            padding: 1rem 1.25rem;
        }

        .input-title {
            font-size: 1.125rem;
        }

        .input-fields {
            padding: 1rem 1rem;
            padding-bottom: 5.5rem;
        }

        .field-container {
            padding: 1.25rem 1rem;
            min-height: 64px;
        }
        /* ë‚ ì§œÂ·íŒë§¤ê°¯ìˆ˜Â·ìˆœì´ìµÂ·ROAS í•œ ì¤„ ìœ ì§€ (ëª¨ë°”ì¼ì—ì„œë„) */
        .field-container.field-row-single,
        .field-container.date-field-container.field-row-single {
            flex-direction: row !important;
            flex-wrap: nowrap;
        }

        .field-label {
            font-size: 0.9375rem;
        }

        .field-input,
        .date-field-container .field-input,
        #field-date {
            font-size: 1rem;
            padding: 0.5rem 0;
        }

        .field-value {
            font-size: 1rem;
        }

        .save-button-container {
            padding: 1rem;
        }

        .save-button {
            padding: 1rem;
            font-size: 1rem;
            min-height: 48px;
        }

        /* ì˜µì…˜ íƒ­ (ì´ë¯¸ì§€ì™€ ë™ì¼: ê°€ë¡œ ë°°ì¹˜, ì„ íƒ ì‹œ íŒŒë€ìƒ‰) */
        #optionTabsSection {
            border-top: 2px solid var(--border);
            padding-top: 1rem;
            margin: 1rem 0;
        }
        #optionTabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: nowrap;
            min-width: 0;
        }
        .option-tab {
            padding: 0.75rem 0.5rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--background);
            color: var(--text-secondary);
            font-size: clamp(0.7rem, 2vw, 0.875rem);
            font-weight: 500;
            cursor: pointer;
            flex: 1 1 0;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            -webkit-tap-highlight-color: transparent;
        }
        .option-tab.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        /* ì˜µì…˜ í•„ë“œ ê·¸ë¦¬ë“œ: 2,3,4 í•œ ì¤„ / 5,6,7 í•œ ì¤„ / 8,9 í’€ë„ˆë¹„ */
        .option-fields-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .option-fields-grid .input-field {
            margin-bottom: 0;
        }
        .option-fields-grid .field-container {
            padding: 1rem 0.75rem;
            min-height: 64px;
        }
        /* ê·¸ë¦¬ë“œ ì•ˆ í•œ ì¤„ í•„ë“œ(íŒë§¤ ê°œìˆ˜Â·ìˆœì´ìµÂ·ROAS)ëŠ” ë‚ ì§œì™€ ë™ì¼ ìŠ¤íƒ€ì¼ */
        .option-fields-grid .field-container.field-row-single {
            padding: 1rem 1rem;
            min-height: 56px;
        }
        .option-field-full {
            grid-column: 1 / -1;
        }
        .option-divider {
            grid-column: 1 / -1;
            border-top: 2px solid var(--border);
            margin-top: 0.5rem;
            padding-top: 0.5rem;
        }

        /* í„°ì¹˜ ì¹œí™”ì ì¸ ë²„íŠ¼ í¬ê¸° */
        .back-button {
            min-width: 48px;
            min-height: 48px;
            font-size: 1.75rem;
        }

        /* ì…ë ¥ í•„ë“œ í„°ì¹˜ ì˜ì—­ í™•ëŒ€ */
        .field-container {
            -webkit-tap-highlight-color: rgba(66, 133, 244, 0.1);
        }

        /* ëª¨ë°”ì¼ì—ì„œ í‚¤ë³´ë“œê°€ ì˜¬ë¼ì˜¬ ë•Œ ìŠ¤í¬ë¡¤ ìµœì í™” */
        @supports (-webkit-overflow-scrolling: touch) {
            body {
                -webkit-overflow-scrolling: touch;
            }
        }
        /* URLì— product= ë˜ëŠ” id= ìˆì„ ë•Œ ë¡œë”© ì¤‘: ì „ì²´ ë¹ˆ í™”ë©´ */
        html.url-product-view .input-header,
        html.url-product-view .progress-bar,
        html.url-product-view #inputFields,
        html.url-product-view .save-button-container {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Input Screen -->
    <div class="input-screen">
        <div class="input-header">
            <a href="/margin-tracker" class="back-button" id="backButton">â†</a>
            <div class="input-title" id="pageTitle">íŒë§¤ ë°ì´í„° ì…ë ¥</div>
            <div class="progress-info" id="progressInfo">1/17</div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 5.88%"></div>
        </div>

        <div class="input-fields" id="inputFields">
            <!-- Field 1: ìƒí’ˆë²ˆí˜¸/ìƒí’ˆëª… (ì˜µì…˜ì´ ì—†ì„ ë•Œë§Œ í‘œì‹œ) -->
            <div class="input-field active" data-field="productNumber" id="productNumberField">
                <div class="field-container">
                    <span class="field-number">1</span>
                    <span class="field-label">ìƒí’ˆë²ˆí˜¸ / ìƒí’ˆëª…</span>
                    <input type="text" class="field-input" id="field-productNumber" placeholder="ìƒí’ˆë²ˆí˜¸ë‚˜ ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”" list="productList" autocomplete="off">
                    <datalist id="productList"></datalist>
                </div>
            </div>

            <!-- Field 2: ë‚ ì§œ (ìˆœì´ìµ/ROASì™€ ë™ì¼ í•œ ì¤„ ìŠ¤íƒ€ì¼) -->
            <div class="input-field" data-field="date">
                <div class="field-container date-field-container field-row-single">
                    <span class="field-number">2</span>
                    <span class="field-label">ë‚ ì§œ : ìë™/ìˆ˜ì •ê°€ëŠ¥</span>
                    <input type="text" class="field-input" id="field-date" placeholder="ë‚ ì§œ ì„ íƒ">
                    <span class="field-icon">ğŸ“…</span>
                </div>
            </div>

            <!-- ì˜µì…˜ íƒ­ ì˜ì—­ -->
            <div id="optionTabsSection" style="display: none; margin: 1rem 0; border-top: 2px solid var(--border); padding-top: 1rem;">
                <div id="optionTabs" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;"></div>
            </div>

            <!-- ì˜µì…˜ë³„ ì…ë ¥ í•„ë“œ ì˜ì—­ -->
            <div id="optionFieldsSection" style="display: none;"></div>

            <!-- ê¸°ì¡´ í•„ë“œë“¤ (ì˜µì…˜ì´ ì—†ì„ ë•Œ ì‚¬ìš©) -->
            <div id="legacyFields" style="display: none;">
                <!-- Field 3: íŒë§¤ê°€ -->
                <div class="input-field" data-field="sellingPrice">
                    <div class="field-container">
                        <span class="field-number">3</span>
                        <span class="field-label">íŒë§¤ê°€</span>
                        <input type="number" class="field-input" id="field-sellingPrice" placeholder="0">
                    </div>
                </div>

                <!-- Field 4: í• ì¸ì¿ í° -->
                <div class="input-field" data-field="discountCoupon">
                    <div class="field-container">
                        <span class="field-number">4</span>
                        <span class="field-label">í• ì¸ì¿ í°</span>
                        <input type="number" class="field-input" id="field-discountCoupon" placeholder="0">
                    </div>
                </div>

                <!-- Field 5: ìµœì¢… íŒë§¤ê°€ -->
                <div class="input-field calculated-field" data-field="finalSellingPrice">
                    <div class="field-container">
                        <span class="field-number">5</span>
                        <span class="field-label">ìµœì¢… íŒë§¤ê°€</span>
                        <div class="field-value" id="value-finalSellingPrice">-</div>
                        <input type="number" class="field-input" id="field-finalSellingPrice" placeholder="0" style="display: none;">
                    </div>
                </div>

                <!-- Field 6: ê°€ê²© ë³€ë™ -->
                <div class="input-field" data-field="priceFluctuation">
                    <div class="field-container">
                        <span class="field-number">6</span>
                        <span class="field-label">ê°€ê²© ë³€ë™</span>
                        <input type="number" class="field-input" id="field-priceFluctuation" placeholder="0">
                    </div>
                </div>

                <!-- Field 7: íŒë§¤ìˆ˜ëŸ‰ (í•œ ì¤„: ëª…ì¹­ ì¢Œì¸¡, ê°’ ìš°ì¸¡) -->
                <div class="input-field" data-field="salesQuantity">
                    <div class="field-container field-row-single">
                        <span class="field-number">7</span>
                        <span class="field-label">íŒë§¤ìˆ˜ëŸ‰</span>
                        <input type="number" class="field-input" id="field-salesQuantity" placeholder="0">
                    </div>
                </div>

                <!-- Field 8: ì‹¤ì œ íŒë§¤ ë§¤ì¶œ -->
                <div class="input-field calculated-field" data-field="actualSalesRevenue">
                    <div class="field-container">
                        <span class="field-number">8</span>
                        <span class="field-label">ì‹¤ì œ íŒë§¤ ë§¤ì¶œ</span>
                        <div class="field-value" id="value-actualSalesRevenue">-</div>
                        <input type="number" class="field-input" id="field-actualSalesRevenue" placeholder="0" style="display: none;">
                    </div>
                </div>

                <!-- Field 9: ê°œë‹¹ ë§ˆì§„ -->
                <div class="input-field" data-field="marginPerUnit">
                    <div class="field-container">
                        <span class="field-number">9</span>
                        <span class="field-label">ê°œë‹¹ ë§ˆì§„</span>
                        <input type="number" class="field-input" id="field-marginPerUnit" placeholder="0">
                    </div>
                </div>

                <!-- Field 10: ì´ ë§ˆì§„ -->
                <div class="input-field calculated-field" data-field="totalMargin">
                    <div class="field-container">
                        <span class="field-number">10</span>
                        <span class="field-label">ì´ ë§ˆì§„</span>
                        <div class="field-value" id="value-totalMargin">-</div>
                        <input type="number" class="field-input" id="field-totalMargin" placeholder="0" style="display: none;">
                    </div>
                </div>

                <!-- Field 11: ê´‘ê³ ë¹„ -->
                <div class="input-field" data-field="advertisingCost">
                    <div class="field-container">
                        <span class="field-number">11</span>
                        <span class="field-label">ê´‘ê³ ë¹„</span>
                        <input type="number" class="field-input" id="field-advertisingCost" placeholder="0">
                    </div>
                </div>

                <div class="option-divider" style="margin: 0.5rem 0;"></div>
                <!-- Field 12: ìˆœìˆ˜ìµ (í•œ ì¤„: ëª…ì¹­ ì¢Œì¸¡, ê°’ ìš°ì¸¡) -->
                <div class="input-field calculated-field" data-field="netProfit">
                    <div class="field-container field-row-single">
                        <span class="field-number">12</span>
                        <span class="field-label">ìˆœìˆ˜ìµ</span>
                        <div class="field-value" id="value-netProfit">-</div>
                        <input type="number" class="field-input" id="field-netProfit" placeholder="0" style="display: none;">
                    </div>
                </div>

                <!-- Field 13: ë§ˆì§„ìœ¨ -->
                <div class="input-field calculated-field" data-field="marginRate">
                    <div class="field-container">
                        <span class="field-number">13</span>
                        <span class="field-label">ë§ˆì§„ìœ¨ (%)</span>
                        <div class="field-value" id="value-marginRate">-</div>
                        <input type="number" class="field-input" id="field-marginRate" placeholder="0" style="display: none;">
                    </div>
                </div>

                <!-- Field 14: ê´‘ê³ íŒë§¤ -->
                <div class="input-field" data-field="adSales">
                    <div class="field-container">
                        <span class="field-number">14</span>
                        <span class="field-label">ê´‘ê³ íŒë§¤</span>
                        <input type="number" class="field-input" id="field-adSales" placeholder="0">
                    </div>
                </div>

                <!-- Field 15: ìì—°íŒë§¤ -->
                <div class="input-field" data-field="organicSales">
                    <div class="field-container">
                        <span class="field-number">15</span>
                        <span class="field-label">ìì—°íŒë§¤</span>
                        <input type="number" class="field-input" id="field-organicSales" placeholder="0">
                    </div>
                </div>

                <!-- Field 16: ìì—°íŒë§¤ë¹„ìœ¨ -->
                <div class="input-field calculated-field" data-field="organicSalesRatio">
                    <div class="field-container">
                        <span class="field-number">16</span>
                        <span class="field-label">ìì—°íŒë§¤ë¹„ìœ¨ (%)</span>
                        <div class="field-value" id="value-organicSalesRatio">-</div>
                        <input type="number" class="field-input" id="field-organicSalesRatio" placeholder="0" style="display: none;">
                    </div>
                </div>

                <!-- Field 17: ROAS (í•œ ì¤„: ëª…ì¹­ ì¢Œì¸¡, ê°’ ìš°ì¸¡) -->
                <div class="input-field calculated-field" data-field="roas">
                    <div class="field-container field-row-single">
                        <span class="field-number">17</span>
                        <span class="field-label">ROAS</span>
                        <div class="field-value" id="value-roas">-</div>
                        <input type="number" class="field-input" id="field-roas" placeholder="0" style="display: none;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <div class="save-button-container">
            <button id="saveButton" class="save-button" disabled>ë“±ë¡</button>
            <button id="nextProductButton" class="save-button save-button-next" style="background: var(--border); color: var(--text-primary); display: none;">ë‹¤ìŒìƒí’ˆ</button>
            <button id="backToTrackerButton" class="save-button save-button-back" style="background: var(--background); color: var(--text-primary); border: 1px solid var(--border);">ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <script>
        // State
        let currentStep = 0;
        let formData = {
            productNumber: '',
            date: '',
            sellingPrice: '',
            discountCoupon: '',
            finalSellingPrice: '',
            priceFluctuation: '',
            salesQuantity: '',
            actualSalesRevenue: '',
            marginPerUnit: '',
            totalMargin: '',
            advertisingCost: '',
            netProfit: '',
            marginRate: '',
            adSales: '',
            organicSales: '',
            organicSalesRatio: '',
            roas: ''
        };

        const fields = [
            'productNumber', 'date', 'sellingPrice', 'discountCoupon', 'finalSellingPrice',
            'priceFluctuation', 'salesQuantity', 'actualSalesRevenue', 'marginPerUnit',
            'totalMargin', 'advertisingCost', 'netProfit', 'marginRate',
            'adSales', 'organicSales', 'organicSalesRatio', 'roas'
        ];

        const calculatedFields = [
            'finalSellingPrice', 'actualSalesRevenue', 'totalMargin', 
            'netProfit', 'marginRate', 'organicSalesRatio', 'roas'
        ];

        let editId = null;
        let currentProductOptions = [];
        let currentProductInfo = null;
        let currentOptionIndex = 0;
        let optionDataSets = [];
        let allRegisteredProducts = [];
        let currentProductIndex = -1;
        let updateNextProductButtonFn = null;
        /** ë™ì¼ ìƒí’ˆ ì…ë ¥ ì‹œ íŒë§¤ê°€ ë³€ë™ ìë™ ì„¤ì •ìš© - í•´ë‹¹ ìƒí’ˆì˜ ìµœê·¼ ì…ë ¥ê°’ */
        let lastPriceFluctuationForProduct = null;

        document.addEventListener('DOMContentLoaded', async function() {
            const uid = localStorage.getItem('salesChart_userId');
            if (!uid) {
                window.location.href = '/margin-tracker';
                return;
            }
            const params = new URLSearchParams(window.location.search);
            editId = params.get('id');
            const productParam = params.get('product');
            const dateParam = params.get('date');
            initEventListeners();
            if (editId) {
                await loadProductList();
                loadRecordForEdit(editId);
            } else if (productParam) {
                await loadProductList();
                initDatePicker();
                await handleProductSelect(productParam, dateParam);
            } else {
                loadProductList();
                initDatePicker();
                updateSaveButtonText();
                setCurrentStep(0);
            }
        });

        async function loadProductList() {
            const uid = localStorage.getItem('salesChart_userId');
            if (!uid) return;
            try {
                const res = await fetch('/api/margin-tracker/registered-products?userId=' + encodeURIComponent(uid));
                const data = await res.json();
                allRegisteredProducts = (data.success && data.products) ? data.products : [];
                const list = document.getElementById('productList');
                list.innerHTML = '';
                if (allRegisteredProducts.length > 0) {
                    allRegisteredProducts.forEach(function(p) {
                        const num = p.productNumber || '';
                        const name = p.productName || '';
                        const label = name ? (num + ' / ' + name) : num;
                        if (label) {
                            const opt = document.createElement('option');
                            opt.value = label;
                            list.appendChild(opt);
                        }
                    });
                }
                const res2 = await fetch('/api/margin-tracker/products?userId=' + encodeURIComponent(uid));
                const data2 = await res2.json();
                if (data2.success && data2.products && data2.products.length) {
                    data2.products.forEach(function(p) {
                        const num = p.productNumber || '';
                        const name = p.productName || '';
                        const label = name ? (num + ' / ' + name) : num;
                        if (label && !Array.from(list.options).some(o => o.value === label)) {
                            const opt = document.createElement('option');
                            opt.value = label;
                            list.appendChild(opt);
                        }
                    });
                }
            } catch (e) {}
        }

        async function handleProductSelect(productNumber, dateParam) {
            const uid = localStorage.getItem('salesChart_userId');
            if (!uid) return;
            try {
                // ë™ì¼ ìƒí’ˆ ìµœê·¼ íŒë§¤ê°€ ë³€ë™ê°’ ì¡°íšŒ (ìë™ ì„¤ì •ìš©, ìˆ˜ì • ê°€ëŠ¥ ìœ ì§€)
                lastPriceFluctuationForProduct = null;
                try {
                    const latestRes = await fetch('/api/margin-tracker/latest-record?userId=' + encodeURIComponent(uid) + '&productNumber=' + encodeURIComponent(productNumber));
                    const latestData = await latestRes.json();
                    if (latestData.success && latestData.priceFluctuation != null && latestData.priceFluctuation !== '') {
                        lastPriceFluctuationForProduct = latestData.priceFluctuation;
                    }
                } catch (e) { /* ë¬´ì‹œ */ }

                const res = await fetch('/api/margin-tracker/product-options?userId=' + encodeURIComponent(uid) + '&productNumber=' + encodeURIComponent(productNumber));
                const data = await res.json();
                if (data.success && data.options && data.options.length > 0) {
                    currentProductOptions = data.options;
                    // ì˜µì…˜ ë°ì´í„° í™•ì¸ ë° ë””ë²„ê¹…
                    console.log('ì˜µì…˜ ë°ì´í„° ë¡œë“œ:', data.options);
                    data.options.forEach(function(opt, idx) {
                        console.log('ì˜µì…˜ ' + idx + ':', {
                            optionAlias: opt.optionAlias,
                            marginPerUnit: opt.marginPerUnit,
                            marginPerUnitType: typeof opt.marginPerUnit
                        });
                    });
                    currentProductInfo = allRegisteredProducts.find(p => p.productNumber === productNumber) || { productNumber: productNumber, productName: '' };
                    var pageTitleEl = document.getElementById('pageTitle');
                    if (pageTitleEl) pageTitleEl.textContent = 'íŒë§¤ ë°ì´í„° ì…ë ¥ - ' + (currentProductInfo.productName || currentProductInfo.productNumber || '');
                    document.documentElement.classList.remove('url-product-view');
                    document.getElementById('productNumberField').style.display = 'none';
                    document.getElementById('optionTabsSection').style.display = 'block';
                    document.getElementById('optionFieldsSection').style.display = 'block';
                    document.getElementById('legacyFields').style.display = 'none';
                    var dateNum = document.querySelector('[data-field="date"] .field-number');
                    if (dateNum) dateNum.textContent = '1';
                    currentProductIndex = allRegisteredProducts.findIndex(p => p.productNumber === productNumber);
                    if (updateNextProductButtonFn) {
                        updateNextProductButtonFn();
                    }
                    renderOptionTabs();
                    renderOptionFields(0);
                    if (dateParam) {
                        const dateInput = document.getElementById('field-date');
                        if (dateInput && dateInput._flatpickr) {
                            const d = new Date(dateParam);
                            dateInput._flatpickr.setDate(d, false);
                            formData.date = dateInput.value;
                        }
                    }
                } else {
                    // ë ˆê±°ì‹œ ëª¨ë“œ: ì˜µì…˜ì´ ì—†ëŠ” ê²½ìš°
                    var pageTitleEl = document.getElementById('pageTitle');
                    if (pageTitleEl) pageTitleEl.textContent = 'íŒë§¤ ë°ì´í„° ì…ë ¥';
                    document.documentElement.classList.remove('url-product-view');
                    document.getElementById('productNumberField').style.display = 'block';
                    document.getElementById('optionTabsSection').style.display = 'none';
                    document.getElementById('optionFieldsSection').style.display = 'none';
                    var dateNum = document.querySelector('[data-field="date"] .field-number');
                    if (dateNum) dateNum.textContent = '2';
                    document.getElementById('legacyFields').style.display = 'block';
                    const productInput = document.getElementById('field-productNumber');
                    if (productInput) {
                        const p = allRegisteredProducts.find(p => p.productNumber === productNumber);
                        if (p) {
                            productInput.value = (p.productNumber || '') + ' / ' + (p.productName || '');
                            formData.productNumber = productInput.value;
                            // ì´ì „ íŒë§¤ê°€ ë³€ë™ê°’ ìë™ ì„¤ì • (ìˆ˜ì • ê°€ëŠ¥)
                            if (lastPriceFluctuationForProduct != null && lastPriceFluctuationForProduct !== '') {
                                const v = String(lastPriceFluctuationForProduct);
                                formData.priceFluctuation = v;
                                const pfInput = document.getElementById('field-priceFluctuation');
                                if (pfInput) pfInput.value = v;
                                calculateDerivedFields();
                            }
                            // ìƒí’ˆ ë“±ë¡ ì‹œ ì €ì¥ëœ ì˜µì…˜ ì •ë³´ê°€ ìˆìœ¼ë©´ ì²« ë²ˆì§¸ ì˜µì…˜ì˜ ê°œë‹¹ ë§ˆì§„ì„ ìë™ ì„¤ì •
                            if (data.options && data.options.length > 0) {
                                const firstOption = data.options[0];
                                if (firstOption.marginPerUnit) {
                                    formData.marginPerUnit = firstOption.marginPerUnit;
                                    const marginInput = document.getElementById('field-marginPerUnit');
                                    if (marginInput) {
                                        marginInput.value = firstOption.marginPerUnit;
                                    }
                                    calculateDerivedFields();
                                }
                            } else {
                                // ì˜µì…˜ì´ ì—†ì–´ë„ ìƒí’ˆì´ ë“±ë¡ë˜ì–´ ìˆìœ¼ë©´, ì˜µì…˜ ì •ë³´ë¥¼ ë‹¤ì‹œ í™•ì¸
                                // (ì˜µì…˜ì´ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•´ì•¼ í•¨)
                                console.log('ë“±ë¡ëœ ìƒí’ˆì´ì§€ë§Œ ì˜µì…˜ì´ ì—†ìŠµë‹ˆë‹¤. ê°œë‹¹ ë§ˆì§„ì„ ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                            }
                        }
                    }
                }
            } catch (e) {
                console.error('ì˜µì…˜ ë¡œë“œ ì‹¤íŒ¨', e);
            }
        }

        let optionTabsCurrentPage = 0;
        const optionTabsPerPage = 3;

        function renderOptionTabs() {
            const container = document.getElementById('optionTabs');
            container.innerHTML = '';
            const startIdx = optionTabsCurrentPage * optionTabsPerPage;
            const endIdx = Math.min(startIdx + optionTabsPerPage, currentProductOptions.length);
            const visibleOptions = currentProductOptions.slice(startIdx, endIdx);
            visibleOptions.forEach(function(opt, localIdx) {
                const idx = startIdx + localIdx;
                const tab = document.createElement('button');
                tab.type = 'button';
                tab.className = 'option-tab' + (idx === currentOptionIndex ? ' active' : '');
                tab.textContent = opt.optionAlias || opt.optionId || ('ì˜µì…˜' + String.fromCharCode(65 + idx));
                tab.addEventListener('click', function() {
                    currentOptionIndex = idx;
                    optionTabsCurrentPage = Math.floor(idx / optionTabsPerPage);
                    renderOptionTabs();
                    renderOptionFields(idx);
                    // í¬ì»¤ìŠ¤ ì„¤ì •ì„ renderOptionFields ì™„ë£Œ í›„ ì‹¤í–‰
                    setTimeout(function() {
                        const fieldsSection = document.getElementById('optionFieldsSection');
                        if (fieldsSection) {
                            fieldsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            setTimeout(function() {
                                const priceFluctuationField = document.getElementById('optionPriceFluctuationField');
                                const priceFluctuationInput = fieldsSection.querySelector('.opt-price-fluctuation');
                                if (priceFluctuationInput && priceFluctuationField) {
                                    // input-fieldì— active í´ë˜ìŠ¤ ìœ ì§€
                                    priceFluctuationField.classList.add('active');
                                    // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
                                    priceFluctuationInput.focus();
                                    priceFluctuationInput.select();
                                    // í¬ì»¤ìŠ¤ ì´ë²¤íŠ¸ ê°•ì œ ë°œìƒ
                                    priceFluctuationInput.dispatchEvent(new Event('focus', { bubbles: true }));
                                }
                            }, 500);
                        }
                    }, 150);
                });
                container.appendChild(tab);
            });
            if (currentProductOptions.length > optionTabsPerPage) {
                const navContainer = document.createElement('div');
                navContainer.style.cssText = 'display: flex; gap: 0.5rem; margin-top: 0.5rem; justify-content: center;';
                if (optionTabsCurrentPage > 0) {
                    const prevBtn = document.createElement('button');
                    prevBtn.textContent = 'â† ì´ì „';
                    prevBtn.style.cssText = 'padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--background); cursor: pointer; font-size: 0.875rem;';
                    prevBtn.addEventListener('click', function() {
                        optionTabsCurrentPage--;
                        renderOptionTabs();
                    });
                    navContainer.appendChild(prevBtn);
                }
                if (endIdx < currentProductOptions.length) {
                    const nextBtn = document.createElement('button');
                    nextBtn.textContent = 'ë‹¤ìŒ â†’';
                    nextBtn.style.cssText = 'padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--background); cursor: pointer; font-size: 0.875rem;';
                    nextBtn.addEventListener('click', function() {
                        optionTabsCurrentPage++;
                        renderOptionTabs();
                    });
                    navContainer.appendChild(nextBtn);
                }
                container.appendChild(navContainer);
            }
        }

        function renderOptionFields(optionIdx) {
            const container = document.getElementById('optionFieldsSection');
            container.innerHTML = '';
            const opt = currentProductOptions[optionIdx];
            if (!opt) return;
            if (!optionDataSets[optionIdx]) {
                var initPriceFluctuation = (lastPriceFluctuationForProduct != null && lastPriceFluctuationForProduct !== '') ? String(lastPriceFluctuationForProduct) : '';
                optionDataSets[optionIdx] = {
                    sellingPrice: opt.sellingPrice || 0,
                    priceFluctuation: initPriceFluctuation,
                    finalSellingPrice: opt.sellingPrice || 0,
                    salesQuantity: '',
                    advertisingCost: '',
                    adSales: '',
                    organicSales: 0,
                    netProfit: 0,
                    marginRate: 0,
                    roas: 0
                };
            }
            const data = optionDataSets[optionIdx];
            const sellingPrice = parseFloat(data.sellingPrice) || 0;
            const priceFluctuation = parseFloat(data.priceFluctuation) || 0;
            const finalPrice = sellingPrice + priceFluctuation;
            const salesQty = parseFloat(data.salesQuantity) || 0;
            const adCost = parseFloat(data.advertisingCost) || 0;
            const adSalesQty = parseFloat(data.adSales) || 0;
            const organicSalesQty = Math.max(0, salesQty - adSalesQty);
            const actualRevenue = finalPrice * salesQty;
            // ìˆœì´ìµ ê³„ì‚°: (ê°œë‹¹ ë§ˆì§„ * íŒë§¤ ìˆ˜ëŸ‰) + (íŒë§¤ê°€ ë³€ë™ * íŒë§¤ ìˆ˜ëŸ‰) - ê´‘ê³ ë¹„
            // = (ê°œë‹¹ ë§ˆì§„ + íŒë§¤ê°€ ë³€ë™) * íŒë§¤ ìˆ˜ëŸ‰ - ê´‘ê³ ë¹„
            // ìƒí’ˆ ë“±ë¡ ì‹œ ì €ì¥ëœ ê°œë‹¹ ë§ˆì§„ ì‚¬ìš© (ë°˜ë“œì‹œ DBì—ì„œ ê°€ì ¸ì˜¨ ê°’ ì‚¬ìš©)
            let baseMarginPerUnit = 0;
            if (opt.marginPerUnit != null && opt.marginPerUnit !== undefined && opt.marginPerUnit !== '') {
                baseMarginPerUnit = parseFloat(String(opt.marginPerUnit).replace(/,/g, '')) || 0;
            }
            console.log('renderOptionFields - ì˜µì…˜ ê°œë‹¹ ë§ˆì§„:', {
                optionAlias: opt.optionAlias,
                marginPerUnit: opt.marginPerUnit,
                parsedMarginPerUnit: baseMarginPerUnit,
                salesQty: salesQty,
                priceFluctuation: priceFluctuation,
                adCost: adCost
            });
            const marginFromBase = baseMarginPerUnit * salesQty;  // ê°œë‹¹ ë§ˆì§„ * íŒë§¤ ìˆ˜ëŸ‰
            const marginFromFluctuation = priceFluctuation * salesQty;  // íŒë§¤ê°€ ë³€ë™ * íŒë§¤ ìˆ˜ëŸ‰
            const netProfit = marginFromBase + marginFromFluctuation - adCost;
            console.log('renderOptionFields - ìˆœì´ìµ ê³„ì‚°:', {
                marginFromBase: marginFromBase,
                marginFromFluctuation: marginFromFluctuation,
                adCost: adCost,
                netProfit: netProfit
            });
            const roas = adCost > 0 ? actualRevenue / adCost : 0;
            // ë§ˆì§„ìœ¨ ê³„ì‚°: ì¡°ì •ëœ ê°œë‹¹ ë§ˆì§„ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
            const adjustedMarginPerUnit = baseMarginPerUnit + priceFluctuation;
            let marginRate = 0;
            if (adjustedMarginPerUnit > 0 && finalPrice > 0) {
                marginRate = (adjustedMarginPerUnit / finalPrice) * 100;
            } else if (actualRevenue > 0) {
                marginRate = (netProfit / actualRevenue) * 100;
            }
            container.innerHTML = '<div class="option-fields-grid">' +
                /* 1í–‰: íŒë§¤ê°€, íŒë§¤ê°€ ë³€ë™, ìµœì¢… íŒë§¤ê°€ */
                '<div class="input-field"><div class="field-container"><span class="field-label">íŒë§¤ê°€</span><div class="field-value" style="color: var(--text-secondary);">' + Math.round(sellingPrice).toLocaleString('ko-KR') + '</div></div></div>' +
                '<div class="input-field" id="optionPriceFluctuationField"><div class="field-container"><span class="field-label">íŒë§¤ê°€ ë³€ë™</span><input type="number" class="field-input opt-price-fluctuation" placeholder="ì˜ˆ: +500" value="' + (priceFluctuation !== 0 ? priceFluctuation : '') + '"></div></div>' +
                '<div class="input-field calculated-field"><div class="field-container"><span class="field-label">ìµœì¢… íŒë§¤ê°€</span><div class="field-value opt-final-price">' + Math.round(finalPrice).toLocaleString('ko-KR') + 'ì›</div></div></div>' +
                /* í’€ë„ˆë¹„: íŒë§¤ ê°œìˆ˜ (ì´) - í•œ ì¤„: ëª…ì¹­ ì¢Œì¸¡, ê°’ ìš°ì¸¡ */
                '<div class="input-field option-field-full" id="optionSalesQtyField"><div class="field-container field-row-single"><span class="field-label">íŒë§¤ ê°œìˆ˜ (ì´)</span><input type="number" class="field-input opt-sales-qty" placeholder="0" value="' + (salesQty > 0 ? salesQty : '') + '" required></div></div>' +
                /* 2í–‰: ê´‘ê³ ë¹„, ê´‘ê³ íŒë§¤ê°œìˆ˜, ìì—°íŒë§¤ê°œìˆ˜ */
                '<div class="input-field" id="optionAdCostField"><div class="field-container"><span class="field-label">ê´‘ê³ ë¹„</span><input type="number" class="field-input opt-ad-cost" placeholder="0" value="' + (adCost > 0 ? adCost : '') + '" required></div></div>' +
                '<div class="input-field" id="optionAdSalesField"><div class="field-container"><span class="field-label">ê´‘ê³ íŒë§¤ê°œìˆ˜</span><input type="number" class="field-input opt-ad-sales" placeholder="0" value="' + (adSalesQty > 0 ? adSalesQty : '') + '" required></div></div>' +
                '<div class="input-field calculated-field"><div class="field-container"><span class="field-label">ìì—°íŒë§¤ê°œìˆ˜</span><div class="field-value opt-organic-sales">' + Math.max(0, Math.round(organicSalesQty)) + '</div></div></div>' +
                /* êµ¬ë¶„ì„  + ìˆœì´ìµ, ROAS - í•œ ì¤„: ëª…ì¹­ ì¢Œì¸¡, ê°’ ìš°ì¸¡ */
                '<div class="option-field-full option-divider"></div>' +
                '<div class="input-field calculated-field option-field-full"><div class="field-container field-row-single"><span class="field-label">ìˆœì´ìµ</span><div class="field-value opt-net-profit">' + Math.round(netProfit).toLocaleString('ko-KR') + 'ì›</div></div></div>' +
                '<div class="input-field calculated-field option-field-full"><div class="field-container field-row-single"><span class="field-label">ROAS</span><div class="field-value opt-roas">' + (roas > 0 ? roas.toFixed(2) : '-') + '</div></div></div>' +
                '</div>';
            const priceFluctuationInput = container.querySelector('.opt-price-fluctuation');
            const salesQtyInput = container.querySelector('.opt-sales-qty');
            const adCostInput = container.querySelector('.opt-ad-cost');
            const adSalesInput = container.querySelector('.opt-ad-sales');
            
            const priceFluctuationField = document.getElementById('optionPriceFluctuationField');
            const salesQtyField = document.getElementById('optionSalesQtyField');
            const adCostField = document.getElementById('optionAdCostField');
            const adSalesField = document.getElementById('optionAdSalesField');
            
            // í¬ì»¤ì‹± íš¨ê³¼ë¥¼ ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            function addFocusBlurListeners(inputElement, fieldElement) {
                if (!inputElement || !fieldElement) return;
                inputElement.addEventListener('focus', function() {
                    fieldElement.classList.add('active');
                });
                inputElement.addEventListener('blur', function() {
                    fieldElement.classList.remove('active');
                });
            }
            
            // ëª¨ë°”ì¼: ì²« ë²ˆì§¸ í•„ë“œ(íŒë§¤ê°€ ë³€ë™) ìë™ í™œì„±í™” ë° í¬ì»¤ìŠ¤
            if (priceFluctuationInput && priceFluctuationField) {
                priceFluctuationField.classList.add('active');
                setTimeout(function() {
                    priceFluctuationInput.focus();
                }, 300);
                
                priceFluctuationInput.addEventListener('input', function() {
                    updateOptionCalculations(optionIdx);
                });
                addFocusBlurListeners(priceFluctuationInput, priceFluctuationField);
                
                // ì—”í„°í‚¤/íƒ­í‚¤ë¡œ ë‹¤ìŒ í•„ë“œ(íŒë§¤ ê°œìˆ˜)ë¡œ ì´ë™
                priceFluctuationInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || (e.key === 'Tab' && !e.shiftKey)) {
                        e.preventDefault();
                        priceFluctuationField.classList.remove('active');
                        if (salesQtyInput && salesQtyField) {
                            salesQtyField.classList.add('active');
                            setTimeout(function() {
                                salesQtyInput.focus();
                                salesQtyInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 100);
                        }
                    }
                });
            }
            
            if (salesQtyInput && salesQtyField) {
                salesQtyInput.addEventListener('input', function() {
                    updateOptionCalculations(optionIdx);
                });
                addFocusBlurListeners(salesQtyInput, salesQtyField);
                
                // ì—”í„°í‚¤/íƒ­í‚¤ë¡œ ë‹¤ìŒ í•„ë“œ(ê´‘ê³ ë¹„)ë¡œ ì´ë™
                salesQtyInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || (e.key === 'Tab' && !e.shiftKey)) {
                        e.preventDefault();
                        salesQtyField.classList.remove('active');
                        if (adCostInput && adCostField) {
                            adCostField.classList.add('active');
                            setTimeout(function() {
                                adCostInput.focus();
                                adCostInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 100);
                        }
                    }
                });
            }
            
            if (adCostInput && adCostField) {
                adCostInput.addEventListener('input', function() {
                    updateOptionCalculations(optionIdx);
                });
                addFocusBlurListeners(adCostInput, adCostField);
                
                // ì—”í„°í‚¤/íƒ­í‚¤ë¡œ ë‹¤ìŒ í•„ë“œ(ê´‘ê³  íŒë§¤ ê°œìˆ˜)ë¡œ ì´ë™
                adCostInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || (e.key === 'Tab' && !e.shiftKey)) {
                        e.preventDefault();
                        adCostField.classList.remove('active');
                        if (adSalesInput && adSalesField) {
                            adSalesField.classList.add('active');
                            setTimeout(function() {
                                adSalesInput.focus();
                                adSalesInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 100);
                        }
                    }
                });
            }
            
            if (adSalesInput && adSalesField) {
                adSalesInput.addEventListener('input', function() {
                    updateOptionCalculations(optionIdx);
                });
                addFocusBlurListeners(adSalesInput, adSalesField);
                
                // ì—”í„°í‚¤/íƒ­í‚¤ë¡œ ë²„íŠ¼(ë“±ë¡í•˜ê¸°/ë‹¤ìŒìƒí’ˆ)ìœ¼ë¡œ í¬ì»¤ìŠ¤ ì´ë™
                adSalesInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || (e.key === 'Tab' && !e.shiftKey)) {
                        e.preventDefault();
                        adSalesField.classList.remove('active');
                        // ë“±ë¡í•˜ê¸° ë²„íŠ¼ìœ¼ë¡œ í¬ì»¤ìŠ¤ ì´ë™
                        const saveButton = document.getElementById('saveButton');
                        if (saveButton && !saveButton.disabled) {
                            setTimeout(function() {
                                saveButton.focus();
                                saveButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 100);
                        } else {
                            // ë“±ë¡í•˜ê¸° ë²„íŠ¼ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë‹¤ìŒìƒí’ˆ ë²„íŠ¼ í™•ì¸
                            const nextProductBtn = document.getElementById('nextProductButton');
                            if (nextProductBtn && nextProductBtn.style.display !== 'none') {
                                setTimeout(function() {
                                    nextProductBtn.focus();
                                    nextProductBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }, 100);
                            } else {
                                // ë§¤ì¶œì¼ì§€ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ìœ¼ë¡œ í¬ì»¤ìŠ¤ ì´ë™
                                const backToTrackerBtn = document.getElementById('backToTrackerButton');
                                if (backToTrackerBtn) {
                                    setTimeout(function() {
                                        backToTrackerBtn.focus();
                                        backToTrackerBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    }, 100);
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateOptionCalculations(optionIdx) {
            const container = document.getElementById('optionFieldsSection');
            const opt = currentProductOptions[optionIdx];
            if (!opt || !optionDataSets[optionIdx]) return;
            const sellingPrice = parseFloat(opt.sellingPrice) || 0;
            const priceFluctuation = parseFloat(container.querySelector('.opt-price-fluctuation').value) || 0;
            const finalPrice = sellingPrice + priceFluctuation;
            const salesQty = parseFloat(container.querySelector('.opt-sales-qty').value) || 0;
            const adCost = parseFloat(container.querySelector('.opt-ad-cost').value) || 0;
            const adSalesQty = parseFloat(container.querySelector('.opt-ad-sales').value) || 0;
            const organicSalesQty = Math.max(0, salesQty - adSalesQty);
            const actualRevenue = finalPrice * salesQty;
            // ìˆœì´ìµ ê³„ì‚°: (ê°œë‹¹ ë§ˆì§„ * íŒë§¤ ìˆ˜ëŸ‰) + (íŒë§¤ê°€ ë³€ë™ * íŒë§¤ ìˆ˜ëŸ‰) - ê´‘ê³ ë¹„
            // = (ê°œë‹¹ ë§ˆì§„ + íŒë§¤ê°€ ë³€ë™) * íŒë§¤ ìˆ˜ëŸ‰ - ê´‘ê³ ë¹„
            // ìƒí’ˆ ë“±ë¡ ì‹œ ì €ì¥ëœ ê°œë‹¹ ë§ˆì§„ ì‚¬ìš© (ë°˜ë“œì‹œ DBì—ì„œ ê°€ì ¸ì˜¨ ê°’ ì‚¬ìš©)
            let baseMarginPerUnit = 0;
            if (opt.marginPerUnit != null && opt.marginPerUnit !== undefined && opt.marginPerUnit !== '') {
                baseMarginPerUnit = parseFloat(String(opt.marginPerUnit).replace(/,/g, '')) || 0;
            }
            console.log('updateOptionCalculations - ì˜µì…˜ ê°œë‹¹ ë§ˆì§„:', {
                optionIdx: optionIdx,
                optionAlias: opt.optionAlias,
                marginPerUnit: opt.marginPerUnit,
                parsedMarginPerUnit: baseMarginPerUnit,
                salesQty: salesQty,
                priceFluctuation: priceFluctuation,
                adCost: adCost
            });
            const marginFromBase = baseMarginPerUnit * salesQty;  // ê°œë‹¹ ë§ˆì§„ * íŒë§¤ ìˆ˜ëŸ‰
            const marginFromFluctuation = priceFluctuation * salesQty;  // íŒë§¤ê°€ ë³€ë™ * íŒë§¤ ìˆ˜ëŸ‰
            const netProfit = marginFromBase + marginFromFluctuation - adCost;
            console.log('updateOptionCalculations - ìˆœì´ìµ ê³„ì‚°:', {
                marginFromBase: marginFromBase,
                marginFromFluctuation: marginFromFluctuation,
                adCost: adCost,
                netProfit: netProfit
            });
            const roas = adCost > 0 ? actualRevenue / adCost : 0;
            // ë§ˆì§„ìœ¨ ê³„ì‚°: ì¡°ì •ëœ ê°œë‹¹ ë§ˆì§„ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
            const adjustedMarginPerUnit = baseMarginPerUnit + priceFluctuation;
            let marginRate = 0;
            if (adjustedMarginPerUnit > 0 && finalPrice > 0) {
                marginRate = (adjustedMarginPerUnit / finalPrice) * 100;
            } else if (actualRevenue > 0) {
                marginRate = (netProfit / actualRevenue) * 100;
            }
            // ê¸°ì¡´ dataSeq ìœ ì§€ (ìˆ˜ì • ëª¨ë“œì¼ ë•Œ)
            const existingDataSeq = optionDataSets[optionIdx] ? optionDataSets[optionIdx].dataSeq : null;
            optionDataSets[optionIdx] = {
                sellingPrice: sellingPrice,
                priceFluctuation: priceFluctuation,
                finalSellingPrice: finalPrice,
                salesQuantity: salesQty,
                actualSalesRevenue: actualRevenue,
                advertisingCost: adCost,
                adSales: adSalesQty,
                organicSales: organicSalesQty,
                netProfit: netProfit,
                marginRate: marginRate,
                roas: roas,
                dataSeq: existingDataSeq || null
            };
            const finalPriceEl = container.querySelector('.opt-final-price');
            const organicSalesEl = container.querySelector('.opt-organic-sales');
            const netProfitEl = container.querySelector('.opt-net-profit');
            const roasEl = container.querySelector('.opt-roas');
            if (finalPriceEl) finalPriceEl.textContent = Math.round(finalPrice).toLocaleString('ko-KR') + 'ì›';
            if (organicSalesEl) organicSalesEl.textContent = Math.max(0, Math.round(organicSalesQty));
            if (netProfitEl) netProfitEl.textContent = Math.round(netProfit).toLocaleString('ko-KR') + 'ì›';
            if (roasEl) roasEl.textContent = roas > 0 ? roas.toFixed(2) : '-';
            checkCanSave();
            updateSaveButtonText();
        }

        function checkCanSave() {
            let canSave = false;
            if (currentProductOptions.length > 0 && optionDataSets.length > 0) {
                // ì˜µì…˜ ê¸°ë°˜ ì…ë ¥ ëª¨ë“œ: ìµœì†Œ í•˜ë‚˜ì˜ ì˜µì…˜ì— í•„ìˆ˜ ê°’ì´ ì…ë ¥ë˜ì–´ì•¼ í•¨
                canSave = optionDataSets.some(function(d, idx) {
                    if (!d) return false;
                    const salesQty = parseFloat(d.salesQuantity) || 0;
                    const adCost = parseFloat(d.advertisingCost) || 0;
                    const adSales = parseFloat(d.adSales) || 0;
                    return salesQty > 0 && adCost >= 0 && adSales >= 0;
                });
            } else {
                // ë ˆê±°ì‹œ ëª¨ë“œ: ê¸°ì¡´ ë¡œì§
                canSave = formData.salesQuantity && formData.advertisingCost && formData.adSales;
            }
            const saveBtn = document.getElementById('saveButton');
            if (saveBtn) {
                saveBtn.disabled = !canSave;
                saveBtn.style.opacity = canSave ? '1' : '0.5';
                saveBtn.style.cursor = canSave ? 'pointer' : 'not-allowed';
            }
        }
        
        function updateSaveButtonText() {
            const saveBtn = document.getElementById('saveButton');
            if (!saveBtn) return;
            // ìˆ˜ì • ëª¨ë“œ ê°ì§€: editIdê°€ ìˆê±°ë‚˜ optionDataSetsì— dataSeqê°€ ìˆëŠ” ê²½ìš°
            const isEditMode = editId !== null || (optionDataSets.length > 0 && optionDataSets.some(d => d && d.dataSeq));
            if (isEditMode) {
                saveBtn.textContent = 'ìˆ˜ì •';
            } else {
                saveBtn.textContent = 'ë“±ë¡';
            }
        }

        async function loadRecordForEdit(id) {
            const uid = localStorage.getItem('salesChart_userId');
            if (!uid) return;
            try {
                const res = await fetch('/api/margin-tracker/record/' + id + '?userId=' + encodeURIComponent(uid));
                const data = await res.json();
                if (!data.success || !data.record) {
                    console.warn('ìˆ˜ì • ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', data);
                    return;
                }
                const r = data.record;
                const productNumber = r.productNumber;
                const saleDate = r.date;
                
                // ìƒí’ˆë²ˆí˜¸ê°€ ìˆê³  ì˜µì…˜ ê¸°ë°˜ ì…ë ¥ì´ ê°€ëŠ¥í•œ ê²½ìš°
                if (productNumber) {
                    // í•´ë‹¹ ìƒí’ˆì˜ ì˜µì…˜ ëª©ë¡ ì¡°íšŒ
                    const optRes = await fetch('/api/margin-tracker/product-options?userId=' + encodeURIComponent(uid) + '&productNumber=' + encodeURIComponent(productNumber));
                    const optData = await optRes.json();
                    
                    if (optData.success && optData.options && optData.options.length > 0) {
                        // ì˜µì…˜ ê¸°ë°˜ ì…ë ¥ ëª¨ë“œë¡œ ì „í™˜
                        currentProductOptions = optData.options;
                        currentProductInfo = allRegisteredProducts.find(p => p.productNumber === productNumber) || { productNumber: productNumber, productName: r.productName || '' };
                        var pageTitleEl = document.getElementById('pageTitle');
                        if (pageTitleEl) pageTitleEl.textContent = 'íŒë§¤ ë°ì´í„° ì…ë ¥ - ' + (currentProductInfo.productName || currentProductInfo.productNumber || '');
                        document.documentElement.classList.remove('url-product-view');
                        document.getElementById('productNumberField').style.display = 'none';
                        document.getElementById('optionTabsSection').style.display = 'block';
                        document.getElementById('optionFieldsSection').style.display = 'block';
                        document.getElementById('legacyFields').style.display = 'none';
                        var dateNum = document.querySelector('[data-field="date"] .field-number');
                        if (dateNum) dateNum.textContent = '1';
                        if (allRegisteredProducts.length > 1) {
                            document.getElementById('nextProductButton').style.display = 'block';
                            currentProductIndex = allRegisteredProducts.findIndex(p => p.productNumber === productNumber);
                        }
                        
                        // ë‚ ì§œ ì„¤ì •
                        if (saleDate) {
                            formData.date = saleDate;
                            const dateInput = document.getElementById('field-date');
                            if (dateInput) {
                                dateInput.value = saleDate;
                                if (dateInput._flatpickr) {
                                    const dateMatch = saleDate.match(/(\d{4})\s*ë…„\s*(\d{1,2})\s*ì›”\s*(\d{1,2})\s*ì¼/);
                                    if (dateMatch) {
                                        const y = parseInt(dateMatch[1], 10);
                                        const m = parseInt(dateMatch[2], 10) - 1;
                                        const d = parseInt(dateMatch[3], 10);
                                        const dateObj = new Date(y, m, d);
                                        dateInput._flatpickr.setDate(dateObj, false);
                                    } else if (/^\d{4}-\d{2}-\d{2}/.test(saleDate)) {
                                        const dateObj = new Date(saleDate);
                                        dateInput._flatpickr.setDate(dateObj, false);
                                    }
                                }
                            }
                        }
                        
                        // ê°™ì€ ë‚ ì§œì˜ ëª¨ë“  ì˜µì…˜ ë°ì´í„° ë¡œë“œ
                        const allRecordsForDate = data.allRecordsForDate || [];
                        optionDataSets = [];
                        // ìˆ˜ì • ì‹œì—ë„ ê¸°ì¡´ ê¸°ë¡ ì—†ëŠ” ì˜µì…˜ì—ëŠ” ì´ì „ íŒë§¤ê°€ ë³€ë™ ìë™ ì„¤ì •ìš©
                        lastPriceFluctuationForProduct = null;
                        try {
                            const latestRes = await fetch('/api/margin-tracker/latest-record?userId=' + encodeURIComponent(uid) + '&productNumber=' + encodeURIComponent(productNumber));
                            const latestData = await latestRes.json();
                            if (latestData.success && latestData.priceFluctuation != null && latestData.priceFluctuation !== '') {
                                lastPriceFluctuationForProduct = latestData.priceFluctuation;
                            }
                        } catch (e) { /* ë¬´ì‹œ */ }

                        // ê° ì˜µì…˜ì— ëŒ€í•´ ë°ì´í„° ë§¤ì¹­
                        currentProductOptions.forEach(function(opt, idx) {
                            const existingRecord = allRecordsForDate.find(function(rec) {
                                // ì˜µì…˜ IDë‚˜ ë³„ì¹­ì´ ì¼ì¹˜í•˜ëŠ” ê²½ìš°
                                if (opt.optionId && rec.optionId && opt.optionId === rec.optionId) return true;
                                if (opt.optionAlias && rec.optionAlias && opt.optionAlias === rec.optionAlias) return true;
                                // ì˜µì…˜ì´ ì—†ëŠ” ê²½ìš° ì²« ë²ˆì§¸ ì˜µì…˜ì— ë§¤ì¹­
                                if (!opt.optionId && !opt.optionAlias && !rec.optionId && !rec.optionAlias && idx === 0) return true;
                                return false;
                            });
                            
                            if (existingRecord) {
                                const sellingPrice = parseFloat(existingRecord.sellingPrice) || opt.sellingPrice || 0;
                                const priceFluctuation = parseFloat(existingRecord.priceFluctuation) || 0;
                                const finalPrice = sellingPrice + priceFluctuation;
                                const salesQty = parseFloat(existingRecord.salesQuantity) || 0;
                                const adCost = parseFloat(existingRecord.advertisingCost) || 0;
                                const adSalesQty = parseFloat(existingRecord.adSales) || 0;
                                const organicSalesQty = Math.max(0, salesQty - adSalesQty);
                                const actualRevenue = finalPrice * salesQty;
                                // ìˆœì´ìµ ê³„ì‚°: (ê°œë‹¹ ë§ˆì§„ * íŒë§¤ ìˆ˜ëŸ‰) + (íŒë§¤ê°€ ë³€ë™ * íŒë§¤ ìˆ˜ëŸ‰) - ê´‘ê³ ë¹„
                                // = (ê°œë‹¹ ë§ˆì§„ + íŒë§¤ê°€ ë³€ë™) * íŒë§¤ ìˆ˜ëŸ‰ - ê´‘ê³ ë¹„
                                // ìƒí’ˆ ë“±ë¡ ì‹œ ì €ì¥ëœ ê°œë‹¹ ë§ˆì§„ ì‚¬ìš© (ë°˜ë“œì‹œ DBì—ì„œ ê°€ì ¸ì˜¨ ê°’ ì‚¬ìš©)
                                let baseMarginPerUnit = 0;
                                if (opt.marginPerUnit != null && opt.marginPerUnit !== undefined && opt.marginPerUnit !== '') {
                                    baseMarginPerUnit = parseFloat(String(opt.marginPerUnit).replace(/,/g, '')) || 0;
                                }
                                const marginFromBase = baseMarginPerUnit * salesQty;  // ê°œë‹¹ ë§ˆì§„ * íŒë§¤ ìˆ˜ëŸ‰
                                const marginFromFluctuation = priceFluctuation * salesQty;  // íŒë§¤ê°€ ë³€ë™ * íŒë§¤ ìˆ˜ëŸ‰
                                const netProfit = marginFromBase + marginFromFluctuation - adCost;
                                const roas = adCost > 0 ? actualRevenue / adCost : 0;
                                // ë§ˆì§„ìœ¨ ê³„ì‚°
                                const adjustedMarginPerUnit = baseMarginPerUnit + priceFluctuation;
                                let marginRate = parseFloat(existingRecord.marginRate) || 0;
                                if (marginRate <= 0) {
                                    if (adjustedMarginPerUnit > 0 && finalPrice > 0) {
                                        marginRate = (adjustedMarginPerUnit / finalPrice) * 100;
                                    } else if (actualRevenue > 0) {
                                        marginRate = (netProfit / actualRevenue) * 100;
                                    }
                                }
                                
                                optionDataSets[idx] = {
                                    sellingPrice: sellingPrice,
                                    priceFluctuation: priceFluctuation,
                                    finalSellingPrice: finalPrice,
                                    salesQuantity: salesQty,
                                    actualSalesRevenue: actualRevenue,
                                    advertisingCost: adCost,
                                    adSales: adSalesQty,
                                    organicSales: organicSalesQty,
                                    netProfit: netProfit,
                                    marginRate: marginRate,
                                    roas: roas,
                                    dataSeq: existingRecord.id
                                };
                            } else {
                                var prevPriceFluctuation = (lastPriceFluctuationForProduct != null && lastPriceFluctuationForProduct !== '') ? String(lastPriceFluctuationForProduct) : '';
                                optionDataSets[idx] = {
                                    sellingPrice: opt.sellingPrice || 0,
                                    priceFluctuation: prevPriceFluctuation,
                                    finalSellingPrice: opt.sellingPrice || 0,
                                    salesQuantity: '',
                                    advertisingCost: '',
                                    adSales: '',
                                    organicSales: 0,
                                    netProfit: 0,
                                    marginRate: 0,
                                    roas: 0,
                                    dataSeq: null
                                };
                            }
                        });
                        
                        // ì²« ë²ˆì§¸ ì˜µì…˜ í‘œì‹œ
                        currentOptionIndex = 0;
                        renderOptionTabs();
                        renderOptionFields(0);
                        
                        // ìˆ˜ì • ëª¨ë“œì¸ ê²½ìš° ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½ ë° í™œì„±í™” ìƒíƒœ í™•ì¸
                        updateSaveButtonText();
                        checkCanSave();
                        
                        if (updateNextProductButtonFn) {
                            updateNextProductButtonFn();
                        }
                        return;
                    }
                }
                
                // ì˜µì…˜ì´ ì—†ê±°ë‚˜ ë ˆê±°ì‹œ ëª¨ë“œì¸ ê²½ìš°
                function val(v) { return v != null && v !== '' ? String(v) : ''; }
                const productLabel = (r.productNumber && r.productName) ? (r.productNumber + ' / ' + r.productName) : (r.productNumber || r.productName || '');
                formData.productNumber = productLabel;
                const productInput = document.getElementById('field-productNumber');
                if (productInput) productInput.value = productLabel;

                if (r.date) {
                    formData.date = val(r.date);
                    const dateInput = document.getElementById('field-date');
                    if (dateInput) dateInput.value = formData.date;
                }

                ['sellingPrice','discountCoupon','priceFluctuation','salesQuantity','marginPerUnit','advertisingCost','adSales','organicSales'].forEach(function(k) {
                    const v = val(r[k]);
                    if (v) {
                        formData[k] = v;
                        const el = document.getElementById('field-' + k);
                        if (el) el.value = v;
                    }
                });

                calculateDerivedFields();

                ['finalSellingPrice','actualSalesRevenue','totalMargin','netProfit','marginRate','organicSalesRatio','roas'].forEach(function(k) {
                    const v = r[k];
                    if (v != null && v !== '') {
                        formData[k] = String(v);
                        const valueEl = document.getElementById('value-' + k);
                        if (valueEl) {
                            const n = parseFloat(v);
                            if (k === 'marginRate' || k === 'organicSalesRatio') valueEl.textContent = isNaN(n) ? '-' : n.toFixed(1) + '%';
                            else if (k === 'roas') valueEl.textContent = isNaN(n) ? '-' : n.toFixed(2);
                            else valueEl.textContent = isNaN(n) ? '-' : Math.round(n).toLocaleString('ko-KR');
                        }
                    }
                });

                fields.forEach(function(f, i) { updateFieldState(i); });
                checkCanProceed(0);
            } catch (e) {
                console.error('ìˆ˜ì • ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜', e);
            }
        }

        // Event Listeners
        function initEventListeners() {
            // Back Button
            document.getElementById('backButton').addEventListener('click', function(e) {
                if (hasUnsavedChanges()) {
                    if (!confirm('ì…ë ¥ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì…ë ¥í•œ ë‚´ìš©ì´ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')) {
                        e.preventDefault();
                        return;
                    }
                }
                window.location.href = '/margin-tracker';
            });

            const productInput = document.getElementById('field-productNumber');
            if (productInput) {
                productInput.addEventListener('change', function() {
                    const val = this.value.trim();
                    if (val && val.indexOf(' / ') !== -1) {
                        const parts = val.split(' / ');
                        const productNumber = parts[0].trim();
                        handleProductSelect(productNumber, null);
                    }
                });
            }

            // Input Fields
            fields.forEach((field, index) => {
                const fieldElement = document.querySelector(`[data-field="${field}"]`);
                const inputElement = document.getElementById(`field-${field}`);
                const valueElement = document.getElementById(`value-${field}`);
                const isCalculated = calculatedFields.includes(field);

                if (fieldElement) {
                    // Click to focus
                    fieldElement.addEventListener('click', () => {
                        if (index <= currentStep) {
                            setCurrentStep(index);
                            if (isCalculated && valueElement && inputElement) {
                                // ê³„ì‚°ëœ í•„ë“œ: í´ë¦­í•˜ë©´ ì…ë ¥ ëª¨ë“œë¡œ ì „í™˜
                                if (valueElement.classList.contains('hidden')) {
                                    // ì´ë¯¸ ì…ë ¥ ëª¨ë“œ
                                    inputElement.focus();
                                } else {
                                    // í‘œì‹œ ëª¨ë“œ -> ì…ë ¥ ëª¨ë“œë¡œ ì „í™˜
                                    const currentValue = valueElement.textContent;
                                    if (currentValue && currentValue !== '-') {
                                        // ìˆ«ìë§Œ ì¶”ì¶œ (ì½¤ë§ˆ, % ë“± ì œê±°)
                                        const numValue = currentValue.replace(/[^0-9.-]/g, '');
                                        inputElement.value = numValue;
                                    }
                                    valueElement.classList.add('hidden');
                                    inputElement.classList.add('active');
                                    inputElement.style.display = 'block';
                                    setTimeout(() => inputElement.focus(), 50);
                                }
                            } else if (inputElement) {
                                // ì¼ë°˜ ì…ë ¥ í•„ë“œ
                                inputElement.focus();
                            }
                        }
                    });

                    if (inputElement) {
                        // Input events (ê°’ë§Œ ë°˜ì˜, ìë™ ì´ë™ ì—†ìŒ)
                        inputElement.addEventListener('input', (e) => {
                            formData[field] = e.target.value;
                            if (!isCalculated) {
                                calculateDerivedFields();
                            }
                            updateFieldState(index);
                            checkCanProceed(index);
                        });

                        // Blur event for calculated fields
                        if (isCalculated) {
                            inputElement.addEventListener('blur', () => {
                                // ì…ë ¥ ëª¨ë“œ -> í‘œì‹œ ëª¨ë“œë¡œ ì „í™˜
                                if (inputElement.value) {
                                    formData[field] = inputElement.value;
                                    updateCalculatedFieldDisplay(field, parseFloat(inputElement.value));
                                } else {
                                    calculateDerivedFields();
                                }
                                valueElement.classList.remove('hidden');
                                inputElement.classList.remove('active');
                                inputElement.style.display = 'none';
                            });
                        }

                        inputElement.addEventListener('keydown', (e) => {
                            // ê³„ì‚°ëœ í•„ë“œëŠ” ì—”í„°ë¡œ ë„˜ì–´ê°€ì§€ ì•ŠìŒ
                            if (isCalculated && e.key === 'Enter') {
                                e.preventDefault();
                                inputElement.blur();
                                return;
                            }

                            // ë‚ ì§œ í•„ë“œëŠ” ì—”í„°ë¡œ ë‚ ì§œ ì„ íƒê¸° ì—´ê¸°
                            if (field === 'date' && e.key === 'Enter') {
                                e.preventDefault();
                                openDatePicker();
                                return;
                            }

                            if (e.key === 'Enter') {
                                e.preventDefault();
                                // ì—”í„° í‚¤ë¡œ ë‹¤ìŒ í•„ë“œë¡œ ì´ë™
                                moveToNextInputField(index);
                            }
                            // Tab key also moves to next field
                            if (e.key === 'Tab' && !e.shiftKey) {
                                e.preventDefault();
                                moveToNextInputField(index);
                            }
                        });
                    }
                }
            });

            // Save Button
            document.getElementById('saveButton').addEventListener('click', function() {
                saveData();
            });

            // Next Product Button
            const nextProductBtn = document.getElementById('nextProductButton');
            if (nextProductBtn) {
                updateNextProductButtonFn = function() {
                    if (allRegisteredProducts.length === 0 || !currentProductInfo) {
                        nextProductBtn.style.display = 'none';
                        return;
                    }
                    const currentIdx = allRegisteredProducts.findIndex(p => p.productNumber === currentProductInfo.productNumber);
                    if (currentIdx === -1 || currentIdx === allRegisteredProducts.length - 1) {
                        nextProductBtn.style.display = 'none';
                        return;
                    }
                    const next = allRegisteredProducts[currentIdx + 1];
                    if (next) {
                        nextProductBtn.textContent = 'ë‹¤ìŒìƒí’ˆ(' + (next.productName || next.productNumber) + ')';
                        nextProductBtn.style.display = 'block';
                    } else {
                        nextProductBtn.style.display = 'none';
                    }
                };
                nextProductBtn.addEventListener('click', async function() {
                    if (allRegisteredProducts.length === 0 || !currentProductInfo) return;
                    const currentIdx = allRegisteredProducts.findIndex(p => p.productNumber === currentProductInfo.productNumber);
                    if (currentIdx === -1 || currentIdx === allRegisteredProducts.length - 1) return;
                    const next = allRegisteredProducts[currentIdx + 1];
                    if (next) {
                        // ë‹¤ìŒ ìƒí’ˆ URL ìƒì„±
                        const dateInput = document.getElementById('field-date');
                        const dateStr = dateInput && dateInput.value ? dateInput.value : null;
                        const nextUrl = '/margin-tracker/input?product=' + encodeURIComponent(next.productNumber) + (dateStr ? '&date=' + encodeURIComponent(dateStr) : '');
                        // í˜„ì¬ ë°ì´í„° ì €ì¥ í›„ ë‹¤ìŒ ìƒí’ˆìœ¼ë¡œ ì´ë™
                        await saveData(nextUrl);
                    }
                });
                updateNextProductButtonFn();
            }

            // Back to Tracker Button
            const backToTrackerBtn = document.getElementById('backToTrackerButton');
            if (backToTrackerBtn) {
                backToTrackerBtn.addEventListener('click', function() {
                    if (hasUnsavedChanges()) {
                        if (!confirm('ì…ë ¥ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì…ë ¥í•œ ë‚´ìš©ì´ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')) {
                            return;
                        }
                    }
                    window.location.href = '/margin-tracker';
                });
            }

            // ë‚ ì§œ í•„ë“œ: í´ë¦­ + í„°ì¹˜ ëª¨ë‘ì—ì„œ ë‹¬ë ¥ ì—´ê¸° (ëª¨ë°”ì¼ì—ì„œ í„°ì¹˜ í•„ìˆ˜)
            function bindDateFieldOpen() {
                const dateInput = document.getElementById('field-date');
                const dateFieldContainer = document.querySelector('.date-field-container');
                if (!dateInput) return;

                function openAndMaybePrevent(e) {
                    setCurrentStep(1);
                    openDatePicker();
                    e.preventDefault();
                    e.stopPropagation();
                }

                [dateInput, dateFieldContainer].filter(Boolean).forEach(function(el) {
                    el.addEventListener('click', function(e) {
                        openAndMaybePrevent(e);
                    }, true);
                    el.addEventListener('touchend', function(e) {
                        openAndMaybePrevent(e);
                    }, { passive: false, capture: true });
                });
            }
            bindDateFieldOpen();
        }

        // ë‹¤ìŒ ì…ë ¥ í•„ë“œë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
        function moveToNextInputField(currentIndex) {
            if (currentIndex < fields.length - 1) {
                let nextIndex = currentIndex + 1;
                while (nextIndex < fields.length) {
                    const nextField = fields[nextIndex];
                    const nextInput = document.getElementById(`field-${nextField}`);
                    if (nextInput && !nextInput.readOnly && !calculatedFields.includes(nextField)) {
                        setCurrentStep(nextIndex);
                        setTimeout(() => {
                            nextInput.focus();
                            // í•„ë“œ ì»¨í…Œì´ë„ˆ ì°¾ê¸°
                            const fieldElement = document.querySelector(`[data-field="${nextField}"]`);
                            if (fieldElement) {
                                // í•„ë“œ ì»¨í…Œì´ë„ˆë¡œ ìŠ¤í¬ë¡¤
                                fieldElement.scrollIntoView({ 
                                    behavior: 'smooth', 
                                    block: 'center',
                                    inline: 'nearest'
                                });
                            } else {
                                // í•„ë“œ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìœ¼ë©´ ì…ë ¥ í•„ë“œë¡œ ìŠ¤í¬ë¡¤
                                nextInput.scrollIntoView({ 
                                    behavior: 'smooth', 
                                    block: 'center',
                                    inline: 'nearest'
                                });
                            }
                        }, 150);
                        break;
                    }
                    nextIndex++;
                }
            }
        }

        // Date Picker
        let datePickerInstance = null;
        
        function openDatePicker() {
            const dateInput = document.getElementById('field-date');
            if (!dateInput) {
                return;
            }

            // ë‚ ì§œ ì„ íƒê¸°ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
            if (!dateInput._flatpickr && !datePickerInstance) {
                initDatePicker();
            }
            
            // clickOpensë¥¼ trueë¡œ ë³€ê²½í•˜ì—¬ í´ë¦­ ì‹œ ì—´ë¦¬ë„ë¡
            try {
                if (dateInput._flatpickr && dateInput._flatpickr.config) {
                    dateInput._flatpickr.config.clickOpens = true;
                }
            } catch (e) {
                console.log('Error setting clickOpens on _flatpickr:', e);
            }
            
            try {
                if (datePickerInstance && datePickerInstance.config) {
                    datePickerInstance.config.clickOpens = true;
                }
            } catch (e) {
                console.log('Error setting clickOpens on datePickerInstance:', e);
            }

            // ë‚ ì§œ ì„ íƒê¸° ì—´ê¸°
            setTimeout(() => {
                let fpInstance = null;
                if (dateInput._flatpickr) {
                    fpInstance = dateInput._flatpickr;
                } else if (datePickerInstance) {
                    fpInstance = datePickerInstance;
                } else {
                    initDatePicker();
                    setTimeout(() => {
                        const retryInput = document.getElementById('field-date');
                        if (retryInput && retryInput._flatpickr) {
                            fpInstance = retryInput._flatpickr;
                        } else {
                            return;
                        }
                    }, 200);
                }
                
                if (fpInstance) {
                    var calendar = fpInstance.calendarContainer;
                    if (calendar) {
                        calendar.style.zIndex = '3000';
                        calendar.style.display = '';
                        calendar.style.visibility = '';
                        calendar.style.opacity = '';
                    }
                    fpInstance.open();
                }
            }, 50);
        }
        
        function initDatePicker() {
            const dateInput = document.getElementById('field-date');
            if (!dateInput) {
                return;
            }

            // ì´ë¯¸ ì´ˆê¸°í™”ë˜ì–´ ìˆìœ¼ë©´ ì œê±° í›„ ì¬ì´ˆê¸°í™”
            if (dateInput._flatpickr) {
                try {
                    if (dateInput._flatpickr.destroy && typeof dateInput._flatpickr.destroy === 'function') {
                        dateInput._flatpickr.destroy();
                    }
                } catch (e) {
                    console.log('Error destroying flatpickr:', e);
                }
                dateInput._flatpickr = null;
            }
            
            if (datePickerInstance) {
                try {
                    if (datePickerInstance.destroy && typeof datePickerInstance.destroy === 'function') {
                        datePickerInstance.destroy();
                    }
                } catch (e) {
                    console.log('Error destroying datePickerInstance:', e);
                }
                datePickerInstance = null;
            }

            // flatpickrì´ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (typeof flatpickr === 'undefined') {
                console.error('Flatpickr library is not loaded');
                return false;
            }

            try {
                // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ê¸°ë³¸ê°’ ì„¤ì •
                const today = new Date();
                const todayStr = today.getFullYear() + 'ë…„ ' + (today.getMonth() + 1) + 'ì›” ' + today.getDate() + 'ì¼';
                
                // ê°’ì´ ì—†ì„ ë•Œë§Œ ì„¤ì •
                if (!dateInput.value || dateInput.value === '') {
                    dateInput.value = todayStr;
                    formData.date = todayStr;
                }

                datePickerInstance = flatpickr(dateInput, {
                    locale: "ko",
                    dateFormat: "Yë…„ mì›” dì¼",
                    defaultDate: today,
                    clickOpens: true,
                    allowInput: false,
                    inline: false,
                    static: false,
                    appendTo: document.body,
                    disableMobile: false,
                    positionElement: dateInput,
                    openOnReady: false,
                    onReady: function(selectedDates, dateStr, instance) {
                        var input = instance.input;
                        if (input) {
                            input.setAttribute('readonly', 'readonly');
                        }
                        if (instance.isOpen) {
                            instance.close();
                        }
                    },
                    onChange: function(selectedDates, dateStr, instance) {
                        formData.date = dateStr;
                        calculateDerivedFields();
                        updateFieldState(1);
                        checkCanProceed(1);
                        
                        // ë‚ ì§œ ì„ íƒ ì‹œ ë‹¬ë ¥ ê°•ì œë¡œ ë‹«ê¸°
                        setTimeout(() => {
                            if (instance && instance.isOpen) {
                                instance.close();
                            }
                        }, 50);
                        
                        // ë‚ ì§œ ì„ íƒ ì™„ë£Œ ì‹œ ì¦‰ì‹œ ë‹¤ìŒ í•„ë“œë¡œ ì´ë™ (date=index 1 -> sellingPrice=index 2)
                        setCurrentStep(2);
                        setTimeout(() => {
                            const nextInput = document.getElementById('field-sellingPrice');
                            if (nextInput) {
                                const fieldElement = document.querySelector('[data-field="sellingPrice"]');
                                if (fieldElement) {
                                    fieldElement.scrollIntoView({ 
                                        behavior: 'smooth', 
                                        block: 'center',
                                        inline: 'nearest'
                                    });
                                }
                                setTimeout(() => {
                                    nextInput.focus();
                                }, 100);
                            }
                        }, 300);
                    }
                });

                return true;
            } catch (error) {
                console.error('Error initializing date picker:', error);
                return false;
            }
        }

        // Step Management
        function setCurrentStep(step) {
            currentStep = step;
            
            // Update field states
            fields.forEach((field, index) => {
                const fieldElement = document.querySelector(`[data-field="${field}"]`);
                if (fieldElement) {
                    fieldElement.classList.remove('active', 'completed');
                    if (index === step) {
                        fieldElement.classList.add('active');
                    } else if (index < step) {
                        fieldElement.classList.add('completed');
                    }
                }
            });

            // Update progress
            const progress = ((step + 1) / fields.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressInfo').textContent = `${step + 1}/${fields.length}`;
        }

        function updateFieldState(index) {
            const field = fields[index];
            const fieldElement = document.querySelector(`[data-field="${field}"]`);
            const value = formData[field];

            if (fieldElement && value && value !== '') {
                fieldElement.classList.add('completed');
            }
        }

        function checkCanProceed(step) {
            const field = fields[step];
            const value = formData[field];

            // Check if all required fields are filled
            const allFilled = fields.every(f => {
                if (calculatedFields.includes(f)) {
                    return true; // Calculated fields are optional
                }
                return formData[f] && formData[f] !== '';
            });

            const saveButton = document.getElementById('saveButton');
            if (saveButton) {
                saveButton.disabled = !allFilled;
                saveButton.style.opacity = allFilled ? '1' : '0.5';
                saveButton.style.cursor = allFilled ? 'pointer' : 'not-allowed';
            }
        }

        // Calculations
        function calculateDerivedFields() {
            const sellingPrice = parseFloat(formData.sellingPrice) || 0;
            const discountCoupon = parseFloat(formData.discountCoupon) || 0;
            const priceFluctuation = parseFloat(formData.priceFluctuation) || 0;
            const salesQuantity = parseFloat(formData.salesQuantity) || 0;
            const marginPerUnit = parseFloat(formData.marginPerUnit) || 0;
            const advertisingCost = parseFloat(formData.advertisingCost) || 0;
            const adSales = parseFloat(formData.adSales) || 0;
            const organicSales = parseFloat(formData.organicSales) || 0;

            // ìµœì¢… íŒë§¤ê°€ = íŒë§¤ê°€ - í• ì¸ì¿ í°
            const finalSellingPrice = sellingPrice - discountCoupon;
            formData.finalSellingPrice = finalSellingPrice > 0 ? finalSellingPrice : '';
            updateCalculatedField('finalSellingPrice', finalSellingPrice);

            // ì‹¤ì œ íŒë§¤ ë§¤ì¶œ = ìµœì¢… íŒë§¤ê°€ * íŒë§¤ìˆ˜ëŸ‰
            const actualSalesRevenue = finalSellingPrice * salesQuantity;
            formData.actualSalesRevenue = actualSalesRevenue > 0 ? actualSalesRevenue : '';
            updateCalculatedField('actualSalesRevenue', actualSalesRevenue);

            // ìˆœì´ìµ ê³„ì‚°: (ê°œë‹¹ ë§ˆì§„ * íŒë§¤ ìˆ˜ëŸ‰) + (íŒë§¤ê°€ ë³€ë™ * íŒë§¤ ìˆ˜ëŸ‰) - ê´‘ê³ ë¹„
            // = (ê°œë‹¹ ë§ˆì§„ + íŒë§¤ê°€ ë³€ë™) * íŒë§¤ ìˆ˜ëŸ‰ - ê´‘ê³ ë¹„
            const marginFromBase = marginPerUnit * salesQuantity;  // ê°œë‹¹ ë§ˆì§„ * íŒë§¤ ìˆ˜ëŸ‰
            const marginFromFluctuation = priceFluctuation * salesQuantity;  // íŒë§¤ê°€ ë³€ë™ * íŒë§¤ ìˆ˜ëŸ‰
            const totalMargin = marginFromBase + marginFromFluctuation;
            formData.totalMargin = totalMargin !== 0 ? totalMargin : '';
            updateCalculatedField('totalMargin', totalMargin);

            // ê´‘ê³ ë¹„ (1.1ë°°)
            const adjustedAdvertisingCost = advertisingCost * 1.1;
            formData.advertisingCostAdjusted = adjustedAdvertisingCost;

            // ìˆœìˆ˜ìµ = (ê°œë‹¹ ë§ˆì§„ * íŒë§¤ ìˆ˜ëŸ‰) + (íŒë§¤ê°€ ë³€ë™ * íŒë§¤ ìˆ˜ëŸ‰) - ê´‘ê³ ë¹„(1.1ë°°)
            const netProfit = totalMargin - adjustedAdvertisingCost;
            formData.netProfit = netProfit !== 0 ? netProfit : '';
            updateCalculatedField('netProfit', netProfit);

            // ë§ˆì§„ìœ¨ = (ì¡°ì •ëœ ê°œë‹¹ ë§ˆì§„ / ìµœì¢… íŒë§¤ê°€) * 100
            const adjustedMarginPerUnit = marginPerUnit + priceFluctuation;
            const marginRate = finalSellingPrice > 0 ? (adjustedMarginPerUnit / finalSellingPrice) * 100 : 0;
            formData.marginRate = marginRate !== 0 ? marginRate : '';
            updateCalculatedField('marginRate', marginRate);

            // ìì—°íŒë§¤ë¹„ìœ¨ = (ìì—°íŒë§¤ / íŒë§¤ìˆ˜ëŸ‰) * 100
            const organicSalesRatio = salesQuantity > 0 ? (organicSales / salesQuantity) * 100 : 0;
            formData.organicSalesRatio = organicSalesRatio !== 0 ? organicSalesRatio : '';
            updateCalculatedField('organicSalesRatio', organicSalesRatio);

            // ROAS = ì‹¤ì œ íŒë§¤ ë§¤ì¶œ / ê´‘ê³ ë¹„ (ê´‘ê³ ë¹„ê°€ 0ë³´ë‹¤ í´ ë•Œ)
            const roas = advertisingCost > 0 ? actualSalesRevenue / advertisingCost : 0;
            formData.roas = roas !== 0 ? roas : '';
            updateCalculatedField('roas', roas);
        }

        function updateCalculatedField(field, value) {
            const valueElement = document.getElementById(`value-${field}`);
            const inputElement = document.getElementById(`field-${field}`);
            
            if (valueElement) {
                // ì…ë ¥ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ì—…ë°ì´íŠ¸
                if (!valueElement.classList.contains('hidden')) {
                    if (value === 0 || isNaN(value) || !isFinite(value)) {
                        valueElement.textContent = '-';
                    } else {
                        if (field === 'marginRate' || field === 'organicSalesRatio') {
                            valueElement.textContent = value.toFixed(1) + '%';
                        } else if (field === 'roas') {
                            valueElement.textContent = value.toFixed(2);
                        } else {
                            valueElement.textContent = Math.round(value).toLocaleString('ko-KR');
                        }
                    }
                }
            }
            
            // ì…ë ¥ í•„ë“œì—ë„ ê°’ ì €ì¥ (ìˆ˜ë™ ì…ë ¥ ì‹œ)
            if (inputElement && formData[field] === '') {
                formData[field] = value.toString();
            }
        }

        function updateCalculatedFieldDisplay(field, value) {
            const valueElement = document.getElementById(`value-${field}`);
            if (valueElement) {
                if (value === 0 || isNaN(value) || !isFinite(value)) {
                    valueElement.textContent = '-';
                } else {
                    if (field === 'marginRate' || field === 'organicSalesRatio') {
                        valueElement.textContent = value.toFixed(1) + '%';
                    } else if (field === 'roas') {
                        valueElement.textContent = value.toFixed(2);
                    } else {
                        valueElement.textContent = Math.round(value).toLocaleString('ko-KR');
                    }
                }
            }
        }

        function hasUnsavedChanges() {
            return fields.some(f => formData[f] && formData[f] !== '');
        }

        function resetForm() {
            currentStep = 0;
            formData = {};
            
            // flatpickr ì¸ìŠ¤í„´ìŠ¤ ì •ë¦¬
            const dateInput = document.getElementById('field-date');
            if (dateInput && dateInput._flatpickr) {
                try {
                    if (dateInput._flatpickr.destroy && typeof dateInput._flatpickr.destroy === 'function') {
                        if (dateInput._flatpickr.calendarContainer) {
                            dateInput._flatpickr.destroy();
                        }
                    }
                } catch (e) {
                    console.log('Error destroying flatpickr in resetForm:', e);
                }
                dateInput._flatpickr = null;
            }
            
            if (datePickerInstance) {
                try {
                    if (datePickerInstance.destroy && typeof datePickerInstance.destroy === 'function') {
                        if (datePickerInstance.calendarContainer) {
                            datePickerInstance.destroy();
                        }
                    }
                } catch (e) {
                    console.log('Error destroying datePickerInstance in resetForm:', e);
                }
                datePickerInstance = null;
            }
            
            fields.forEach(field => {
                formData[field] = '';
                const input = document.getElementById(`field-${field}`);
                if (input) {
                    input.value = '';
                    input.style.display = '';
                    input.classList.remove('active');
                }
                const value = document.getElementById(`value-${field}`);
                if (value) {
                    value.textContent = '-';
                    value.classList.remove('hidden');
                }
            });
            setCurrentStep(0);
        }

        // Save Data (API)
        async function saveData(redirectUrl) {
            const userId = localStorage.getItem('salesChart_userId');
            if (!userId) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/margin-tracker';
                return;
            }
            if (currentProductOptions.length > 0 && optionDataSets.length > 0) {
                let dateStr = formData.date || document.getElementById('field-date').value;
                if (!dateStr) {
                    alert('ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                if (dateStr.indexOf('ë…„') !== -1) {
                    const match = dateStr.match(/(\d+)ë…„\s*(\d+)ì›”\s*(\d+)ì¼/);
                    if (match) {
                        const y = match[1];
                        const m = String(match[2]).padStart(2, '0');
                        const d = String(match[3]).padStart(2, '0');
                        dateStr = y + 'ë…„ ' + parseInt(m, 10) + 'ì›” ' + parseInt(d, 10) + 'ì¼';
                    }
                }
                let successCount = 0;
                for (let i = 0; i < currentProductOptions.length; i++) {
                    const opt = currentProductOptions[i];
                    const data = optionDataSets[i];
                    if (!data || !data.salesQuantity || data.salesQuantity <= 0) continue;
                    const payload = {
                        userId: userId,
                        productNumber: currentProductInfo.productNumber || null,
                        productName: currentProductInfo.productName || null,
                        optionId: opt.optionId || null,
                        optionAlias: opt.optionAlias || null,
                        date: dateStr,
                        sellingPrice: data.sellingPrice || null,
                        priceFluctuation: data.priceFluctuation || null,
                        finalSellingPrice: data.finalSellingPrice || null,
                        salesQuantity: data.salesQuantity || null,
                        actualSalesRevenue: data.actualSalesRevenue || null,
                        advertisingCost: data.advertisingCost || null,
                        adSales: data.adSales || null,
                        organicSales: data.organicSales || null,
                        netProfit: data.netProfit || null,
                        marginRate: data.marginRate || null,
                        roas: data.roas || null
                    };
                    // ìˆ˜ì • ëª¨ë“œì¸ ê²½ìš° dataSeq ì¶”ê°€
                    if (data.dataSeq) {
                        payload.dataSeq = data.dataSeq;
                    }
                    try {
                        const res = await fetch('/api/margin-tracker/save', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const result = await res.json();
                        if (result.success) successCount++;
                    } catch (e) {
                        console.error('ì˜µì…˜ ì €ì¥ ì‹¤íŒ¨', i, e);
                    }
                }
                if (successCount > 0) {
                    if (redirectUrl) {
                        window.location.href = redirectUrl;
                    } else {
                        alert(successCount + 'ê°œ ì˜µì…˜ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        window.location.href = '/margin-tracker';
                    }
                } else {
                    alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } else {
                let pn = (formData.productNumber || '').trim();
                let pname = '';
                if (pn.indexOf(' / ') !== -1) {
                    const parts = pn.split(' / ');
                    pn = parts[0].trim();
                    pname = parts.slice(1).join(' / ').trim();
                }
                const payload = {
                    userId: userId,
                    productNumber: pn || null,
                    productName: pname || null,
                    date: formData.date || null,
                    sellingPrice: formData.sellingPrice || null,
                    discountCoupon: formData.discountCoupon || null,
                    finalSellingPrice: formData.finalSellingPrice || null,
                    priceFluctuation: formData.priceFluctuation || null,
                    salesQuantity: formData.salesQuantity || null,
                    actualSalesRevenue: formData.actualSalesRevenue || null,
                    marginPerUnit: formData.marginPerUnit || null,
                    totalMargin: formData.totalMargin || null,
                    advertisingCost: formData.advertisingCost || null,
                    netProfit: formData.netProfit || null,
                    marginRate: formData.marginRate || null,
                    adSales: formData.adSales || null,
                    organicSales: formData.organicSales || null,
                    organicSalesRatio: formData.organicSalesRatio || null,
                    roas: formData.roas || null
                };
                if (editId) payload.dataSeq = parseInt(editId, 10);
                try {
                    const res = await fetch('/api/margin-tracker/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await res.json();
                    if (result.success) {
                        if (redirectUrl) {
                            window.location.href = redirectUrl;
                        } else {
                            window.location.href = '/margin-tracker';
                        }
                    } else {
                        alert(result.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                } catch (e) {
                    console.error(e);
                    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }
    </script>
</body>
</html>
